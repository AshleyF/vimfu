<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>VimFu Simulator</title>
<style>*{margin:0;padding:0;box-sizing:border-box}body{background:#1a1a2e;color:#d4d4d4;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:2rem}h1{font-size:1.6rem;margin-bottom:0.5rem;color:#82aaff}.mode-badge{display:inline-block;padding:2px 10px;border-radius:4px;font-family:'Cascadia Mono',Consolas,monospace;font-size:0.85rem;font-weight:700;margin-bottom:1rem;transition:background 0.15s,color 0.15s}.mode-badge.shell{background:#89ddff;color:#000}.mode-badge.normal{background:#82aaff;color:#000}.mode-badge.insert{background:#c3e88d;color:#000}.mode-badge.visual,.mode-badge.visual_line{background:#c792ea;color:#000}.mode-badge.replace{background:#f78c6c;color:#000}.mode-badge.command{background:#3c3c3c;color:#d4d4d4}.terminal-wrapper{position:relative;border:2px solid #333;border-radius:6px;box-shadow:0 4px 24px rgba(0,0,0,0.5);background:#14161b;min-width:892px;min-height:532px;display:flex;align-items:center;justify-content:center}.loading-overlay{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1rem;z-index:1;transition:opacity 0.3s}.loading-overlay.hidden{opacity:0;pointer-events:none}.loading-spinner{width:28px;height:28px;border:3px solid #333;border-top-color:#82aaff;border-radius:50%;animation:spin 0.8s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}.loading-text{font-family:'Cascadia Mono',Consolas,monospace;font-size:0.85rem;color:#555}#terminal{border-radius:4px;cursor:text;outline:none;opacity:0;transition:opacity 0.3s}#terminal.ready{opacity:1}.help{margin-top:1.5rem;font-size:0.85rem;color:#888;text-align:center;line-height:1.7;max-width:900px}.help kbd{display:inline-block;background:#333;color:#eee;border:1px solid #555;border-radius:3px;padding:1px 5px;font-family:'Cascadia Mono',Consolas,monospace;font-size:0.8rem}</style>
</head>
<body>

<h1>VimFu Simulator</h1>
<div id="mode-badge" class="mode-badge shell">SHELL</div>
<div class="terminal-wrapper">
  <div class="loading-overlay" id="loading">
    <div class="loading-spinner"></div>
    <div class="loading-text">Loading terminalâ€¦</div>
  </div>
  <canvas id="terminal" tabindex="0"></canvas>
</div>

<div class="help">
  Type <kbd>help</kbd> at the shell prompt for available commands.
</div>

<script type="module">var Z=class{constructor(e=[""]){this.lines=e.length>0?[...e]:[""]}get lineCount(){return this.lines.length}lineLength(e){return e<0||e>=this.lines.length?0:this.lines[e].length}charAt(e,t){if(e<0||e>=this.lines.length)return"";let s=this.lines[e];return t<0||t>=s.length?"":s[t]}insertChar(e,t,s){let i=this.lines[e];this.lines[e]=i.slice(0,t)+s+i.slice(t)}insertText(e,t,s){let i=s.split(`
`),r=this.lines[e],o=r.slice(0,t),n=r.slice(t);if(i.length===1)return this.lines[e]=o+i[0]+n,{row:e,col:t+i[0].length};this.lines[e]=o+i[0];let c=i.slice(1,-1),h=i[i.length-1],l=e+1;return this.lines.splice(l,0,...c,h+n),{row:e+i.length-1,col:h.length}}deleteChar(e,t){let s=this.lines[e];t<s.length?this.lines[e]=s.slice(0,t)+s.slice(t+1):e+1<this.lines.length&&(this.lines[e]=s+this.lines[e+1],this.lines.splice(e+1,1))}splitLine(e,t){let s=this.lines[e];this.lines[e]=s.slice(0,t),this.lines.splice(e+1,0,s.slice(t))}insertLineAfter(e){this.lines.splice(e+1,0,"")}insertLineBefore(e){this.lines.splice(e,0,"")}deleteCharBefore(e,t){if(t>0){let s=this.lines[e];return this.lines[e]=s.slice(0,t-1)+s.slice(t),{row:e,col:t-1}}else if(e>0){let s=this.lines[e-1].length;return this.lines[e-1]+=this.lines[e],this.lines.splice(e,1),{row:e-1,col:s}}return{row:e,col:t}}};var p={NORMAL:"normal",INSERT:"insert",VISUAL:"visual",VISUAL_LINE:"visual_line",REPLACE:"replace",COMMAND:"command"},it=class{constructor({rows:e=20,cols:t=40,lines:s=[""]}={}){this.rows=e,this.cols=t,this.buffer=new Z(s),this.cursor={row:0,col:0},this.mode=p.NORMAL,this.scrollTop=0,this.statusLine="",this.commandLine="",this.filename=null,this._textRows=e-2,this._pendingCount="",this._pendingOp="",this._pendingG=!1,this._pendingZ=!1,this._pendingCapZ=!1,this._pendingF="",this._pendingR=!1,this._pendingM=!1,this._pendingQ=!1,this._pendingAt=!1,this._pendingQuote=!1,this._pendingBacktick=!1,this._pendingTextObjType=null,this._opStartPos=null,this._motionInclusive=!1,this._motionLinewise=!1,this._motionExclusive=!1,this._insertCount=1,this._scrollHalf=0,this._pendingOpForSearch="",this._opStartPosForSearch=null,this._unnamedReg="",this._regType="char",this._namedRegs={},this._pendingRegKey="",this._pendingCtrlR=!1,this._searchPattern="",this._searchForward=!0,this._searchInput="",this._showCurSearch=!1,this._curSearchPos=null,this._hlsearchActive=!0,this._messagePrompt=null,this._stickyCommandLine=!1,this._lastInsertPos=null,this._lastFind=null,this._visualStart={row:0,col:0},this._visualExclusive=!1,this._lastVisual=null,this._lastChange=null,this._recording=!1,this._recordedKeys=[],this._dotPrefix=[],this._undoStack=[],this._redoStack=[],this._changeCount=0,this._changeList=[],this._changeListPos=-1,this._saveSnapshot(),this._changeCount=0,this._marks={},this._macroRegisters={},this._macroRecording="",this._macroKeys=[],this._lastMacroRegister="",this._lastRecordedRegister="",this._macroPlaying=!1,this._macroAborted=!1,this._jumpList=[],this._jumpListPos=-1,this._lastExCommand=null,this._visualCmdRange=null,this._desiredCol=0,this._settings={number:!1,relativenumber:!1},this._updateStatus()}loadFile(e){let t=e.split(`
`);t.length>1&&t[t.length-1]===""&&t.pop(),this.buffer=new Z(t);let s=this._firstNonBlank(0);this.cursor={row:0,col:s},this._desiredCol=this._virtColAt(0,s),this.scrollTop=0,this._undoStack=[],this._redoStack=[],this._changeCount=0,this._jumpList=[],this._jumpListPos=-1,this._changeList=[],this._changeListPos=-1,this._saveSnapshot(),this._changeCount=0,this._changeList=[],this._changeListPos=-1,this._updateStatus()}_firstNonBlankOfLine(e){let t=e.match(/\S/);return t?t.index:0}feedKey(e){if(e==="Ctrl-["&&(e="Escape"),this._messagePrompt){this._messagePrompt=null,this.commandLine="",this._updateStatus();return}this._stickyCommandLine&&(this._stickyCommandLine=!1,this.commandLine=""),this._macroRecording&&!this._macroPlaying&&this._macroKeys.push(e),this.mode===p.COMMAND?this._commandKey(e):this.mode===p.NORMAL?this._normalKey(e):this.mode===p.INSERT?this._insertKey(e):this.mode===p.VISUAL||this.mode===p.VISUAL_LINE?this._visualKey(e):this.mode===p.REPLACE&&this._replaceKey(e),this._clampCursor(),this._ensureCursorVisible(),this._updateStatus()}_saveSnapshot(){this._macroPlaying||(this._changeCount++,this._changeList.push({row:this.cursor.row,col:this.cursor.col}),this._changeList.length>100&&this._changeList.shift(),this._changeListPos=this._changeList.length,this._undoStack.push({lines:[...this.buffer.lines],cursor:{...this.cursor},scrollTop:this.scrollTop}),this._undoStack.length>100&&this._undoStack.shift())}_undo(){if(this._undoStack.length<=1)return;this._changeCount--;let e=this._undoStack.pop(),t={lines:[...this.buffer.lines],cursor:{...this.cursor},scrollTop:this.scrollTop,redoCursor:e.redoCursor||{...e.cursor},undoCursor:{...e.cursor}};this._redoStack.push(t),this.buffer=new Z([...e.lines]),this.cursor={...e.cursor},this.scrollTop=e.scrollTop}_redo(){if(this._redoStack.length===0)return;this._changeCount++;let e=this._redoStack.pop(),t={...e.redoCursor};this._undoStack.push({lines:[...this.buffer.lines],cursor:e.undoCursor?{...e.undoCursor}:{...this.cursor},scrollTop:this.scrollTop,redoCursor:{...e.redoCursor}}),this.buffer=new Z([...e.lines]),this.scrollTop=e.scrollTop,this.cursor=t,this.cursor.row=Math.min(this.cursor.row,this.buffer.lineCount-1),this.cursor.col=Math.min(this.cursor.col,Math.max(0,this.buffer.lineLength(this.cursor.row)-1))}_saveForDot(e){this._recording&&this._recordedKeys.push(e)}_startRecording(){this._recording=!0,this._recordedKeys=[]}_stopRecording(){this._recording&&(this._recording=!1,this._lastChange=[...this._dotPrefix,...this._recordedKeys],this._dotPrefix=[])}_getCount(e=1){let t=this._pendingCount?parseInt(this._pendingCount,10):e;return this._pendingCount="",t}_hasCount(){return this._pendingCount!==""}_setReg(e,t){let s=this._pendingRegKey;this._unnamedReg=e,this._regType=t,s&&(this._namedRegs[s]={text:e,type:t},this._pendingRegKey="")}_getReg(){let e=this._pendingRegKey;if(this._pendingRegKey="",e){let t=this._namedRegs[e];return t||{text:"",type:"char"}}return{text:this._unnamedReg,type:this._regType}}_normalKey(e){if(this._macroRecording&&e==="q"&&!this._pendingOp&&!this._pendingF&&!this._pendingR&&!this._pendingG&&!this._pendingZ&&!this._pendingCapZ&&!this._pendingM&&!this._pendingQuote&&!this._pendingBacktick&&!this._pendingTextObjType){this._macroKeys.pop(),this._macroRegisters[this._macroRecording]=[...this._macroKeys],this._lastMacroRegister=this._macroRecording,this._lastRecordedRegister=this._macroRecording,this._macroRecording="",this._macroKeys=[],this._pendingCount="";return}if(this._pendingQ){this._pendingQ=!1,e.length===1&&e>="a"&&e<="z"&&(this._macroRecording=e,this._macroKeys=[]),this._pendingCount="";return}if(this._pendingAt){if(this._pendingAt=!1,e===":"){if(this._lastExCommand){let s=this._getCount();for(let i=0;i<s;i++){this.feedKey(":");for(let r of this._lastExCommand)this.feedKey(r);this.feedKey("Enter")}}this._pendingCount="";return}let t=null;if(e==="@"?t=this._lastMacroRegister:e.length===1&&e>="a"&&e<="z"&&(t=e),t&&this._macroRegisters[t]){this._lastMacroRegister=t;let s=this._getCount(),i=this._macroRegisters[t];this._saveSnapshot(),this._redoStack=[];let r=this._macroPlaying;this._macroPlaying=!0,this._macroAborted=!1;for(let o=0;o<s&&!this._macroAborted;o++)for(let n of i){if(this._macroAborted)break;this.feedKey(n)}this._macroPlaying=r,this._macroAborted=!1}this._pendingCount="";return}if(this._pendingDblQuote){this._pendingDblQuote=!1,e.length===1&&e>="a"&&e<="z"&&(this._pendingRegKey=e);return}if(this._pendingR){if(this._pendingR=!1,e.length===1&&e!=="Escape"){this._saveSnapshot(),this._startRecording(),this._saveForDot("r"),this._saveForDot(e);let t=this._getCount(),s=this.buffer.lines[this.cursor.row];if(this.cursor.col+t-1<s.length){let i=s.slice(0,this.cursor.col);for(let r=0;r<t;r++)i+=e;i+=s.slice(this.cursor.col+t),this.buffer.lines[this.cursor.row]=i,this.cursor.col=this.cursor.col+t-1}this._stopRecording(),this._redoStack=[]}this._pendingCount="";return}if(this._pendingF){let t=this._pendingF;this._pendingF="";let s=e==="Tab"?"	":e;if((s.length===1||e==="Tab")&&e!=="Escape"){this._lastFind={type:t,char:s};let i=this._getCount(),r=this.cursor.col,o=!1;if(t==="t"||t==="T"){let c=t==="t"?"f":"F";for(let h=0;h<i-1;h++){let l=this.cursor.col;if(this._doFind(c,s),this.cursor.col===l){o=!0;break}}if(!o){let h=this.cursor.col,l=t==="t"?"f":"F",a=this.cursor.col;this._doFind(l,s),this.cursor.col!==a?t==="t"?this.cursor.col-=1:this.cursor.col+=1:o=!0}}else for(let c=0;c<i;c++){let h=this.cursor.col;if(this._doFind(t,s),this.cursor.col===h){o=!0;break}}let n=!o&&this.cursor.col!==r;if(!n&&o&&(this.cursor.col=r),this._pendingOp){if(n||!o&&(t==="t"||t==="T")){this._motionInclusive=!0;let c=this._pendingOp,h=[c,t,e];c==="c"&&(this._dotPrefix=h),this._executeOperator(this._opStartPos,{row:this.cursor.row,col:this.cursor.col}),c!=="c"&&c!=="y"&&(this._lastChange=h)}else this.cursor.col=this._opStartPos.col;this._pendingOp=""}else this._updateDesiredCol()}else this._pendingOp="",this._pendingCount="";return}if(this._pendingM){this._pendingM=!1,e.length===1&&e>="a"&&e<="z"&&(this._marks[e]={row:this.cursor.row,col:this.cursor.col}),this._pendingCount="";return}if(this._pendingQuote){if(this._pendingQuote=!1,e.length===1&&e>="a"&&e<="z"&&this._marks[e]){let t=this.cursor.row,s=this.cursor.col;this.cursor.row=this._marks[e].row,this.cursor.col=this._firstNonBlank(this.cursor.row),this._pendingOp&&(this._motionLinewise=!0,this._motionInclusive=!1,this._executeOperator(this._opStartPos,{...this.cursor}),this._pendingOp="")}else this._pendingOp&&(this._pendingOp="");this._pendingCount="";return}if(this._pendingBacktick){if(this._pendingBacktick=!1,e.length===1&&e>="a"&&e<="z"&&this._marks[e]){let t=this.cursor.row,s=this.cursor.col;this.cursor.row=this._marks[e].row,this.cursor.col=this._marks[e].col,this._pendingOp&&(this._motionInclusive=!1,this._motionLinewise=!1,(this.cursor.row!==t||this.cursor.col!==s)&&this._executeOperator(this._opStartPos,{...this.cursor}),this._pendingOp="")}else this._pendingOp&&(this._pendingOp="");this._pendingCount="";return}if(this._pendingZ){this._pendingZ=!1,this._handleZ(e),this._pendingCount="";return}if(this._pendingCapZ){this._pendingCapZ=!1,e==="Z"?this._lastExCommand="wq":e==="Q"&&(this._lastExCommand="q!"),this._pendingCount="";return}if(this._pendingG){this._pendingG=!1,this._handleG(e);return}if(e>="1"&&e<="9"||e==="0"&&this._pendingCount!==""){this._pendingCount+=e;return}if(this._pendingTextObjType){let t=this._pendingTextObjType;this._pendingTextObjType=null;let s=this._pendingOp,i=this._getTextObject(t,e);if(i){let r=[s,t,e];s==="c"&&(this._dotPrefix=r),this._executeOperatorRange(i),s!=="c"&&s!=="y"&&(this._lastChange=r)}this._pendingOp="",this._pendingCount="";return}if(this._pendingOp){if(e===this._pendingOp[this._pendingOp.length-1]){let _=this._pendingCount,d=this._getCount(),b=this._pendingOp[this._pendingOp.length-1],C=[];if(_)for(let v of _)C.push(v);C.push(b,b),b==="c"&&(this._dotPrefix=C),this._doLineOperation(this._pendingOp,d),b!=="y"&&b!=="c"&&(this._lastChange=C),this._pendingOp="";return}if(e==="i"||e==="a"){this._pendingTextObjType=e,this._pendingTextObjKeyForDot=e;return}if(e==="g"){this._pendingG=!0;return}if(this._opStartPos={row:this.cursor.row,col:this.cursor.col},e==="f"||e==="F"||e==="t"||e==="T"){this._pendingF=e,this._motionInclusive=e==="f"||e==="F",this._pendingMotionKeyForDot=e;return}if(e==="'"){this._pendingQuote=!0;return}if(e==="`"){this._pendingBacktick=!0;return}if(e==="/"||e==="?"){this._pendingOpForSearch=this._pendingOp,this._opStartPosForSearch={...this._opStartPos},this._pendingOp="",this.mode=p.COMMAND,this._searchForward=e==="/",this._searchInput="",this.commandLine=e;return}let t=e,s=!1,r=(this.buffer.lines[this.cursor.row]||"")[this.cursor.col];this._pendingOp==="c"&&(e==="w"||e==="W")&&r&&r!==" "&&r!=="	"&&(s=!0,t=e==="w"?"e":"E"),this._motionInclusive=!1,this._motionLinewise=!1,this._motionExclusive=!1;let o=this._pendingOp,n=this._pendingCount,c=this.cursor.row,h=this.cursor.col,l=n?parseInt(n,10):1,a=this._doMotion(t);if(s&&a&&l===1){let _=this.buffer.lines[c],d=h;if(e==="W")for(;d+1<_.length&&_[d+1]!==" "&&_[d+1]!=="	";)d++;else if(this._isWordChar(_[h]))for(;d+1<_.length&&this._isWordChar(_[d+1]);)d++;else for(;d+1<_.length&&!this._isWordChar(_[d+1])&&_[d+1]!==" "&&_[d+1]!=="	";)d++;(this.cursor.row>c||this.cursor.col>d)&&(this.cursor.row=c,this.cursor.col=d)}let f=!a&&!this._motionLinewise&&this._motionInclusive,u=o==="c"&&!a&&!this._motionLinewise&&(t==="0"||t==="^");if(a||this._motionLinewise||f||u){let _={row:this.cursor.row,col:this.cursor.col};o==="d"&&(e==="w"||e==="W")&&this.cursor.row>this._opStartPos.row&&(this.buffer.lines[this._opStartPos.row].length===0?(this._motionLinewise=!0,_={row:this._opStartPos.row,col:0}):_={row:this._opStartPos.row,col:this.buffer.lines[this._opStartPos.row].length});let d=[];if(d.push(o),n)for(let b of n)d.push(b);d.push(e),o==="c"&&(this._dotPrefix=d),this._executeOperator(this._opStartPos,_),o!=="c"&&o!=="y"&&(this._lastChange=d)}this._pendingOp="",this._pendingCount="";return}switch(e){case"h":case"ArrowLeft":{let t=this._getCount();for(let s=0;s<t;s++)this.cursor.col>0&&this.cursor.col--;this._updateDesiredCol();break}case"Backspace":{let t=this._getCount();for(let s=0;s<t;s++)this.cursor.col>0?this.cursor.col--:this.cursor.row>0&&(this.cursor.row--,this.cursor.col=this._maxCol());this._updateDesiredCol();break}case"l":case"ArrowRight":{let t=this._getCount();for(let s=0;s<t;s++)this.cursor.col<this._maxCol()&&this.cursor.col++;this._updateDesiredCol();break}case" ":{let t=this._getCount();for(let s=0;s<t;s++)this.cursor.col<this._maxCol()?this.cursor.col++:this.cursor.row<this.buffer.lineCount-1&&(this.cursor.row++,this.cursor.col=0);this._updateDesiredCol();break}case"j":case"ArrowDown":{let t=this._getCount(),s=this.cursor.row;for(let i=0;i<t;i++)this.cursor.row<this.buffer.lineCount-1&&this.cursor.row++;this._macroPlaying&&this.cursor.row===s&&(this._macroAborted=!0),this._applyDesiredCol();break}case"k":case"ArrowUp":{let t=this._getCount(),s=this.cursor.row;for(let i=0;i<t;i++)this.cursor.row>0&&this.cursor.row--;this._applyDesiredCol();break}case"w":{let t=this._getCount();for(let s=0;s<t;s++)this._moveWordForward(!1);this._updateDesiredCol();break}case"W":{let t=this._getCount();for(let s=0;s<t;s++)this._moveWordForward(!0);this._updateDesiredCol();break}case"b":{let t=this._getCount();for(let s=0;s<t;s++)this._moveWordBackward(!1);this._updateDesiredCol();break}case"B":{let t=this._getCount();for(let s=0;s<t;s++)this._moveWordBackward(!0);this._updateDesiredCol();break}case"e":{let t=this._getCount();for(let s=0;s<t;s++)this._moveWordEnd(!1);this._updateDesiredCol();break}case"E":{let t=this._getCount();for(let s=0;s<t;s++)this._moveWordEnd(!0);this._updateDesiredCol();break}case"0":this.cursor.col=0,this._desiredCol=0;break;case"^":this.cursor.col=this._firstNonBlank(this.cursor.row),this._updateDesiredCol();break;case"$":{let t=this._getCount();t>1&&(this.cursor.row=Math.min(this.cursor.row+t-1,this.buffer.lineCount-1)),this.cursor.col=this._maxCol(),this._desiredCol=1/0;break}case"_":{let t=this._getCount();this.cursor.row=Math.min(this.cursor.row+t-1,this.buffer.lineCount-1),this.cursor.col=this._firstNonBlank(this.cursor.row),this._updateDesiredCol();break}case"G":{if(this._addJumpEntry(),this._hasCount()){let t=this._getCount();this.cursor.row=Math.max(0,Math.min(t-1,this.buffer.lineCount-1)),this.cursor.col=0,this._updateDesiredCol()}else this.cursor.row=this.buffer.lineCount-1,this._applyDesiredCol();break}case"g":this._pendingG=!0;return;case"z":this._pendingZ=!0;return;case"Z":this._pendingCapZ=!0;return;case"f":case"F":case"t":case"T":this._pendingF=e;return;case";":{if(this._lastFind){let t=this._getCount();this._doFindRepeat(this._lastFind.type,this._lastFind.char,t)}break}case",":{if(this._lastFind){let t=this._getCount(),s={f:"F",F:"f",t:"T",T:"t"}[this._lastFind.type];this._doFindRepeat(s,this._lastFind.char,t)}break}case"%":{if(!this._hasCount())this._doMatchBracket();else{let t=this._getCount(),s=Math.max(0,Math.min(Math.round(t/100*this.buffer.lineCount)-1,this.buffer.lineCount-1));this.cursor.row=s,this.cursor.col=this._firstNonBlank(this.cursor.row)}this._updateDesiredCol();break}case"{":{let t=this._getCount(),s={row:this.cursor.row,col:this.cursor.col},i=!0;for(let r=0;r<t;r++)if(!this._moveParagraphBackward()){i=!1;break}i||(this.cursor.row=s.row,this.cursor.col=s.col),this._updateDesiredCol();break}case"}":{let t=this._getCount(),s={row:this.cursor.row,col:this.cursor.col},i=!0;for(let r=0;r<t;r++)if(!this._moveParagraphForward()){i=!1;break}i||(this.cursor.row=s.row,this.cursor.col=s.col),this._updateDesiredCol();break}case"H":{let t=this._getCount()-1;this.cursor.row=Math.min(this.scrollTop+t,this.buffer.lineCount-1),this.cursor.col=this._byteColForVirtCol(this.cursor.row,this._desiredCol);break}case"M":{let t=Math.min(this._textRows,this.buffer.lineCount-this.scrollTop);this.cursor.row=this.scrollTop+Math.floor((t-1)/2),this.cursor.col=this._byteColForVirtCol(this.cursor.row,this._desiredCol);break}case"L":{let t=this._getCount()-1,s=this.scrollTop+Math.min(this._textRows,this.buffer.lineCount-this.scrollTop)-1;this.cursor.row=Math.max(this.scrollTop,s-t),this.cursor.col=this._byteColForVirtCol(this.cursor.row,this._desiredCol);break}case"+":case"Enter":{let t=this._getCount();this.cursor.row=Math.min(this.cursor.row+t,this.buffer.lineCount-1),this.cursor.col=this._firstNonBlank(this.cursor.row),this._updateDesiredCol();break}case"-":{let t=this._getCount();this.cursor.row=Math.max(this.cursor.row-t,0),this.cursor.col=this._firstNonBlank(this.cursor.row),this._updateDesiredCol();break}case"|":{let t=this._getCount()-1;this.cursor.col=this._byteColForVirtCol(this.cursor.row,t),this._updateDesiredCol();break}case"Delete":case"x":{let t=this._pendingCount,s=this._getCount();if(this.buffer.lineLength(this.cursor.row)===0)break;this._saveSnapshot(),t&&(this._dotPrefix=[...t]),this._startRecording(),this._saveForDot("x");let i="";for(let r=0;r<s;r++)this.cursor.col<this.buffer.lineLength(this.cursor.row)&&(i+=this.buffer.charAt(this.cursor.row,this.cursor.col),this.buffer.deleteChar(this.cursor.row,this.cursor.col));i&&this._setReg(i,"char"),this._stopRecording(),this._redoStack=[],this.cursor.col>0&&this.cursor.col>=this.buffer.lineLength(this.cursor.row)&&(this.cursor.col=Math.max(0,this.buffer.lineLength(this.cursor.row)-1)),this._updateDesiredCol();break}case"X":{let t=this._pendingCount,s=this._getCount();this._saveSnapshot(),t&&(this._dotPrefix=[...t]),this._startRecording(),this._saveForDot("X");let i="";for(let r=0;r<s;r++)this.cursor.col>0&&(this.cursor.col--,i=this.buffer.charAt(this.cursor.row,this.cursor.col)+i,this.buffer.deleteChar(this.cursor.row,this.cursor.col));i&&this._setReg(i,"char"),this._stopRecording(),this._redoStack=[],this._updateDesiredCol();break}case"s":{let t=this._pendingCount,s=this._getCount();this._saveSnapshot(),t&&(this._dotPrefix=[...t]),this._startRecording(),this._saveForDot("s");let i="";for(let r=0;r<s;r++)this.cursor.col<this.buffer.lineLength(this.cursor.row)&&(i+=this.buffer.charAt(this.cursor.row,this.cursor.col),this.buffer.deleteChar(this.cursor.row,this.cursor.col));i&&this._setReg(i,"char"),this.mode=p.INSERT,this.commandLine="-- INSERT --";break}case"S":{let t=this._getCount();this._insertCount=1,this._saveSnapshot(),this._startRecording(),this._saveForDot("S");let s=this.cursor.row,i=Math.min(s+t-1,this.buffer.lineCount-1),o=this.buffer.lines[s].match(/^\s*/)[0],n="";for(let c=s;c<=i;c++)n+=(c>s?`
`:"")+this.buffer.lines[c];this._setReg(n,"line"),this.buffer.lines.splice(s,i-s+1,o),this.cursor.row=s,this.cursor.col=o.length,this.mode=p.INSERT,this.commandLine="-- INSERT --",this._redoStack=[];break}case"r":this._pendingR=!0;return;case"R":this._saveSnapshot(),this._startRecording(),this._saveForDot("R"),this.mode=p.REPLACE,this.commandLine="-- REPLACE --",this._replaceStartCol=this.cursor.col,this._replaceOrigChars=[];break;case"~":{let t=this._getCount();if(this.buffer.lineLength(this.cursor.row)===0)break;this._saveSnapshot(),this._startRecording(),this._saveForDot("~");for(let s=0;s<t;s++)if(this.cursor.col<this.buffer.lineLength(this.cursor.row)){let i=this.buffer.charAt(this.cursor.row,this.cursor.col),r=i===i.toUpperCase()?i.toLowerCase():i.toUpperCase();if(this.buffer.lines[this.cursor.row]=this.buffer.lines[this.cursor.row].slice(0,this.cursor.col)+r+this.buffer.lines[this.cursor.row].slice(this.cursor.col+1),this.cursor.col<this.buffer.lineLength(this.cursor.row)-1)this.cursor.col++;else break}this._stopRecording(),this._redoStack=[],this._updateDesiredCol();break}case"J":{let s=Math.max(2,this._getCount())-1;this._saveSnapshot(),this._startRecording(),this._saveForDot("J");for(let i=0;i<s;i++)if(this.cursor.row<this.buffer.lineCount-1){let r=this.buffer.lines[this.cursor.row],n=this.buffer.lines[this.cursor.row+1].replace(/^\s+/,""),c=r.length,h=n.length>0?n[0]:"",l=r.length>0&&(r[r.length-1]===" "||r[r.length-1]==="	"),a;r.length===0||n.length===0||h===")"||l?a=r+n:a=r+" "+n,this.buffer.lines[this.cursor.row]=a,this.buffer.lines.splice(this.cursor.row+1,1),this.cursor.col=c}this._stopRecording(),this._redoStack=[],this._updateDesiredCol();break}case"d":this._pendingOp="d",this._opStartPos={...this.cursor};return;case"c":this._pendingOp="c",this._opStartPos={...this.cursor};return;case"y":this._pendingOp="y",this._opStartPos={...this.cursor};return;case">":this._pendingOp=">",this._opStartPos={...this.cursor};return;case"<":this._pendingOp="<",this._opStartPos={...this.cursor};return;case"D":{this._saveSnapshot(),this._startRecording(),this._saveForDot("D");let t=this._getCount(),s=this.buffer.lines[this.cursor.row];if(t>1){let i=Math.min(this.cursor.row+t-1,this.buffer.lineCount-1),r=s.slice(this.cursor.col);for(let o=this.cursor.row+1;o<=i;o++)r+=`
`+this.buffer.lines[o];this._setReg(r,"char"),this.buffer.lines.splice(this.cursor.row+1,i-this.cursor.row),this.buffer.lines[this.cursor.row]=s.slice(0,this.cursor.col)}else this._setReg(s.slice(this.cursor.col),"char"),this.buffer.lines[this.cursor.row]=s.slice(0,this.cursor.col);this.cursor.col=Math.max(0,this.cursor.col-1),this._stopRecording(),this._redoStack=[],this._updateDesiredCol();break}case"C":{this._saveSnapshot(),this._startRecording(),this._saveForDot("C");let t=this.buffer.lines[this.cursor.row];this._setReg(t.slice(this.cursor.col),"char"),this.buffer.lines[this.cursor.row]=t.slice(0,this.cursor.col),this.mode=p.INSERT,this.commandLine="-- INSERT --";break}case"Y":{let t=this._getCount(),s=this.buffer.lines[this.cursor.row];this._setReg(s.slice(this.cursor.col),"char");break}case"p":{let t=this._getCount(),s=this._pendingRegKey,i=this._getReg();if(s&&!i.text){this.commandLine="E353: Nothing in register "+s,this._stickyCommandLine=!0;break}this._saveSnapshot(),this._startRecording(),this._saveForDot("p");for(let r=0;r<t;r++)this._putAfter(i);i.type==="line"&&t>1&&(this.cursor.row-=t-1,this.cursor.col=this._firstNonBlank(this.cursor.row)),this._stopRecording(),this._redoStack=[];break}case"P":{let t=this._getCount(),s=this._pendingRegKey,i=this._getReg();if(s&&!i.text){this.commandLine="E353: Nothing in register "+s,this._stickyCommandLine=!0;break}this._saveSnapshot(),this._startRecording(),this._saveForDot("P");for(let r=0;r<t;r++)this._putBefore(i);i.type==="line"&&t>1&&(this.cursor.row-=t-1,this.cursor.col=this._firstNonBlank(this.cursor.row)),this._stopRecording(),this._redoStack=[];break}case"i":this._insertCount=this._getCount(),this._saveSnapshot(),this._startRecording(),this._saveForDot("i"),this.mode=p.INSERT,this.commandLine="-- INSERT --";break;case"I":{this._insertCount=this._getCount(),this._saveSnapshot(),this._startRecording(),this._saveForDot("I");let t=this.buffer.lines[this.cursor.row],s=t.match(/\S/);this.cursor.col=s?s.index:t.length,this.mode=p.INSERT,this.commandLine="-- INSERT --";break}case"a":this._insertCount=this._getCount(),this._startRecording(),this._saveForDot("a"),this.buffer.lineLength(this.cursor.row)>0&&this.cursor.col++,this._saveSnapshot(),this.mode=p.INSERT,this.commandLine="-- INSERT --";break;case"A":this._insertCount=this._getCount(),this._startRecording(),this._saveForDot("A"),this.cursor.col=this.buffer.lineLength(this.cursor.row),this._saveSnapshot(),this.mode=p.INSERT,this.commandLine="-- INSERT --";break;case"o":{this._insertCount=this._getCount(),this._saveSnapshot(),this._startRecording(),this._saveForDot("o");let t=this.buffer.lines[this.cursor.row].match(/^[ \t]*/)[0];this.buffer.insertLineAfter(this.cursor.row),this.cursor.row++,this.buffer.lines[this.cursor.row]=t,this.cursor.col=t.length,this.mode=p.INSERT,this.commandLine="-- INSERT --";break}case"O":{this._insertCount=this._getCount(),this._saveSnapshot(),this._startRecording(),this._saveForDot("O");let t=this.buffer.lines[this.cursor.row].match(/^[ \t]*/)[0];this.buffer.insertLineBefore(this.cursor.row),this.buffer.lines[this.cursor.row]=t,this.cursor.col=t.length,this.mode=p.INSERT,this.commandLine="-- INSERT --";break}case"u":{let t=this._getCount();for(let s=0;s<t;s++)this._undo();break}case"Ctrl-R":{let t=this._getCount();for(let s=0;s<t;s++)this._redo();break}case".":{if(this._lastChange){let t=this._pendingCount;this._pendingCount="";let s=[...this._lastChange],i;if(t){let r=0;for(;r<s.length&&s[r]>="0"&&s[r]<="9";)r++;i=[...t].concat(s.slice(r))}else i=s;for(let r of i)this.feedKey(r);this._lastChange=s}break}case"v":this.mode=p.VISUAL,this._visualStart={...this.cursor},this.commandLine="-- VISUAL --";break;case"V":this.mode=p.VISUAL_LINE,this._visualStart={...this.cursor},this.commandLine="-- VISUAL LINE --";break;case"/":this.mode=p.COMMAND,this._searchForward=!0,this._searchInput="",this.commandLine="/";return;case"?":this.mode=p.COMMAND,this._searchForward=!1,this._searchInput="",this.commandLine="?";return;case"n":{this._addJumpEntry();let t=this._getCount();for(let s=0;s<t;s++)this._searchNext(this._searchForward);this._showCurSearch=!0,this._hlsearchActive=!0;break}case"N":{this._addJumpEntry();let t=this._getCount();for(let s=0;s<t;s++)this._searchNext(!this._searchForward);this._showCurSearch=!0,this._hlsearchActive=!0;break}case"*":{let t=this._wordUnderCursor();t&&(this._addJumpEntry(),this._searchPattern="\\b"+t+"\\b",this._searchForward=!0,this._searchNext(!0),this._showCurSearch=!0,this._hlsearchActive=!0);break}case"#":{let t=this._wordUnderCursor();t&&(this._addJumpEntry(),this._searchPattern="\\b"+t+"\\b",this._searchForward=!1,this._searchNext(!1),this._showCurSearch=!0,this._hlsearchActive=!0);break}case"Ctrl-D":{this._hasCount()&&(this._scrollHalf=this._getCount());let t=this._scrollHalf||Math.floor(this._textRows/2);this.cursor.row=Math.min(this.cursor.row+t,this.buffer.lineCount-1),this.scrollTop=Math.min(this.scrollTop+t,Math.max(0,this.buffer.lineCount-this._textRows)),this.cursor.col=this._firstNonBlank(this.cursor.row),this._updateDesiredCol();break}case"Ctrl-U":{this._hasCount()&&(this._scrollHalf=this._getCount());let t=this._scrollHalf||Math.floor(this._textRows/2);this.cursor.row=Math.max(this.cursor.row-t,0),this.scrollTop=Math.max(this.scrollTop-t,0),this.cursor.col=this._firstNonBlank(this.cursor.row),this._updateDesiredCol();break}case"Ctrl-F":{let t=this._getCount(),s=(this._textRows-2)*t,i=this.scrollTop+this._textRows-1,r=Math.max(0,this.buffer.lineCount-1);i>=this.buffer.lineCount-1?this.scrollTop=r:this.scrollTop=Math.min(this.scrollTop+s,r),this.cursor.row=Math.min(this.scrollTop,this.buffer.lineCount-1),this.cursor.col=this._firstNonBlank(this.cursor.row),this._updateDesiredCol();break}case"Ctrl-B":{let t=this._getCount(),s=this._textRows*t,i=this.scrollTop;if(this.scrollTop=Math.max(this.scrollTop-s,0),this.scrollTop===0&&i===0)break;this.cursor.row=Math.min(this.scrollTop+this._textRows-1,this.buffer.lineCount-1),this.cursor.col=this._firstNonBlank(this.cursor.row),this._updateDesiredCol();break}case"Ctrl-E":{let t=this._getCount(),s=Math.max(0,this.buffer.lineCount-1);this.scrollTop=Math.min(this.scrollTop+t,s),this.cursor.row<this.scrollTop&&(this.cursor.row=this.scrollTop,this._applyDesiredCol());break}case"Ctrl-Y":{let t=this._getCount();this.scrollTop=Math.max(this.scrollTop-t,0),this.cursor.row>=this.scrollTop+this._textRows&&(this.cursor.row=this.scrollTop+this._textRows-1,this._applyDesiredCol());break}case"m":this._pendingM=!0;return;case"'":this._pendingQuote=!0;return;case"`":this._pendingBacktick=!0;return;case"q":this._pendingQ=!0;return;case"@":this._pendingAt=!0;return;case'"':this._pendingDblQuote=!0;return;case"Q":{if(this._lastRecordedRegister&&this._macroRegisters[this._lastRecordedRegister]){let t=this._lastRecordedRegister,s=this._getCount(),i=this._macroRegisters[t];this._saveSnapshot(),this._redoStack=[];let r=this._macroPlaying;this._macroPlaying=!0,this._macroAborted=!1;for(let o=0;o<s&&!this._macroAborted;o++)for(let n of i){if(this._macroAborted)break;this.feedKey(n)}this._macroPlaying=r,this._macroAborted=!1}this._pendingCount="";break}case"Ctrl-G":{let t=this.filename||"[No Name]",s=this.buffer.lineCount,i=0;for(let r=0;r<s;r++)i+=this.buffer.lines[r].length+(r<s-1?1:0);this.commandLine=`"${t}" ${s}L, ${i}B`,this._stickyCommandLine=!0,this._pendingCount="";break}case"Ctrl-A":{let t=this._pendingCount,s=this._getCount();this._saveSnapshot(),t&&(this._dotPrefix=[...t]),this._startRecording(),this._saveForDot("Ctrl-A"),this._incrementNumber(s),this._stopRecording(),this._redoStack=[];break}case"Ctrl-X":{let t=this._pendingCount,s=this._getCount();this._saveSnapshot(),t&&(this._dotPrefix=[...t]),this._startRecording(),this._saveForDot("Ctrl-X"),this._incrementNumber(-s),this._stopRecording(),this._redoStack=[];break}case"Ctrl-O":{if(this._jumpList.length>0&&this._jumpListPos>0){this._jumpListPos>=this._jumpList.length&&(this._jumpList.push({row:this.cursor.row,col:this.cursor.col}),this._jumpListPos=this._jumpList.length-1),this._jumpListPos--;let t=this._jumpList[this._jumpListPos];this.cursor.row=Math.min(t.row,this.buffer.lineCount-1),this.cursor.col=Math.min(t.col,this._maxCol()),this._updateDesiredCol()}this._pendingCount="";break}case"Tab":case"Ctrl-I":{if(this._jumpListPos<this._jumpList.length-1){this._jumpListPos++;let t=this._jumpList[this._jumpListPos];this.cursor.row=Math.min(t.row,this.buffer.lineCount-1),this.cursor.col=Math.min(t.col,this._maxCol()),this._updateDesiredCol()}this._pendingCount="";break}case")":{let t=this._getCount();for(let s=0;s<t;s++)this._moveSentenceForward();this._updateDesiredCol();break}case"(":{let t=this._getCount();for(let s=0;s<t;s++)this._moveSentenceBackward();this._updateDesiredCol();break}case":":this.mode=p.COMMAND,this._searchInput="",this.commandLine=":";return;default:this._pendingCount="";break}}_handleG(e){switch(e){case"g":{if(this._pendingOp){let t=this._opStartPos;if(this._hasCount()){let s=this._getCount();this.cursor.row=Math.max(0,Math.min(s-1,this.buffer.lineCount-1))}else this.cursor.row=0;this.cursor.col=0,this._motionLinewise=!0,this._executeOperator(t,{...this.cursor}),this._pendingOp="";break}if(this._addJumpEntry(),this._hasCount()){let t=this._getCount();this.cursor.row=Math.max(0,Math.min(t-1,this.buffer.lineCount-1)),this.cursor.col=0,this._updateDesiredCol()}else this.cursor.row=0,this._applyDesiredCol();this._pendingCount="";break}case"_":{let t=this._getCount();t>1&&(this.cursor.row=Math.min(this.cursor.row+t-1,this.buffer.lineCount-1)),this.cursor.col=this._lastNonBlank(this.cursor.row),this._updateDesiredCol(),this._pendingOp&&(this._motionInclusive=!0,this._executeOperator(this._opStartPos,{...this.cursor}),this._pendingOp=""),this._pendingCount="";break}case"e":{let t=this._getCount(),s={row:this.cursor.row,col:this.cursor.col};for(let i=0;i<t;i++)this._moveWordEndBackward(!1);if(this._updateDesiredCol(),this._pendingOp){if(this.cursor.row!==s.row||this.cursor.col!==s.col){let i={row:this._opStartPos.row,col:this._opStartPos.col+1};this._executeOperator(i,{...this.cursor})}this._pendingOp=""}break}case"E":{let t=this._getCount(),s={row:this.cursor.row,col:this.cursor.col};for(let i=0;i<t;i++)this._moveWordEndBackward(!0);if(this._updateDesiredCol(),this._pendingOp){if(this.cursor.row!==s.row||this.cursor.col!==s.col){let i={row:this._opStartPos.row,col:this._opStartPos.col+1};this._executeOperator(i,{...this.cursor})}this._pendingOp=""}break}case"J":{let t=Math.max(2,this._getCount())-1;this._saveSnapshot(),this._startRecording(),this._saveForDot("g"),this._saveForDot("J");for(let s=0;s<t;s++)if(this.cursor.row<this.buffer.lineCount-1){let i=this.buffer.lines[this.cursor.row],r=this.buffer.lines[this.cursor.row+1],o=i.length;this.buffer.lines[this.cursor.row]=i+r,this.buffer.lines.splice(this.cursor.row+1,1),this.cursor.col=o}this._stopRecording(),this._redoStack=[],this._updateDesiredCol();break}case"u":{this._pendingOp="gu",this._opStartPos={...this.cursor};break}case"U":{this._pendingOp="gU",this._opStartPos={...this.cursor};break}case"~":{this._pendingOp="g~",this._opStartPos={...this.cursor};break}case"v":{this._lastVisual&&(this.mode=this._lastVisual.mode,this._visualStart={...this._lastVisual.start},this.cursor={...this._lastVisual.end},this.commandLine=this.mode===p.VISUAL_LINE?"-- VISUAL LINE --":"-- VISUAL --");break}case"i":this._saveSnapshot(),this._startRecording(),this._lastInsertPos&&(this.cursor.row=Math.min(this._lastInsertPos.row,this.buffer.lineCount-1),this.cursor.col=Math.min(this._lastInsertPos.col,this.buffer.lines[this.cursor.row].length)),this.mode=p.INSERT,this.commandLine="-- INSERT --";break;case"I":this._saveSnapshot(),this._startRecording(),this.cursor.col=0,this.mode=p.INSERT,this.commandLine="-- INSERT --";break;case"a":{let t=this.buffer.lines[this.cursor.row];if(t.length===0)this.commandLine="NUL";else{let s=t[this.cursor.col]||t[t.length-1],i=s.charCodeAt(0),r=i,o=i.toString(16),n=i.toString(8),c=i<32?"^"+String.fromCharCode(i+64):s;this.commandLine=`<${c}>  ${r},  Hex ${o.padStart(2,"0")},  Oct ${n.padStart(3,"0")}`}this._stickyCommandLine=!0,this._pendingCount="";break}case"d":{let t=this._wordUnderCursor();if(!t){let s=this.buffer.lines[this.cursor.row],i=this.cursor.col;for(;i<s.length&&!this._isWordChar(s[i]);)i++;if(i<s.length){let r=i;for(;r<s.length&&this._isWordChar(s[r]);)r++;t=s.slice(i,r)}}if(t){let s=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this._searchPattern="\\b"+s+"\\b",this._showCurSearch=!0,this._hlsearchActive=!0;let i=new RegExp("\\b"+s+"\\b");for(let r=0;r<this.buffer.lineCount;r++){let o=this.buffer.lines[r].match(i);if(o){this._addJumpEntry(),this.cursor.row=r,this.cursor.col=o.index,this._curSearchPos={row:r,col:o.index},this._updateDesiredCol();break}}}this._pendingCount="";break}case";":{if(this._changeList.length===0)this.commandLine="E664: changelist is empty",this._stickyCommandLine=!0;else if(this._changeListPos>0){this._changeListPos--;let t=this._changeList[this._changeListPos];this.cursor.row=Math.min(t.row,this.buffer.lineCount-1),this.cursor.col=Math.min(t.col,this._maxCol()),this._updateDesiredCol()}else this.commandLine="E662: At start of changelist",this._stickyCommandLine=!0;this._pendingCount="";break}case",":{if(this._changeList.length>0&&this._changeListPos<this._changeList.length-1){this._changeListPos++;let t=this._changeList[this._changeListPos];this.cursor.row=Math.min(t.row,this.buffer.lineCount-1),this.cursor.col=Math.min(t.col,this._maxCol()),this._updateDesiredCol()}this._pendingCount="";break}default:this._pendingCount="";break}}_handleZ(e){let t=Math.max(0,this.buffer.lineCount-1);switch(e){case"z":this.scrollTop=Math.max(0,Math.min(this.cursor.row-Math.floor((this._textRows-1)/2),t)),this.cursor.col=this._firstNonBlank(this.cursor.row),this._updateDesiredCol();break;case"t":this.scrollTop=Math.max(0,Math.min(this.cursor.row,t)),this.cursor.col=this._firstNonBlank(this.cursor.row),this._updateDesiredCol();break;case"b":this.scrollTop=Math.max(0,Math.min(this.cursor.row-this._textRows+1,t)),this.cursor.col=this._firstNonBlank(this.cursor.row),this._updateDesiredCol();break}}_commandKey(e){if(e==="Escape"){this.mode=p.NORMAL,this.commandLine="",this._pendingOpForSearch="",this._opStartPosForSearch=null,this._visualCmdRange=null;return}if(e==="Enter"){this._executeCommand();return}if(e==="Backspace"){this._searchInput.length>0?(this._searchInput=this._searchInput.slice(0,-1),this.commandLine=this.commandLine[0]+this._searchInput):(this.mode=p.NORMAL,this.commandLine="",this._visualCmdRange=null);return}e.length===1&&(this._searchInput+=e,this.commandLine=this.commandLine[0]+this._searchInput)}_executeCommand(){let e=this.commandLine[0],t=this._searchInput.trim();if(this.mode=p.NORMAL,e==="/"||e==="?"){if(t){this._addJumpEntry();let r=this.cursor.row,o=this.cursor.col;if(this._searchPattern=t,this._searchForward=e==="/",!this._searchNext(this._searchForward)){let c="E486: Pattern not found: "+t;c.length>=30?this._messagePrompt={error:c}:(this.commandLine=c,this._stickyCommandLine=!0),this._pendingOpForSearch="",this._opStartPosForSearch=null;return}if(this._pendingOpForSearch){let c=this._pendingOpForSearch;(this.cursor.row!==r||this.cursor.col!==o)&&(this._pendingOp=c,this._opStartPos=this._opStartPosForSearch,this._motionInclusive=!1,this._motionLinewise=!1,this._motionExclusive=!1,this._showCurSearch=!0,this._hlsearchActive=!0,this._executeOperator(this._opStartPos,{...this.cursor}),this._pendingOp=""),this._pendingOpForSearch="",this._opStartPosForSearch=null,this._showCurSearch=!0,this._hlsearchActive=!0}else this._showCurSearch=!0,this._hlsearchActive=!0,this._updateDesiredCol()}else this._pendingOpForSearch="",this._opStartPosForSearch=null;this.commandLine="";return}if(this._lastExCommand=t,/^(w(r(i(te?)?)?)?|wq|x(it?)?|q(u(it?)?)?!?)(\s|$)/.test(t)||/^e(d(it?)?)?!?(\s|$)/.test(t)||/^r(e(ad?)?)?!/.test(t)||/^r(e(ad?)?)?(\s|$)/.test(t)||t.startsWith("!")){this._lastExCommand=t,this.commandLine="";return}if(/^noh(l(s(e(a(r(c(h)?)?)?)?)?)?)?$/.test(t)){this._hlsearchActive=!1,this._showCurSearch=!1,this._curSearchPos=null,this.commandLine="";return}if(/^set?\s/.test(t)||t==="set"){this._executeSet(t),this.commandLine="";return}let s=t.match(/^(?:'<,'>\s*)?sort(!)?\s*(.*)?$/);if(s){let r=!!s[1],o=(s[2]||"").trim(),n=r,c=!1,h=!1,l=!1;for(let d of o)d==="n"?c=!0:d==="i"?l=!0:d==="u"&&(h=!0);let a=0,f=this.buffer.lineCount-1;this._visualCmdRange&&(a=this._visualCmdRange.start,f=this._visualCmdRange.end,this._visualCmdRange=null);let u=this.buffer.lines.slice(a,f+1);if(c?u.sort((d,b)=>{let C=parseFloat(d)||0,v=parseFloat(b)||0;return C-v}):l?u.sort((d,b)=>d.toLowerCase().localeCompare(b.toLowerCase())):u.sort(),n&&u.reverse(),h){let d=new Set,b=[];for(let C of u){let v=l?C.toLowerCase():C;d.has(v)||(d.add(v),b.push(C))}u.length=0,u.push(...b)}this._saveSnapshot(),this._redoStack=[],this.buffer.lines.splice(a,f-a+1,...u),this.cursor.row=a,this.cursor.col=this._firstNonBlank(a),this._updateDesiredCol();let _=u.length;this.commandLine=`${_} line${_!==1?"s":""} sorted`,this._stickyCommandLine=!0;return}this._visualCmdRange=null;let i=-1;if(t==="$")i=this.buffer.lineCount-1;else{let r=parseInt(t,10);isNaN(r)||(i=Math.max(0,Math.min(r-1,this.buffer.lineCount-1)))}if(i>=0){this.cursor.row=i,this.cursor.col=this._firstNonBlank(this.cursor.row);let r=Math.floor((this._textRows-1)/2);if(this.cursor.row<this.scrollTop)this.scrollTop-this.cursor.row>=r?this.scrollTop=Math.max(0,this.cursor.row-r):this.scrollTop=this.cursor.row;else if(this.cursor.row>=this.scrollTop+this._textRows)if(this.cursor.row-(this.scrollTop+this._textRows-1)>=r){let n=Math.max(0,this.buffer.lineCount-this._textRows);this.scrollTop=Math.min(this.cursor.row-r,n)}else this.scrollTop=this.cursor.row-this._textRows+1}this.commandLine=""}_executeSet(e){let t=e.replace(/^set?\s*/,"").split(/\s+/);for(let s of t){if(!s)continue;let i=s.match(/^no(.+)$/);if(i){let r=i[1];r in this._settings&&typeof this._settings[r]=="boolean"?this._settings[r]=!1:r==="nu"?this._settings.number=!1:r==="rnu"&&(this._settings.relativenumber=!1);continue}if(s==="nu"){this._settings.number=!0;continue}if(s==="rnu"){this._settings.relativenumber=!0;continue}if(s in this._settings&&typeof this._settings[s]=="boolean"){this._settings[s]=!0;continue}}}_insertKey(e){if(this._pendingCtrlR){this._pendingCtrlR=!1,this._saveForDot(e);let t="";if(/^[a-zA-Z0-9]$/.test(e)){let s=e.toLowerCase(),i=this._namedRegs[s];t=i?i.text:""}else e==='"'&&(t=this._unnamedReg||"");if(t){let s=t.split(`
`);for(let i=0;i<s.length;i++){i>0&&(this.buffer.splitLine(this.cursor.row,this.cursor.col),this.cursor.row++,this.cursor.col=0);for(let r of s[i])this.buffer.insertChar(this.cursor.row,this.cursor.col,r),this.cursor.col++}}return}switch(this._saveForDot(e),e){case"Escape":{if(this._insertCount>1){let t=this._recordedKeys[0],s=this._recordedKeys.slice(1),i=t==="o"||t==="O";for(let r=1;r<this._insertCount;r++){i&&this._insertKeyDirect("Enter");for(let o of s)o!=="Escape"&&this._insertKeyDirect(o)}this._insertCount=1}this._lastInsertPos={row:this.cursor.row,col:this.cursor.col},this.mode=p.NORMAL,this.commandLine="",this.cursor.col>0&&this.cursor.col--,this._stopRecording(),this._redoStack=[],this._updateDesiredCol(),this._showCurSearch&&this._updateCurSearchPos();break}case"Ctrl-J":case"Enter":this.buffer.splitLine(this.cursor.row,this.cursor.col),this.cursor.row++,this.cursor.col=0;break;case"Ctrl-H":case"Backspace":{let t=this.buffer.deleteCharBefore(this.cursor.row,this.cursor.col);this.cursor.row=t.row,this.cursor.col=t.col;break}case"Delete":{if(this.cursor.col<this.buffer.lineLength(this.cursor.row))this.buffer.deleteChar(this.cursor.row,this.cursor.col);else if(this.cursor.row<this.buffer.lineCount-1){let t=this.buffer.lines[this.cursor.row],s=this.buffer.lines[this.cursor.row+1];this.buffer.lines[this.cursor.row]=t+s,this.buffer.lines.splice(this.cursor.row+1,1)}break}case"Ctrl-W":{if(this.cursor.col===0&&this.cursor.row>0){let t=this.buffer.lines[this.cursor.row-1].length,s=this.buffer.lines[this.cursor.row];this.buffer.lines[this.cursor.row-1]+=s,this.buffer.lines.splice(this.cursor.row,1),this.cursor.row--,this.cursor.col=t}else if(this.cursor.col>0){let t=this.buffer.lines[this.cursor.row],s=this.cursor.col;for(;s>0&&(t[s-1]===" "||t[s-1]==="	");)s--;if(s>0&&this._isWordChar(t[s-1]))for(;s>0&&this._isWordChar(t[s-1]);)s--;else for(;s>0&&!this._isWordChar(t[s-1])&&t[s-1]!==" "&&t[s-1]!=="	";)s--;this.buffer.lines[this.cursor.row]=t.slice(0,s)+t.slice(this.cursor.col),this.cursor.col=s}break}case"Ctrl-U":{if(this.cursor.col>0){let t=this.buffer.lines[this.cursor.row];this.buffer.lines[this.cursor.row]=t.slice(this.cursor.col),this.cursor.col=0}else if(this.cursor.row>0){let t=this.buffer.lines[this.cursor.row-1].length,s=this.buffer.lines[this.cursor.row];this.buffer.lines[this.cursor.row-1]+=s,this.buffer.lines.splice(this.cursor.row,1),this.cursor.row--,this.cursor.col=t}break}case"ArrowLeft":this.cursor.col>0&&this.cursor.col--,this._insertCount=1;break;case"ArrowRight":this.cursor.col<this.buffer.lineLength(this.cursor.row)&&this.cursor.col++,this._insertCount=1;break;case"ArrowUp":this.cursor.row>0&&(this.cursor.row--,this.cursor.col=Math.min(this.cursor.col,this.buffer.lineLength(this.cursor.row))),this._insertCount=1;break;case"ArrowDown":this.cursor.row<this.buffer.lineCount-1&&(this.cursor.row++,this.cursor.col=Math.min(this.cursor.col,this.buffer.lineLength(this.cursor.row))),this._insertCount=1;break;case"Ctrl-R":this._pendingCtrlR=!0;return;default:e.length===1&&e>=" "&&(this.buffer.insertChar(this.cursor.row,this.cursor.col,e),this.cursor.col++);break}}_insertKeyDirect(e){switch(e){case"Ctrl-J":case"Enter":this.buffer.splitLine(this.cursor.row,this.cursor.col),this.cursor.row++,this.cursor.col=0;break;case"Ctrl-H":case"Backspace":{let t=this.buffer.deleteCharBefore(this.cursor.row,this.cursor.col);this.cursor.row=t.row,this.cursor.col=t.col;break}case"Delete":if(this.cursor.col<this.buffer.lineLength(this.cursor.row))this.buffer.deleteChar(this.cursor.row,this.cursor.col);else if(this.cursor.row<this.buffer.lineCount-1){let t=this.buffer.lines[this.cursor.row],s=this.buffer.lines[this.cursor.row+1];this.buffer.lines[this.cursor.row]=t+s,this.buffer.lines.splice(this.cursor.row+1,1)}break;case"Ctrl-W":{if(this.cursor.col===0&&this.cursor.row>0){let t=this.buffer.lines[this.cursor.row-1].length,s=this.buffer.lines[this.cursor.row];this.buffer.lines[this.cursor.row-1]+=s,this.buffer.lines.splice(this.cursor.row,1),this.cursor.row--,this.cursor.col=t}else if(this.cursor.col>0){let t=this.buffer.lines[this.cursor.row],s=this.cursor.col;for(;s>0&&(t[s-1]===" "||t[s-1]==="	");)s--;if(s>0&&this._isWordChar(t[s-1]))for(;s>0&&this._isWordChar(t[s-1]);)s--;else for(;s>0&&!this._isWordChar(t[s-1])&&t[s-1]!==" "&&t[s-1]!=="	";)s--;this.buffer.lines[this.cursor.row]=t.slice(0,s)+t.slice(this.cursor.col),this.cursor.col=s}break}case"Ctrl-U":{if(this.cursor.col>0){let t=this.buffer.lines[this.cursor.row];this.buffer.lines[this.cursor.row]=t.slice(this.cursor.col),this.cursor.col=0}else if(this.cursor.row>0){let t=this.buffer.lines[this.cursor.row-1].length,s=this.buffer.lines[this.cursor.row];this.buffer.lines[this.cursor.row-1]+=s,this.buffer.lines.splice(this.cursor.row,1),this.cursor.row--,this.cursor.col=t}break}case"ArrowLeft":this.cursor.col>0&&this.cursor.col--;break;case"ArrowRight":this.cursor.col<this.buffer.lineLength(this.cursor.row)&&this.cursor.col++;break;case"ArrowUp":this.cursor.row>0&&(this.cursor.row--,this.cursor.col=Math.min(this.cursor.col,this.buffer.lineLength(this.cursor.row)));break;case"ArrowDown":this.cursor.row<this.buffer.lineCount-1&&(this.cursor.row++,this.cursor.col=Math.min(this.cursor.col,this.buffer.lineLength(this.cursor.row)));break;default:e.length===1&&e>=" "&&(this.buffer.insertChar(this.cursor.row,this.cursor.col,e),this.cursor.col++);break}}_replaceKey(e){if(this._saveForDot(e),e==="Escape"){this.mode=p.NORMAL,this.commandLine="",this.cursor.col>0&&this.cursor.col--,this._stopRecording(),this._redoStack=[],this._updateDesiredCol();return}if(e==="Enter"||e==="Ctrl-J"){this.buffer.splitLine(this.cursor.row,this.cursor.col),this.cursor.row++,this.cursor.col=0;return}if(e==="Backspace"||e==="Ctrl-H"){if(this.cursor.col<=this._replaceStartCol)return;if(this.cursor.col--,this._replaceOrigChars&&this._replaceOrigChars.length>0){let t=this._replaceOrigChars.pop();if(t.ch===null){let s=this.buffer.lines[this.cursor.row];this.buffer.lines[this.cursor.row]=s.slice(0,this.cursor.col)+s.slice(this.cursor.col+1)}else{let s=this.buffer.lines[this.cursor.row];this.buffer.lines[this.cursor.row]=s.slice(0,this.cursor.col)+t.ch+s.slice(this.cursor.col+1)}}return}if(e.length===1&&e>=" "){let t=this.buffer.lines[this.cursor.row];this.cursor.col<t.length?(this._replaceOrigChars&&this._replaceOrigChars.push({ch:t[this.cursor.col]}),this.buffer.lines[this.cursor.row]=t.slice(0,this.cursor.col)+e+t.slice(this.cursor.col+1)):(this._replaceOrigChars&&this._replaceOrigChars.push({ch:null}),this.buffer.insertChar(this.cursor.row,this.cursor.col,e)),this.cursor.col++}}_visualKey(e){if(e>="1"&&e<="9"||e==="0"&&this._pendingCount!==""){this._pendingCount+=e;return}if(this._pendingVisualR){this._pendingVisualR=!1,this._doVisualReplace(e),this._pendingCount="";return}if(this._pendingTextObjType){let i=this._pendingTextObjType;this._pendingTextObjType=null;let r=this._getTextObject(i,e);r&&(this._visualStart={row:r.startRow,col:r.startCol},this.cursor.row=r.endRow,this.cursor.col=r.endCol-1,this.cursor.col<0&&(this.cursor.col=0)),this._pendingCount="";return}if(this._pendingF){let i=this._pendingF;this._pendingF="";let r=e==="Tab"?"	":e,o=this._getCount();this._doFindRepeat(i,r,o),this._pendingCount="";return}if(this._pendingG){this._pendingG=!1,this._handleG(e),this._pendingCount="";return}if(this._pendingDblQuote){this._pendingDblQuote=!1,/^[a-zA-Z0-9]$/.test(e)&&(this._pendingRegKey=e.toLowerCase());return}if(e==='"'){this._pendingDblQuote=!0;return}if(e===":"){this._lastVisual={mode:this.mode,start:{...this._visualStart},end:{...this.cursor}};let i=Math.min(this._visualStart.row,this.cursor.row),r=Math.max(this._visualStart.row,this.cursor.row);this._visualCmdRange={start:i,end:r,visMode:this.mode,visStart:{...this._visualStart},visEnd:{...this.cursor}},this.mode=p.COMMAND,this._searchInput="'<,'>",this.commandLine=":'<,'>",this._pendingCount="";return}if(e==="Escape"){this._lastVisual={mode:this.mode,start:{...this._visualStart},end:{...this.cursor}},this.mode=p.NORMAL,this.commandLine="",this._pendingCount="";return}if(e==="v"){this.mode===p.VISUAL?(this._lastVisual={mode:this.mode,start:{...this._visualStart},end:{...this.cursor}},this.mode=p.NORMAL,this.commandLine=""):(this.mode=p.VISUAL,this.commandLine="-- VISUAL --"),this._pendingCount="";return}if(e==="V"){this.mode===p.VISUAL_LINE?(this._lastVisual={mode:this.mode,start:{...this._visualStart},end:{...this.cursor}},this.mode=p.NORMAL,this.commandLine=""):(this.mode=p.VISUAL_LINE,this.commandLine="-- VISUAL LINE --"),this._pendingCount="";return}if(e==="o"||e==="O"){let i={...this._visualStart};this._visualStart={...this.cursor},this.cursor=i,this._pendingCount="";return}if(e==="i"||e==="a"){this._pendingTextObjType=e;return}if(e==="f"||e==="F"||e==="t"||e==="T"){this._pendingF=e;return}if(e==="g"){this._pendingG=!0;return}if(new Set(["d","c","y",">","<","~","U","u","J","p","x","s","r","Delete"]).has(e)){this._doVisualAction(e),this._pendingCount="";return}this._doMotion(e);let s=new Set([")","("]);this._visualExclusive=s.has(e)}_doVisualAction(e){this._lastVisual={mode:this.mode,start:{...this._visualStart},end:{...this.cursor}};let t,s,i,r,o=this.mode===p.VISUAL_LINE;this.mode===p.VISUAL_LINE?(t=Math.min(this._visualStart.row,this.cursor.row),i=Math.max(this._visualStart.row,this.cursor.row),s=0,r=this.buffer.lineLength(i)):this._visualStart.row<this.cursor.row||this._visualStart.row===this.cursor.row&&this._visualStart.col<=this.cursor.col?(t=this._visualStart.row,s=this._visualStart.col,i=this.cursor.row,r=this.cursor.col):(t=this.cursor.row,s=this.cursor.col,i=this._visualStart.row,r=this._visualStart.col);let n={...this.cursor};switch(this.cursor={row:t,col:s},this._saveSnapshot(),this.cursor=n,e){case"d":case"x":case"Delete":{if(this.mode===p.VISUAL_LINE){let h="";for(let a=t;a<=i;a++)h+=(a>t?`
`:"")+this.buffer.lines[a];this._setReg(h,"line");let l=this.cursor.col;this.buffer.lines.splice(t,i-t+1),this.buffer.lines.length===0&&(this.buffer.lines=[""]),this.cursor.row=Math.min(t,this.buffer.lineCount-1),this.cursor.col=Math.min(l,Math.max(0,this.buffer.lineLength(this.cursor.row)-1))}else if(s===0&&t!==i&&r>=this.buffer.lineLength(i)-1){let h="";for(let l=t;l<=i;l++)h+=(l>t?`
`:"")+this.buffer.lines[l];this._setReg(h,"line"),this.buffer.lines.splice(t,i-t+1),this.buffer.lines.length===0&&(this.buffer.lines=[""]),this.cursor.row=Math.min(t,this.buffer.lineCount-1),this.cursor.col=this._firstNonBlank(this.cursor.row)}else if(s===0&&t===i&&r>=this.buffer.lineLength(i)&&this.buffer.lineCount>1){let h=this.buffer.lines[t];this._setReg(h,"line"),this.buffer.lines.splice(t,1),this.buffer.lines.length===0&&(this.buffer.lines=[""]),this.cursor.row=Math.min(t,this.buffer.lineCount-1),this.cursor.col=this._firstNonBlank(this.cursor.row)}else this._setReg(this._extractRange(t,s,i,r),"char"),this._deleteRange(t,s,i,r),this.cursor.row=t,this.cursor.col=s;this._updateDesiredCol(),this.mode=p.NORMAL,this.commandLine="",this._redoStack=[];break}case"c":case"s":{if(this.mode===p.VISUAL_LINE){let h="";for(let l=t;l<=i;l++)h+=(l>t?`
`:"")+this.buffer.lines[l];this._setReg(h,"line"),this.buffer.lines.splice(t,i-t+1,""),this.cursor.row=t,this.cursor.col=0}else if(s===0&&r>=this.buffer.lineLength(i)&&t===i&&t<this.buffer.lineCount-1){let h=this.buffer.lines[t]+`
`;this._setReg(h,"char"),this.buffer.lines[t]=this.buffer.lines[t+1],this.buffer.lines.splice(t+1,1),this.cursor.row=t,this.cursor.col=0}else if(s===0&&r>=this.buffer.lineLength(i)&&t!==i){let h="";for(let l=t;l<=i;l++)h+=(l>t?`
`:"")+this.buffer.lines[l];this._setReg(h,"line"),this.buffer.lines.splice(t,i-t+1,""),this.cursor.row=t,this.cursor.col=0}else this._setReg(this._extractRange(t,s,i,r),"char"),this._deleteRange(t,s,i,r),this.cursor.row=t,this.cursor.col=s;this._updateDesiredCol(),this._startRecording(),this.mode=p.INSERT,this.commandLine="-- INSERT --",this._redoStack=[];break}case"y":{if(this.mode===p.VISUAL_LINE){let h="";for(let l=t;l<=i;l++)h+=(l>t?`
`:"")+this.buffer.lines[l];this._setReg(h,"line")}else this._setReg(this._extractRange(t,s,i,r),"char");this.mode=p.NORMAL,this.commandLine="",this.cursor.row=t,this.cursor.col=s;break}case">":{let h=this._desiredCol;for(let l=t;l<=i;l++)this._shiftLineRight(l);this.mode=p.NORMAL,this.commandLine="",this.cursor.row=t,this.cursor.col=this._byteColForVirtCol(t,h),this._desiredCol=this._virtColEnd(t,this.cursor.col),this._redoStack=[];break}case"<":{let h=this._desiredCol;for(let l=t;l<=i;l++)this._shiftLineLeft(l);this.mode=p.NORMAL,this.commandLine="",this.cursor.row=t,this.cursor.col=this._byteColForVirtCol(t,h),this._desiredCol=this._virtColEnd(t,this.cursor.col),this._redoStack=[];break}case"~":{for(let h=t;h<=i;h++){let l=this.buffer.lines[h],a=h===t&&this.mode===p.VISUAL?s:0,f=h===i&&this.mode===p.VISUAL?r:l.length-1,u="";for(let _=0;_<l.length;_++)if(_>=a&&_<=f){let d=l[_];u+=d===d.toUpperCase()?d.toLowerCase():d.toUpperCase()}else u+=l[_];this.buffer.lines[h]=u}this.mode=p.NORMAL,this.commandLine="",this.cursor.row=t,this.cursor.col=s,this._redoStack=[];break}case"U":{for(let h=t;h<=i;h++){let l=this.buffer.lines[h],a=h===t&&this.mode===p.VISUAL?s:0,f=h===i&&this.mode===p.VISUAL?r:l.length-1,u="";for(let _=0;_<l.length;_++)u+=_>=a&&_<=f?l[_].toUpperCase():l[_];this.buffer.lines[h]=u}this.mode=p.NORMAL,this.commandLine="",this.cursor.row=t,this.cursor.col=s,this._redoStack=[];break}case"u":{for(let h=t;h<=i;h++){let l=this.buffer.lines[h],a=h===t&&this.mode===p.VISUAL?s:0,f=h===i&&this.mode===p.VISUAL?r:l.length-1,u="";for(let _=0;_<l.length;_++)u+=_>=a&&_<=f?l[_].toLowerCase():l[_];this.buffer.lines[h]=u}this.mode=p.NORMAL,this.commandLine="",this.cursor.row=t,this.cursor.col=s,this._redoStack=[];break}case"J":{let h=0;for(let l=t;l<i;l++){let a=this.buffer.lines[t],u=this.buffer.lines[t+1].replace(/^\s+/,"");h=a.length;let _=u.length>0?u[0]:"",d=a.length>0&&(a[a.length-1]===" "||a[a.length-1]==="	"),b;a.length===0||u.length===0||_===")"||d?b=a+u:b=a+" "+u,this.buffer.lines[t]=b,this.buffer.lines.splice(t+1,1)}this.mode=p.NORMAL,this.commandLine="",this.cursor.row=t,this.cursor.col=h,this._updateDesiredCol(),this._redoStack=[];break}case"p":{if(this.mode===p.VISUAL_LINE)if(this.buffer.lines.splice(t,i-t+1),this.buffer.lines.length===0&&(this.buffer.lines=[""]),this.cursor.row=Math.min(t,this.buffer.lineCount-1),this._regType==="line"){let h=this._unnamedReg.split(`
`);this.buffer.lines.splice(t,0,...h)}else this.buffer.lines.splice(t,0,this._unnamedReg);else{this._deleteRange(t,s,i,r),this.cursor.row=t,this.cursor.col=s;let h=this._unnamedReg;if(h){let l=this.buffer.lines[t].slice(0,s),a=this.buffer.lines[t].slice(s),f=h.split(`
`);if(f.length===1)this.buffer.lines[t]=l+h+a,this.cursor.col=s+h.length-1;else{this.buffer.lines[t]=l+f[0];for(let _=1;_<f.length-1;_++)this.buffer.lines.splice(t+_,0,f[_]);let u=t+f.length-1;this.buffer.lines.splice(u,0,f[f.length-1]+a),this.cursor.row=u,this.cursor.col=f[f.length-1].length-1}}}this.mode=p.NORMAL,this.commandLine="",this._redoStack=[];break}case"r":{this._pendingVisualR=!0;return}}if(!new Set(["y","r","p"]).has(e)){let h=[];if(o){h.push("V");let l=i-t+1;if(l>1){for(let a of String(l-1))h.push(a);h.push("j")}}else if(h.push("v"),t===i){let l=r-s;if(l>0){for(let a of String(l))h.push(a);h.push("l")}}else{for(let l of String(i-t))h.push(l);h.push("j")}e==="c"||e==="s"?this._dotPrefix=h.concat([e]):(h.push(e),this._lastChange=h)}}_doVisualReplace(e){let t,s,i,r;this.mode===p.VISUAL_LINE?(t=Math.min(this._visualStart.row,this.cursor.row),i=Math.max(this._visualStart.row,this.cursor.row),s=0,r=this.buffer.lineLength(i)):this._visualStart.row<this.cursor.row||this._visualStart.row===this.cursor.row&&this._visualStart.col<=this.cursor.col?(t=this._visualStart.row,s=this._visualStart.col,i=this.cursor.row,r=this.cursor.col):(t=this.cursor.row,s=this.cursor.col,i=this._visualStart.row,r=this._visualStart.col),this._saveSnapshot();for(let o=t;o<=i;o++){let n=this.buffer.lines[o],c=this.mode===p.VISUAL_LINE?0:o===t?s:0,h=this.mode===p.VISUAL_LINE?n.length-1:o===i?r:n.length-1,l="";for(let a=0;a<n.length;a++)l+=a>=c&&a<=h?e:n[a];this.buffer.lines[o]=l}this.cursor.row=t,this.cursor.col=s,this._updateDesiredCol(),this.mode=p.NORMAL,this.commandLine="",this._redoStack=[]}_doMotion(e){let t=this.cursor.row,s=this.cursor.col,i=new Set(["e","E","$","G","%","H","M","L",";",","]);switch(this._motionInclusive=i.has(e),e){case"h":case"ArrowLeft":case"Backspace":{let r=this._getCount();for(let o=0;o<r;o++)this.cursor.col>0&&this.cursor.col--;this._updateDesiredCol();break}case"l":case"ArrowRight":case" ":{let r=this._getCount();for(let o=0;o<r;o++)this.cursor.col<this._maxCol()&&this.cursor.col++;this._updateDesiredCol();break}case"j":case"ArrowDown":{let r=this._getCount(),o=this.cursor.row;for(let n=0;n<r;n++)this.cursor.row<this.buffer.lineCount-1&&this.cursor.row++;this._applyDesiredCol(),this.cursor.row!==o&&(this._motionLinewise=!0);break}case"k":case"ArrowUp":{let r=this._getCount(),o=this.cursor.row;for(let n=0;n<r;n++)this.cursor.row>0&&this.cursor.row--;this._applyDesiredCol(),this.cursor.row!==o&&(this._motionLinewise=!0);break}case"w":{let r=this._getCount();for(let o=0;o<r;o++)this._moveWordForward(!1);this._updateDesiredCol();break}case"W":{let r=this._getCount();for(let o=0;o<r;o++)this._moveWordForward(!0);this._updateDesiredCol();break}case"b":{let r=this._getCount();for(let o=0;o<r;o++)this._moveWordBackward(!1);this._updateDesiredCol();break}case"B":{let r=this._getCount();for(let o=0;o<r;o++)this._moveWordBackward(!0);this._updateDesiredCol();break}case"e":{let r=this._getCount();for(let o=0;o<r;o++)this._moveWordEnd(!1);this._updateDesiredCol();break}case"E":{let r=this._getCount();for(let o=0;o<r;o++)this._moveWordEnd(!0);this._updateDesiredCol();break}case"0":this.cursor.col=0,this._desiredCol=0;break;case"^":this.cursor.col=this._firstNonBlank(this.cursor.row),this._updateDesiredCol();break;case"$":{let r=this._getCount();r>1&&(this.cursor.row=Math.min(this.cursor.row+r-1,this.buffer.lineCount-1)),this.mode===p.VISUAL||this.mode===p.VISUAL_LINE?this.cursor.col=this.buffer.lineLength(this.cursor.row):this.cursor.col=this._maxCol(),this._desiredCol=1/0;break}case"G":{if(this._hasCount()){let r=this._getCount();this.cursor.row=Math.max(0,Math.min(r-1,this.buffer.lineCount-1)),this.cursor.col=0}else this.cursor.row=this.buffer.lineCount-1,this._applyDesiredCol();this._updateDesiredCol(),this._motionLinewise=!0;break}case"{":{let r=this._getCount(),o={row:this.cursor.row,col:this.cursor.col},n=!0;for(let c=0;c<r;c++)if(!this._moveParagraphBackward()){n=!1;break}n||(this.cursor.row=o.row,this.cursor.col=o.col),this._updateDesiredCol(),this._motionLinewise=!0,this._motionExclusive=!0;break}case"}":{let r=this._getCount(),o={row:this.cursor.row,col:this.cursor.col},n=!0;for(let c=0;c<r;c++)if(!this._moveParagraphForward()){n=!1;break}n||(this.cursor.row=o.row,this.cursor.col=o.col),this._updateDesiredCol(),this._motionLinewise=!0,this._motionExclusive=!0;break}case"%":this._hasCount()||this._doMatchBracket();break;case"H":{let r=this._getCount()-1;this.cursor.row=Math.min(this.scrollTop+r,this.buffer.lineCount-1),this.cursor.col=this._byteColForVirtCol(this.cursor.row,this._desiredCol),this._motionLinewise=!0;break}case"M":{let r=Math.min(this._textRows,this.buffer.lineCount-this.scrollTop);this.cursor.row=this.scrollTop+Math.floor((r-1)/2),this.cursor.col=this._byteColForVirtCol(this.cursor.row,this._desiredCol),this._motionLinewise=!0;break}case"L":{let r=this._getCount()-1,o=this.scrollTop+Math.min(this._textRows,this.buffer.lineCount-this.scrollTop)-1;this.cursor.row=Math.max(this.scrollTop,o-r),this.cursor.col=this._byteColForVirtCol(this.cursor.row,this._desiredCol),this._motionLinewise=!0;break}case";":{if(this._lastFind){let r=this._getCount();this._doFindRepeat(this._lastFind.type,this._lastFind.char,r),this.cursor.row===t&&this.cursor.col===s&&(this._motionInclusive=!1)}break}case",":{if(this._lastFind){let r=this._getCount(),o={f:"F",F:"f",t:"T",T:"t"}[this._lastFind.type];this._doFindRepeat(o,this._lastFind.char,r),this.cursor.row===t&&this.cursor.col===s&&(this._motionInclusive=!1)}break}case"n":{let r=this._getCount();for(let o=0;o<r;o++)this._searchNext(this._searchForward);this._showCurSearch=!0,this._hlsearchActive=!0;break}case"N":{let r=this._getCount();for(let o=0;o<r;o++)this._searchNext(!this._searchForward);this._showCurSearch=!0,this._hlsearchActive=!0;break}case"*":{let r=this._wordUnderCursor();r&&(this._searchPattern="\\b"+r+"\\b",this._searchForward=!0,this._searchNext(!0),this._showCurSearch=!0,this._hlsearchActive=!0);break}case"#":{let r=this._wordUnderCursor();r&&(this._searchPattern="\\b"+r+"\\b",this._searchForward=!1,this._searchNext(!1),this._showCurSearch=!0,this._hlsearchActive=!0);break}case"+":case"Enter":{let r=this._getCount();this.cursor.row=Math.min(this.cursor.row+r,this.buffer.lineCount-1),this.cursor.col=this._firstNonBlank(this.cursor.row),this._updateDesiredCol(),this._motionLinewise=!0;break}case"-":{let r=this._getCount();this.cursor.row=Math.max(this.cursor.row-r,0),this.cursor.col=this._firstNonBlank(this.cursor.row),this._updateDesiredCol(),this._motionLinewise=!0;break}case"_":{let r=this._getCount();this.cursor.row=Math.min(this.cursor.row+r-1,this.buffer.lineCount-1),this.cursor.col=this._firstNonBlank(this.cursor.row),this._updateDesiredCol(),this._motionLinewise=!0;break}case"g_":{let r=this._getCount();r>1&&(this.cursor.row=Math.min(this.cursor.row+r-1,this.buffer.lineCount-1)),this.cursor.col=this._lastNonBlank(this.cursor.row),this._updateDesiredCol(),this._motionInclusive=!0;break}case"|":{let r=this._getCount()-1;this.cursor.col=this._byteColForVirtCol(this.cursor.row,r),this._updateDesiredCol();break}case")":{let r=this._getCount();for(let o=0;o<r;o++)this._moveSentenceForward();this._updateDesiredCol();break}case"(":{let r=this._getCount();for(let o=0;o<r;o++)this._moveSentenceBackward();this._updateDesiredCol();break}default:return!1}return this.cursor.row!==t||this.cursor.col!==s}_executeOperator(e,t){let s=this._pendingOp,i=e.row,r=e.col,o=t.row,n=t.col,c=this._motionLinewise,h=o<i||o===i&&n<r;if(h&&([i,r,o,n]=[o,n,i,r]),!c&&!this._motionInclusive&&n===0&&o>i&&(o--,n=this.buffer.lineLength(o)>0?this.buffer.lineLength(o)-1:0,this._motionInclusive=!0,r===0&&n>=(this.buffer.lineLength(o)>0?this.buffer.lineLength(o)-1:0)&&s!=="y"&&(c=!0,this._motionLinewise=!0)),c&&this._motionExclusive&&((h||o<this.buffer.lineCount-1)&&o--,i>o)){s==="c"&&(this.cursor.row=this._opStartPos.row,this.cursor.col=this._opStartPos.col,this._saveSnapshot(),this._startRecording(),this.mode=p.INSERT,this.commandLine="-- INSERT --",this._redoStack=[]),this._motionLinewise=!1,this._motionInclusive=!1,this._motionExclusive=!1;return}let l=this._motionInclusive,a;c?a=n:l&&!h?a=n+1:a=n;let f={...this.cursor};switch(this.cursor={...this._opStartPos},this._saveSnapshot(),this.cursor=f,s){case"d":{if(c){let u="";for(let _=i;_<=o;_++)u+=(_>i?`
`:"")+this.buffer.lines[_];this._setReg(u,"line"),this.buffer.lines.splice(i,o-i+1),this.buffer.lines.length===0&&(this.buffer.lines=[""]),this.cursor.row=Math.min(i,this.buffer.lineCount-1),this.cursor.col=this._firstNonBlank(this.cursor.row)}else if(i===o)this._setReg(this.buffer.lines[i].slice(r,a),"char"),this.buffer.lines[i]=this.buffer.lines[i].slice(0,r)+this.buffer.lines[i].slice(a),this.cursor.row=i,this.cursor.col=Math.min(r,Math.max(0,this.buffer.lines[i].length-1));else{let u=this.buffer.lines[i].slice(r);for(let d=i+1;d<o;d++)u+=`
`+this.buffer.lines[d];u+=`
`+this.buffer.lines[o].slice(0,a),this._setReg(u,"char");let _=this.buffer.lines[i].slice(0,r)+this.buffer.lines[o].slice(a);this.buffer.lines.splice(i,o-i+1,_),this.cursor.row=i,this.cursor.col=Math.min(r,Math.max(0,this.buffer.lines[i].length-1))}this._startRecording(),this._stopRecording(),this._redoStack=[];break}case"c":{if(c){let u="";for(let _=i;_<=o;_++)u+=(_>i?`
`:"")+this.buffer.lines[_];this._setReg(u,"line"),this.buffer.lines.splice(i,o-i+1,""),this.cursor.row=i,this.cursor.col=0}else if(i===o)this._setReg(this.buffer.lines[i].slice(r,a),"char"),this.buffer.lines[i]=this.buffer.lines[i].slice(0,r)+this.buffer.lines[i].slice(a),this.cursor.row=i,this.cursor.col=r;else{let u=this.buffer.lines[i].slice(r);for(let d=i+1;d<o;d++)u+=`
`+this.buffer.lines[d];u+=`
`+this.buffer.lines[o].slice(0,a),this._setReg(u,"char");let _=this.buffer.lines[i].slice(0,r)+this.buffer.lines[o].slice(a);this.buffer.lines.splice(i,o-i+1,_),this.cursor.row=i,this.cursor.col=r}this._startRecording(),this.mode=p.INSERT,this.commandLine="-- INSERT --",this._redoStack=[];break}case"y":{if(c){let u="";for(let _=i;_<=o;_++)u+=(_>i?`
`:"")+this.buffer.lines[_];this._setReg(u,"line")}else this._setReg(this.buffer.lines[i].slice(r,a),"char");this.cursor.row=i,this.cursor.col=r;break}case">":{let u=this._desiredCol;for(let _=i;_<=o;_++)this._shiftLineRight(_);this.cursor.row=i,this.cursor.col=this._byteColForVirtCol(i,u),this._desiredCol=this._virtColEnd(i,this.cursor.col),this._redoStack=[];break}case"<":{let u=this._desiredCol;for(let _=i;_<=o;_++)this._shiftLineLeft(_);this.cursor.row=i,this.cursor.col=this._byteColForVirtCol(i,u),this._desiredCol=this._virtColEnd(i,this.cursor.col),this._redoStack=[];break}case"gu":{if(c)for(let u=i;u<=o;u++)this.buffer.lines[u]=this.buffer.lines[u].toLowerCase();else{let u=this.buffer.lines[i];this.buffer.lines[i]=u.slice(0,r)+u.slice(r,a).toLowerCase()+u.slice(a)}this.cursor.row=i,this.cursor.col=r,this._redoStack=[];break}case"gU":{if(c)for(let u=i;u<=o;u++)this.buffer.lines[u]=this.buffer.lines[u].toUpperCase();else{let u=this.buffer.lines[i];this.buffer.lines[i]=u.slice(0,r)+u.slice(r,a).toUpperCase()+u.slice(a)}this.cursor.row=i,this.cursor.col=r,this._redoStack=[];break}case"g~":{let u=_=>[..._].map(d=>d===d.toUpperCase()?d.toLowerCase():d.toUpperCase()).join("");if(c)for(let _=i;_<=o;_++)this.buffer.lines[_]=u(this.buffer.lines[_]);else{let _=this.buffer.lines[i];this.buffer.lines[i]=_.slice(0,r)+u(_.slice(r,a))+_.slice(a)}this.cursor.row=i,this.cursor.col=r,this._redoStack=[];break}}this._updateDesiredCol(),s==="y"?(this._showCurSearch=!1,this._curSearchPos=null):this._showCurSearch&&this._searchPattern&&this._updateCurSearchPos()}_updateCurSearchPos(){if(this._searchPattern)try{let e=new RegExp(this._searchPattern),t=this.buffer.lines[this.cursor.row]||"",s=t.slice(this.cursor.col).match(e);if(s)this._curSearchPos={row:this.cursor.row,col:this.cursor.col+s.index};else{let i=t.match(e);i?this._curSearchPos={row:this.cursor.row,col:i.index}:this._curSearchPos=null}}catch{this._curSearchPos=null}}_executeOperatorRange(e){let t=this._pendingOp;if(this._saveSnapshot(),e.linewise){let{startRow:n,endRow:c}=e;switch(t){case"d":{let h="";for(let l=n;l<=c;l++)h+=(l>n?`
`:"")+this.buffer.lines[l];this._setReg(h,"line"),this.buffer.lines.splice(n,c-n+1),this.buffer.lines.length===0&&(this.buffer.lines=[""]),this.cursor.row=Math.min(n,this.buffer.lineCount-1),this.cursor.col=this._firstNonBlank(this.cursor.row),this._startRecording(),this._stopRecording(),this._redoStack=[];break}case"c":{let h="";for(let l=n;l<=c;l++)h+=(l>n?`
`:"")+this.buffer.lines[l];this._setReg(h,"line"),this.buffer.lines.splice(n,c-n+1,""),this.cursor.row=n,this.cursor.col=0,this._startRecording(),this.mode=p.INSERT,this.commandLine="-- INSERT --",this._redoStack=[];break}case"y":{let h="";for(let l=n;l<=c;l++)h+=(l>n?`
`:"")+this.buffer.lines[l];this._setReg(h,"line"),this.cursor.row=n,this.cursor.col=this._firstNonBlank(n);break}}this._updateDesiredCol();return}let{startRow:s,startCol:i,endRow:r,endCol:o}=e;switch(t){case"d":{if(s!==r){let n=this.buffer.lines[s].slice(i);for(let c=s+1;c<r;c++)n+=`
`+this.buffer.lines[c];n+=`
`+this.buffer.lines[r].slice(0,o),this._setReg(n,"char"),this._deleteRange(s,i,r,o-1)}else this._setReg(this.buffer.lines[s].slice(i,o),"char"),this.buffer.lines[s]=this.buffer.lines[s].slice(0,i)+this.buffer.lines[s].slice(o);this.cursor.row=s,this.cursor.col=i,this._startRecording(),this._stopRecording(),this._redoStack=[];break}case"c":{if(e.multilineInner){let n=this.buffer.lines[s].match(/^(\s*)/)[1];this.buffer.lines.splice(s,r-s,n),this.cursor.row=s,this.cursor.col=n.length}else if(s!==r)this._deleteRange(s,i,r,o-1),this.cursor.row=s,this.cursor.col=i;else{let n=this.buffer.lines[s];this.buffer.lines[s]=n.slice(0,i)+n.slice(o),this.cursor.row=s,this.cursor.col=i}this._startRecording(),this.mode=p.INSERT,this.commandLine="-- INSERT --",this._redoStack=[];break}case"y":{if(s!==r){let n=this.buffer.lines[s].slice(i);for(let c=s+1;c<r;c++)n+=`
`+this.buffer.lines[c];n+=`
`+this.buffer.lines[r].slice(0,o),this._setReg(n,"char")}else this._setReg(this.buffer.lines[s].slice(i,o),"char");break}case"gu":{if(s===r){let n=this.buffer.lines[s];this.buffer.lines[s]=n.slice(0,i)+n.slice(i,o).toLowerCase()+n.slice(o)}else{let n=this.buffer.lines[s];this.buffer.lines[s]=n.slice(0,i)+n.slice(i).toLowerCase();for(let h=s+1;h<r;h++)this.buffer.lines[h]=this.buffer.lines[h].toLowerCase();let c=this.buffer.lines[r];this.buffer.lines[r]=c.slice(0,o).toLowerCase()+c.slice(o)}this.cursor.row=s,this.cursor.col=i,this._redoStack=[];break}case"gU":{if(s===r){let n=this.buffer.lines[s];this.buffer.lines[s]=n.slice(0,i)+n.slice(i,o).toUpperCase()+n.slice(o)}else{let n=this.buffer.lines[s];this.buffer.lines[s]=n.slice(0,i)+n.slice(i).toUpperCase();for(let h=s+1;h<r;h++)this.buffer.lines[h]=this.buffer.lines[h].toUpperCase();let c=this.buffer.lines[r];this.buffer.lines[r]=c.slice(0,o).toUpperCase()+c.slice(o)}this.cursor.row=s,this.cursor.col=i,this._redoStack=[];break}case"g~":{let n=c=>[...c].map(h=>h===h.toUpperCase()?h.toLowerCase():h.toUpperCase()).join("");if(s===r){let c=this.buffer.lines[s];this.buffer.lines[s]=c.slice(0,i)+n(c.slice(i,o))+c.slice(o)}else{let c=this.buffer.lines[s];this.buffer.lines[s]=c.slice(0,i)+n(c.slice(i));for(let l=s+1;l<r;l++)this.buffer.lines[l]=n(this.buffer.lines[l]);let h=this.buffer.lines[r];this.buffer.lines[r]=n(h.slice(0,o))+h.slice(o)}this.cursor.row=s,this.cursor.col=i,this._redoStack=[];break}}this._updateDesiredCol()}_doLineOperation(e,t){let s=this.cursor.row;if(s===this.buffer.lineCount-1&&t>1)return;let i=Math.min(s+t-1,this.buffer.lineCount-1);switch(this._saveSnapshot(),e){case"d":{let r="";for(let o=s;o<=i;o++)r+=(o>s?`
`:"")+this.buffer.lines[o];this._setReg(r,"line"),this.buffer.lines.splice(s,i-s+1),this.buffer.lines.length===0&&(this.buffer.lines=[""]),this.cursor.row=Math.min(s,this.buffer.lineCount-1),this.cursor.col=this._firstNonBlank(this.cursor.row),this._startRecording(),this._stopRecording(),this._redoStack=[];break}case"c":{let r="";for(let n=s;n<=i;n++)r+=(n>s?`
`:"")+this.buffer.lines[n];this._setReg(r,"line");let o=this.buffer.lines[s].match(/^\s*/)[0];this.buffer.lines.splice(s,i-s+1,o),this.cursor.row=s,this.cursor.col=o.length,this._startRecording(),this.mode=p.INSERT,this.commandLine="-- INSERT --",this._redoStack=[];break}case"y":{let r="";for(let o=s;o<=i;o++)r+=(o>s?`
`:"")+this.buffer.lines[o];this._setReg(r,"line");break}case">":{let r=this._desiredCol;for(let o=s;o<=i;o++)this._shiftLineRight(o);this.cursor.col=this._byteColForVirtCol(s,r),this._desiredCol=this._virtColEnd(s,this.cursor.col),this._undoStack[this._undoStack.length-1].redoCursor={...this.cursor},this._redoStack=[];break}case"<":{let r=this._desiredCol;for(let o=s;o<=i;o++)this._shiftLineLeft(o);this.cursor.col=this._byteColForVirtCol(s,r),this._desiredCol=this._virtColEnd(s,this.cursor.col),this._redoStack=[];break}case"gu":{for(let r=s;r<=i;r++)this.buffer.lines[r]=this.buffer.lines[r].toLowerCase();this.cursor.col=this._firstNonBlank(this.cursor.row),this._redoStack=[];break}case"gU":{for(let r=s;r<=i;r++)this.buffer.lines[r]=this.buffer.lines[r].toUpperCase();this.cursor.col=this._firstNonBlank(this.cursor.row),this._redoStack=[];break}case"g~":{let r=o=>[...o].map(n=>n===n.toUpperCase()?n.toLowerCase():n.toUpperCase()).join("");for(let o=s;o<=i;o++)this.buffer.lines[o]=r(this.buffer.lines[o]);this.cursor.col=this._firstNonBlank(this.cursor.row),this._redoStack=[];break}}e!==">"&&e!=="<"&&this._updateDesiredCol(),this._pendingOp=""}_isWordChar(e){return/[a-zA-Z0-9_]/.test(e)}_moveWordForward(e){let{row:t,col:s}=this.cursor,i=this.buffer.lines;if(t>=i.length)return;let r=i[t];if(s>=r.length){if(t<i.length-1){if(t++,s=0,i[t].length===0){this.cursor.row=t,this.cursor.col=0;return}for(;s<i[t].length&&(i[t][s]===" "||i[t][s]==="	");)s++;if(s>=i[t].length&&t<i.length-1){if(t++,s=0,i[t].length===0){this.cursor.row=t,this.cursor.col=0;return}for(;s<i[t].length&&(i[t][s]===" "||i[t][s]==="	");)s++}}this.cursor.row=t,this.cursor.col=s;return}if(e){for(;s<r.length&&r[s]!==" "&&r[s]!=="	";)s++;for(;s<r.length&&(r[s]===" "||r[s]==="	");)s++}else{let o=r[s];if(this._isWordChar(o))for(;s<r.length&&this._isWordChar(r[s]);)s++;else if(o!==" "&&o!=="	")for(;s<r.length&&!this._isWordChar(r[s])&&r[s]!==" "&&r[s]!=="	";)s++;for(;s<r.length&&(r[s]===" "||r[s]==="	");)s++}if(s>=r.length&&t<i.length-1){if(t++,s=0,i[t].length===0){this.cursor.row=t,this.cursor.col=0;return}for(;s<i[t].length&&(i[t][s]===" "||i[t][s]==="	");)s++;if(s>=i[t].length&&t<i.length-1){if(t++,s=0,i[t].length===0){this.cursor.row=t,this.cursor.col=0;return}for(;s<i[t].length&&(i[t][s]===" "||i[t][s]==="	");)s++}}this.cursor.row=t,this.cursor.col=s}_moveWordBackward(e){let{row:t,col:s}=this.cursor,i=this.buffer.lines;if(s===0)if(t>0){if(t--,i[t].length===0){this.cursor.row=t,this.cursor.col=0;return}for(s=Math.max(0,i[t].length-1);s>0&&(i[t][s]===" "||i[t][s]==="	");)s--;if(s===0&&i[t].length>0&&(i[t][0]===" "||i[t][0]==="	"))for(t>0&&(t--,s=Math.max(0,i[t].length-1));s>0&&(i[t][s]===" "||i[t][s]==="	");)s--}else return;else s--;let r=i[t];if(e){for(;s>0&&(r[s]===" "||r[s]==="	");)s--;for(;s>0&&r[s-1]!==" "&&r[s-1]!=="	";)s--}else{for(;s>0&&(r[s]===" "||r[s]==="	");)s--;if(s>=0&&s<r.length){if(this._isWordChar(r[s]))for(;s>0&&this._isWordChar(r[s-1]);)s--;else if(r[s]!==" "&&r[s]!=="	")for(;s>0&&!this._isWordChar(r[s-1])&&r[s-1]!==" "&&r[s-1]!=="	";)s--}}this.cursor.row=t,this.cursor.col=Math.max(0,s)}_moveWordEnd(e){let{row:t,col:s}=this.cursor,i=this.buffer.lines;if(s++,s>=i[t].length)if(t<i.length-1)for(t++,s=0;t<i.length-1&&i[t].length===0;)t++;else{s=Math.max(0,i[t].length-1),this.cursor.row=t,this.cursor.col=s;return}for(;t<i.length;){for(;s<i[t].length&&(i[t][s]===" "||i[t][s]==="	");)s++;if(s<i[t].length)break;if(t<i.length-1)for(t++,s=0;t<i.length-1&&i[t].length===0;)t++;else break}let r=i[t];if(e)for(;s+1<r.length&&r[s+1]!==" "&&r[s+1]!=="	";)s++;else if(s<r.length&&this._isWordChar(r[s]))for(;s+1<r.length&&this._isWordChar(r[s+1]);)s++;else if(s<r.length)for(;s+1<r.length&&!this._isWordChar(r[s+1])&&r[s+1]!==" "&&r[s+1]!=="	";)s++;this.cursor.row=t,this.cursor.col=Math.min(s,Math.max(0,i[t].length-1))}_moveWordEndBackward(e){let{row:t,col:s}=this.cursor,i=this.buffer.lines,r=(a,f)=>{if(a<0||a>=i.length)return-1;let u=i[a];if(u.length===0)return 0;if(f<0||f>=u.length)return-1;let _=u[f];return _===" "||_==="	"?1:e||this._isWordChar(_)?2:3},o=!1;if(s--,s<0){if(t--,t<0){this.cursor.col=0;return}if(o=!0,i[t].length===0){this.cursor.row=t,this.cursor.col=0;return}s=i[t].length-1}for(;;){if(t<0){this.cursor.row=0,this.cursor.col=0;return}if(i[t].length===0){this.cursor.row=t,this.cursor.col=0;return}if(r(t,s)===1){if(o=!1,s--,s<0){if(t--,t<0){this.cursor.row=0,this.cursor.col=0;return}s=Math.max(0,i[t].length-1),o=!0}continue}break}if(o){this.cursor.row=t,this.cursor.col=s;return}let n=r(t,s),c=t,h=s+1;if(h>=i[c].length&&(c++,h=0),r(c,h)===n){for(;s>0&&r(t,s-1)===n;)s--;if(s===0&&r(t,0)===n){if(t--,t<0){this.cursor.row=0,this.cursor.col=0;return}if(i[t].length===0){this.cursor.row=t,this.cursor.col=0;return}s=i[t].length-1}else s--;for(;;){if(t<0){this.cursor.row=0,this.cursor.col=0;return}if(i[t].length===0){this.cursor.row=t,this.cursor.col=0;return}if(r(t,s)===1){if(s--,s<0){if(t--,t<0){this.cursor.row=0,this.cursor.col=0;return}s=Math.max(0,i[t].length-1)}continue}break}}this.cursor.row=t,this.cursor.col=Math.max(0,s)}_doFind(e,t){let s=this.buffer.lines[this.cursor.row],i=this.cursor.col;switch(e){case"f":{let r=s.indexOf(t,i+1);r!==-1&&(this.cursor.col=r);break}case"F":{let r=s.lastIndexOf(t,i-1);r!==-1&&(this.cursor.col=r);break}case"t":{let r=s.indexOf(t,i+1);(r>i+1||r===i+1)&&(this.cursor.col=r-1);break}case"T":{let r=s.lastIndexOf(t,i-1);(r!==-1&&r<i-1||r===i-1)&&(this.cursor.col=r+1);break}}}_doFindRepeat(e,t,s){let i=this.cursor.col,r=!1;if(e==="t"||e==="T"){let o=e==="t"?"f":"F",n=e==="t"?1:-1;this.cursor.col+=n;for(let c=0;c<s-1;c++){let h=this.cursor.col;if(this._doFind(o,t),this.cursor.col===h){r=!0;break}}if(!r){let c=this.cursor.col;this._doFind(o,t),this.cursor.col===c?r=!0:this.cursor.col-=n}}else for(let o=0;o<s;o++){let n=this.cursor.col;if(this._doFind(e,t),this.cursor.col===n){r=!0;break}}r&&(this.cursor.col=i)}_doMatchBracket(){let e={"(":")",")":"(","{":"}","}":"{","[":"]","]":"["},t=new Set(["(","{","["]),s=this.buffer.lines[this.cursor.row],i=this.cursor.col;for(;i<s.length&&!e[s[i]];)i++;if(i>=s.length)return;let r=s[i],o=e[r],n=t.has(r),c=n?1:-1,h=1,l=this.cursor.row,a=i+c;for(;h>0;){if(a<0||a>=this.buffer.lines[l].length){if(l+=c,l<0||l>=this.buffer.lineCount)return;a=c>0?0:this.buffer.lines[l].length-1;continue}let f=this.buffer.lines[l][a];if(f===r?h++:f===o&&h--,h===0){this.cursor.row=l,this.cursor.col=a;return}a+=c}}_moveParagraphForward(){let e=this.cursor.row,t=this.cursor.col,s=this.cursor.row,i=this.buffer.lineCount;if(this.buffer.lines[s]==="")for(;s<i&&this.buffer.lines[s]==="";)s++;for(;s<i&&this.buffer.lines[s]!=="";)s++;if(s<i)this.cursor.row=s,this.cursor.col=0;else{let r=i-1,o=this.buffer.lines[r];this.cursor.row=r,this.cursor.col=o.length>0?o.length-1:0}return this.cursor.row!==e||this.cursor.col!==t}_moveParagraphBackward(){let e=this.cursor.row,t=this.cursor.col,s=this.cursor.row;if(this.buffer.lines[s]==="")for(;s>0&&this.buffer.lines[s]==="";)s--;for(;s>0&&this.buffer.lines[s]!=="";)s--;return this.buffer.lines[s]===""?(this.cursor.row=s,this.cursor.col=0):(this.cursor.row=0,this.cursor.col=0),this.cursor.row!==e||this.cursor.col!==t}_searchNext(e){if(!this._searchPattern)return!1;let t;try{t=new RegExp(this._searchPattern)}catch{return!1}let s=this.cursor.row,i=this.cursor.col,r=this.buffer.lineCount;if(e)for(let o=0;o<=r;o++){let n=(s+o)%r,c=n===s&&o===0?i+1:0,l=this.buffer.lines[n].slice(c).match(t);if(l)return this.cursor.row=n,this.cursor.col=c+l.index,this._curSearchPos={row:n,col:c+l.index},!0}else for(let o=0;o<=r;o++){let n=(s-o+r)%r,c=n===s&&o===0?i:this.buffer.lines[n].length,h=this.buffer.lines[n].slice(0,c),l=null,a,f=new RegExp(this._searchPattern,"g");for(;(a=f.exec(h))!==null;)l=a;if(l)return this.cursor.row=n,this.cursor.col=l.index,this._curSearchPos={row:n,col:l.index},!0}return!1}_wordUnderCursor(){let e=this.buffer.lines[this.cursor.row],t=this.cursor.col,s=this.cursor.col;for(;t>0&&this._isWordChar(e[t-1]);)t--;for(;s<e.length&&this._isWordChar(e[s]);)s++;return t===s?null:e.slice(t,s)}_getTextObject(e,t){let s=e==="i";switch(t){case"w":return this._textObjWord(s,!1);case"W":return this._textObjWord(s,!0);case'"':return this._textObjQuote('"',s);case"'":return this._textObjQuote("'",s);case"`":return this._textObjQuote("`",s);case"(":case")":case"b":return this._textObjPair("(",")",s);case"{":case"}":case"B":return this._textObjPair("{","}",s);case"[":case"]":return this._textObjPair("[","]",s);case"<":case">":return this._textObjPair("<",">",s);case"p":return this._textObjParagraph(s);case"s":return this._textObjSentence(s);default:return null}}_textObjWord(e,t){let s=this.buffer.lines[this.cursor.row],i=this.cursor.col,r=this.cursor.col,o=c=>c===" "||c==="	",n=o(s[i]);if(t)if(n){for(;i>0&&o(s[i-1]);)i--;for(;r<s.length-1&&o(s[r+1]);)r++}else{for(;i>0&&!o(s[i-1]);)i--;for(;r<s.length-1&&!o(s[r+1]);)r++}else if(this._isWordChar(s[i])){for(;i>0&&this._isWordChar(s[i-1]);)i--;for(;r<s.length-1&&this._isWordChar(s[r+1]);)r++}else if(o(s[i])){for(;i>0&&o(s[i-1]);)i--;for(;r<s.length-1&&o(s[r+1]);)r++}else{for(;i>0&&!this._isWordChar(s[i-1])&&!o(s[i-1]);)i--;for(;r<s.length-1&&!this._isWordChar(s[r+1])&&!o(s[r+1]);)r++}if(!e)if(n){if(r+1<s.length)if(t)for(;r+1<s.length&&!o(s[r+1]);)r++;else if(this._isWordChar(s[r+1]))for(;r+1<s.length&&this._isWordChar(s[r+1]);)r++;else for(;r+1<s.length&&!this._isWordChar(s[r+1])&&!o(s[r+1]);)r++;else if(i>0)if(t)for(;i>0&&!o(s[i-1]);)i--;else if(this._isWordChar(s[i-1]))for(;i>0&&this._isWordChar(s[i-1]);)i--;else for(;i>0&&!this._isWordChar(s[i-1])&&!o(s[i-1]);)i--}else if(r+1<s.length&&o(s[r+1]))for(;r+1<s.length&&o(s[r+1]);)r++;else for(;i>0&&o(s[i-1]);)i--;return{startRow:this.cursor.row,startCol:i,endRow:this.cursor.row,endCol:r+1}}_textObjQuote(e,t){let s=this.buffer.lines[this.cursor.row],i=[];for(let h=0;h<s.length;h++)s[h]===e&&(h===0||s[h-1]!=="\\")&&i.push(h);let r=-1,o=-1;for(let h=0;h<i.length-1;h+=2)if(i[h]<=this.cursor.col&&i[h+1]>=this.cursor.col){r=i[h],o=i[h+1];break}if(r===-1){for(let h=0;h<i.length-1;h+=2)if(i[h]>this.cursor.col){r=i[h],o=i[h+1];break}}if(r===-1||o===-1)return null;if(t)return{startRow:this.cursor.row,startCol:r+1,endRow:this.cursor.row,endCol:o};let n=r,c=o+1;if(c<s.length&&(s[c]===" "||s[c]==="	"))for(;c<s.length&&(s[c]===" "||s[c]==="	");)c++;else for(;n>0&&(s[n-1]===" "||s[n-1]==="	");)n--;return{startRow:this.cursor.row,startCol:n,endRow:this.cursor.row,endCol:c}}_textObjPair(e,t,s){let i=0,r=this.cursor.row,o=this.cursor.col,n=!1;t:for(let l=this.cursor.row;l>=0;l--){let a=this.buffer.lines[l],f=l===this.cursor.row?this.cursor.col:a.length-1;for(let u=f;u>=0;u--)if(a[u]===t&&!(l===this.cursor.row&&u===this.cursor.col)&&i++,a[u]===e){if(i===0){r=l,o=u,n=!0;break t}i--}}if(!n){let l=this.buffer.lines[this.cursor.row];for(let a=this.cursor.col+1;a<l.length;a++)if(l[a]===e){r=this.cursor.row,o=a,n=!0;break}}if(!n)return null;i=0;let c=this.cursor.row,h=this.cursor.col;n=!1;t:for(let l=r;l<this.buffer.lineCount;l++){let a=this.buffer.lines[l],f=l===r?o:0;for(let u=f;u<a.length;u++)if(a[u]===e&&!(l===r&&u===o)&&i++,a[u]===t){if(i===0){c=l,h=u,n=!0;break t}i--}}if(!n)return null;if(s){let l=o+1,a=r;l>=this.buffer.lines[a].length&&a<c&&(a++,l=0);let f={startRow:a,startCol:l,endRow:c,endCol:h};return a!==c&&(f.multilineInner=!0),f}return{startRow:r,startCol:o,endRow:c,endCol:h+1}}_textObjParagraph(e){let t=this.buffer.lineCount,s=this.cursor.row,i,r;if(this.buffer.lines[s]===""){for(i=s;i>0&&this.buffer.lines[i-1]==="";)i--;for(r=s;r<t-1&&this.buffer.lines[r+1]==="";)r++;if(!e){let o=r;for(;o<t-1&&this.buffer.lines[o+1]!=="";)o++;if(o>r)r=o;else if(i>0)for(;i>0&&this.buffer.lines[i-1]!=="";)i--}}else{for(i=s;i>0&&this.buffer.lines[i-1]!=="";)i--;for(r=s;r<t-1&&this.buffer.lines[r+1]!=="";)r++;if(!e){let o=r;for(;o<t-1&&this.buffer.lines[o+1]==="";)o++;if(o>r)r=o;else if(i>0)for(;i>0&&this.buffer.lines[i-1]==="";)i--}}return{startRow:i,startCol:0,endRow:r,endCol:this.buffer.lines[r].length,linewise:!0}}_textObjSentence(e){let t=this.cursor.row,s=this.buffer.lines[t],i=this.cursor.col;if(s.length===0)return null;let r=[];for(let u=0;u<s.length;u++)if(s[u]==="."||s[u]==="!"||s[u]==="?"){let _=u+1;for(;_<s.length&&`)]'"`.includes(s[_]);)_++;(_>=s.length||s[_]===" "||s[_]==="	")&&r.push(u)}if(r.length===0)return{startRow:t,startCol:0,endRow:t,endCol:s.length};let o=[];for(let u=0;u<r.length;u++){let _;if(u===0)_=0;else for(_=r[u-1]+1;_<s.length&&(s[_]===" "||s[_]==="	");)_++;o.push({start:_,end:r[u]})}let n=0;for(let u=0;u<o.length;u++){if(i<=o[u].end){n=u;break}u===o.length-1&&(n=u)}let c=o[n],h=n===0,l=c.start;h||(l=r[n-1]+1);let a,f;if(e)a=c.start,f=c.end+1;else if(a=c.start,f=c.end+1,c.end+1<s.length&&(s[c.end+1]===" "||s[c.end+1]==="	")){let u=c.end+1;for(;u<s.length&&(s[u]===" "||s[u]==="	");)u++;f=u}else h||(a=l);return{startRow:t,startCol:a,endRow:t,endCol:f}}_putAfter(e){let t=e?e.text:this._unnamedReg,s=e?e.type:this._regType;if(t!=null){if(s==="line"){let i=t.split(`
`);this.buffer.lines.splice(this.cursor.row+1,0,...i),this.cursor.row++,this.cursor.col=this._firstNonBlank(this.cursor.row)}else{let i=this.buffer.lines[this.cursor.row],r=this.cursor.col+1,o=t.split(`
`);if(o.length===1)this.buffer.lines[this.cursor.row]=i.slice(0,r)+o[0]+i.slice(r),this.cursor.col=r+o[0].length-1;else{let n=i.slice(0,r),c=i.slice(r);this.buffer.lines[this.cursor.row]=n+o[0];for(let l=1;l<o.length-1;l++)this.buffer.lines.splice(this.cursor.row+l,0,o[l]);let h=this.cursor.row+o.length-1;this.buffer.lines.splice(h,0,o[o.length-1]+c),this.cursor.col=n.length}}this._updateDesiredCol()}}_putBefore(e){let t=e?e.text:this._unnamedReg,s=e?e.type:this._regType;if(t!=null){if(s==="line"){let i=t.split(`
`);this.buffer.lines.splice(this.cursor.row,0,...i),this.cursor.col=this._firstNonBlank(this.cursor.row)}else{let i=this.buffer.lines[this.cursor.row],r=this.cursor.col,o=t.split(`
`);if(o.length===1)this.buffer.lines[this.cursor.row]=i.slice(0,r)+o[0]+i.slice(r),this.cursor.col=r+o[0].length-1;else{let n=i.slice(0,r),c=i.slice(r);this.buffer.lines[this.cursor.row]=n+o[0];for(let l=1;l<o.length-1;l++)this.buffer.lines.splice(this.cursor.row+l,0,o[l]);let h=this.cursor.row+o.length-1;this.buffer.lines.splice(h,0,o[o.length-1]+c),this.cursor.col=n.length}}this._updateDesiredCol()}}_extractRange(e,t,s,i){if(e===s)return this.buffer.lines[e].slice(t,i+1);let r=this.buffer.lines[e].slice(t);for(let o=e+1;o<s;o++)r+=`
`+this.buffer.lines[o];return r+=`
`+this.buffer.lines[s].slice(0,i+1),r}_deleteRange(e,t,s,i){if(e===s)this.buffer.lines[e]=this.buffer.lines[e].slice(0,t)+this.buffer.lines[e].slice(i+1);else{let r=this.buffer.lines[e].slice(0,t),o=this.buffer.lines[s].slice(i+1);this.buffer.lines[e]=r+o,this.buffer.lines.splice(e+1,s-e)}this.buffer.lines.length===0&&(this.buffer.lines=[""])}_maxCol(){let e=this.buffer.lineLength(this.cursor.row);return this.mode===p.INSERT||this.mode===p.REPLACE?e:e>0?e-1:0}_bufToVirtCol(e,t){let s=this.buffer.lines[e]||"",i=0;for(let r=0;r<s.length&&r<=t;r++){if(r===t)return s[r]==="	"&&(i+=8-i%8-1),i;s[r]==="	"?i+=8-i%8:i++}return i}_virtToBufCol(e,t){let s=this.buffer.lines[e]||"",i=0;for(let r=0;r<s.length;r++){if(s[r]==="	"){let o=i+8-i%8;if(o>t)return r;i=o}else i++;if(i>t)return r}return s.length>0?s.length-1:0}_clampCursor(){this.cursor.row<0&&(this.cursor.row=0),this.cursor.row>=this.buffer.lineCount&&(this.cursor.row=this.buffer.lineCount-1);let e=this._maxCol();if(this.cursor.col<0&&(this.cursor.col=0),(this.mode===p.VISUAL||this.mode===p.VISUAL_LINE)&&this._desiredCol===1/0){let t=this.buffer.lineLength(this.cursor.row);this.cursor.col>t&&(this.cursor.col=t)}else this.cursor.col>e&&(this.cursor.col=e)}_ensureCursorVisible(){this.cursor.row<this.scrollTop&&(this.scrollTop=this.cursor.row),this.cursor.row>=this.scrollTop+this._textRows&&(this.scrollTop=this.cursor.row-this._textRows+1)}_virtColAt(e,t){let s=this.buffer.lines[e]||"",i=0;for(let r=0;r<t&&r<s.length;r++)s[r]==="	"?i+=8-i%8:i++;return i}_updateDesiredCol(){this._desiredCol=this._virtColAt(this.cursor.row,this.cursor.col)}_applyDesiredCol(){this._desiredCol===1/0?this.cursor.col=this._maxCol():this.cursor.col=this._byteColForVirtCol(this.cursor.row,this._desiredCol)}_virtColEnd(e,t){let s=this.buffer.lines[e]||"";if(t>=s.length)return this._virtColAt(e,t);let i=this._virtColAt(e,t);return s[t]==="	"?i+(8-i%8)-1:i}_byteColForVirtCol(e,t){let s=this.buffer.lines[e]||"";if(s.length===0)return 0;let i=0;for(let r=0;r<s.length;r++){let o;if(s[r]==="	"?o=i+(8-i%8):o=i+1,t<o)return r;i=o}return Math.max(0,s.length-1)}_shiftLineRight(e){let t=this.buffer.lines[e];if(t.length===0)return;let s=8,i=0,r=0;for(;r<t.length&&(t[r]===" "||t[r]==="	");)t[r]==="	"?i+=s-i%s:i++,r++;let o=t.slice(r),n=i+s,c=Math.floor(n/s),h=n%s;this.buffer.lines[e]="	".repeat(c)+" ".repeat(h)+o}_shiftLineLeft(e){let t=this.buffer.lines[e];if(t.length===0)return;let s=8,i=0,r=0;for(;r<t.length&&(t[r]===" "||t[r]==="	");)t[r]==="	"?i+=s-i%s:i++,r++;if(i===0)return;let o=t.slice(r),n=Math.max(0,i-s),c=Math.floor(n/s),h=n%s;this.buffer.lines[e]="	".repeat(c)+" ".repeat(h)+o}_firstNonBlank(e){if(e<0||e>=this.buffer.lineCount)return 0;let t=this.buffer.lines[e],s=t.match(/\S/);return s?s.index:Math.max(0,t.length-1)}_lastNonBlank(e){if(e<0||e>=this.buffer.lineCount)return 0;let t=this.buffer.lines[e];for(let s=t.length-1;s>=0;s--)if(t[s]!==" "&&t[s]!=="	")return s;return 0}_addJumpEntry(){let e={row:this.cursor.row,col:this.cursor.col};if(this._jumpList.length>0){let t=this._jumpList[this._jumpList.length-1];if(t.row===e.row&&t.col===e.col)return}this._jumpList.push(e),this._jumpList.length>100&&this._jumpList.shift(),this._jumpListPos=this._jumpList.length}_incrementNumber(e){let t=this.buffer.lines[this.cursor.row];if(t.length===0)return!1;let s=/-?\d+/g,i;for(;(i=s.exec(t))!==null;){let r=i.index,o=r+i[0].length-1;if(o>=this.cursor.col){let c=(parseInt(i[0],10)+e).toString();return this.buffer.lines[this.cursor.row]=t.slice(0,r)+c+t.slice(o+1),this.cursor.col=r+c.length-1,this._updateDesiredCol(),!0}}return!1}_moveSentenceForward(){let e=this.buffer.lineCount,t=this.cursor.row,s=this.cursor.col;if(s++,s>this.buffer.lines[t].length&&(t++,s=0),t>=e)return!1;if(s===0&&t>0&&this.buffer.lines[t-1].length===0){for(;t<e&&this.buffer.lines[t].length===0;)t++;return t<e?(this.cursor.row=t,this.cursor.col=this._firstNonBlankOfLine(this.buffer.lines[t]),!0):!1}if(s>0){let i=this.buffer.lines[t],r=s-1;for(;r>=0&&(i[r]===" "||i[r]==="	");)r--;for(;r>=0&&/[)}\]'""\u201D]/.test(i[r]);)r--;if(r>=0&&(i[r]==="."||i[r]==="!"||i[r]==="?")){let o=s;for(;o<i.length&&(i[o]===" "||i[o]==="	");)o++;return o<i.length?(this.cursor.row=t,this.cursor.col=o,!0):t+1<e?(this.cursor.row=t+1,this.cursor.col=this.buffer.lines[t+1].length===0?0:this._firstNonBlankOfLine(this.buffer.lines[t+1]),!0):!1}}for(;t<e;){let i=this.buffer.lines[t];if(i.length===0){for(;t<e&&this.buffer.lines[t].length===0;)t++;return t<e?(this.cursor.row=t,this.cursor.col=this._firstNonBlankOfLine(this.buffer.lines[t])):(this.cursor.row=e-1,this.cursor.col=0),!0}for(let r=s;r<i.length;r++)if(i[r]==="."||i[r]==="!"||i[r]==="?"){let o=r+1;for(;o<i.length&&/[)}\]'""]/.test(i[o]);)o++;if(o>=i.length||i[o]===" "||i[o]==="	"){for(;o<i.length&&(i[o]===" "||i[o]==="	");)o++;return o<i.length?(this.cursor.row=t,this.cursor.col=o,!0):t+1<e?(this.cursor.row=t+1,this.cursor.col=this.buffer.lines[t+1].length===0?0:this._firstNonBlankOfLine(this.buffer.lines[t+1]),!0):!1}}t++,s=0}return!1}_moveSentenceBackward(){let e=this.cursor.row,t=this.cursor.col;if(t--,t<0){if(e--,e<0)return!1;t=Math.max(0,this.buffer.lines[e].length-1)}for(;e>=0;){let s=this.buffer.lines[e];if(s.length===0){if(e<this.cursor.row||e===this.cursor.row&&0<this.cursor.col)return this.cursor.row=e,this.cursor.col=0,!0;e--,e>=0&&(t=Math.max(0,this.buffer.lines[e].length-1));continue}for(let i=Math.min(t,s.length-1);i>=0;i--)if(s[i]==="."||s[i]==="!"||s[i]==="?"){let r=i+1;for(;r<s.length&&/[)}\]'""]/.test(s[r]);)r++;if(r>=s.length||s[r]===" "||s[r]==="	"){for(;r<s.length&&(s[r]===" "||s[r]==="	");)r++;if(r<s.length&&(e<this.cursor.row||r<this.cursor.col))return this.cursor.row=e,this.cursor.col=r,!0;if(r>=s.length){let o=e+1;for(;o<this.buffer.lineCount&&this.buffer.lines[o].length===0;)o++;if(o<this.buffer.lineCount&&(o<this.cursor.row||o===this.cursor.row&&this._firstNonBlankOfLine(this.buffer.lines[o])<this.cursor.col))return this.cursor.row=o,this.cursor.col=this._firstNonBlankOfLine(this.buffer.lines[o]),!0}}}if(e>0&&this.buffer.lines[e-1].length===0){let i=this._firstNonBlankOfLine(s);if(e<this.cursor.row||i<this.cursor.col)return this.cursor.row=e,this.cursor.col=i,!0}e--,e>=0&&(t=Math.max(0,this.buffer.lines[e].length-1))}return this.cursor.row>0||this.cursor.col>0?(this.cursor.row=0,this.cursor.col=0,!0):!1}_updateStatus(){let e=this.cursor.row+1,t=this.cursor.col+1,s=this.buffer.lineCount,i=`${e},${t}`,r=s<=1?"All":e===1?"Top":e===s?"Bot":`${Math.round(e/s*100)}%`,o=`${i}          ${r}`;this.statusLine=" ".repeat(Math.max(0,this.cols-o.length))+o,this.mode===p.INSERT?this.commandLine="-- INSERT --":this.mode===p.REPLACE?this.commandLine="-- REPLACE --":this.mode===p.VISUAL?this.commandLine="-- VISUAL --":this.mode===p.VISUAL_LINE?this.commandLine="-- VISUAL LINE --":this.mode===p.NORMAL&&this._macroRecording?this.commandLine="recording @"+this._macroRecording:this.mode===p.NORMAL&&!this._stickyCommandLine&&(this.commandLine="")}};var rt=class x{constructor({fs:e,rows:t=20,cols:s=40,cwd:i="~/vimfu",dirname:r="vimfu",user:o="user",hostname:n="vimfu",onLaunchVim:c=null,onLaunchTmux:h=null}={}){this.fs=e,this.rows=t,this.cols=s,this.cwd=i,this.dirname=r,this.user=o,this.hostname=n,this.onLaunchVim=c,this.onLaunchTmux=h,this._insideTmux=!1,this._textRows=t-1,this._outputLines=[],this._inputLine="",this._cursorPos=0,this._history=[],this._historyIdx=-1,this._savedInput="",this.scrollTop=0,this._viMode=!1,this._viNormal=!1,this._viOperator="",this._viPendingChar="",this._viYank="",this._viLastF=null,this._viCount="",this._viUndoStack=[],this._viLastChange=null,this._viRecording=[],this._viInChange=!1,this._viReplaceMode=!1,this._viReplaceStart=0,this._viReplaceOriginal="",this._viSearchMode="",this._viSearchBuffer="",this._viSearchPattern="",this._viSearchDir=1,this._exited=!1}get prompt(){return`\u279C  ${this.dirname} `}get _promptArrowLen(){return 3}get _promptDirLen(){return this.dirname.length}feedKey(e){if(!this._exited){if(e==="Ctrl-["&&(e="Escape"),this._viSearchMode){if(e==="Enter"){this._viSearchBuffer&&(this._viSearchPattern=this._viSearchBuffer,this._viSearchDir=this._viSearchMode==="/"?-1:1),this._viSearchMode="",this._viSearchBuffer="",this._viSearchPattern&&this._viHistorySearch(this._viSearchPattern,-1);return}if(e==="Escape"){this._viSearchMode="",this._viSearchBuffer="";return}if(e==="Backspace"){this._viSearchBuffer.length>0?this._viSearchBuffer=this._viSearchBuffer.slice(0,-1):this._viSearchMode="";return}if(e.length===1){this._viSearchBuffer+=e;return}return}if(e==="Enter"){this._viNormal=!1,this._viReplaceMode=!1,this._viOperator="",this._viCount="",this._viEndChange(),this._execute();return}if(this._viMode&&this._viNormal){this._feedKeyViNormal(e);return}if(this._viMode&&this._viReplaceMode){if(e==="Escape"){this._viReplaceMode=!1,this._viNormal=!0,this._viEndChange(),this._cursorPos>0&&this._cursorPos--;return}if(e==="Backspace"){if(this._cursorPos>this._viReplaceStart){this._cursorPos--;let t=this._cursorPos-this._viReplaceStart;if(t<this._viReplaceOriginal.length){let s=this._viReplaceOriginal[t];this._inputLine=this._inputLine.slice(0,this._cursorPos)+s+this._inputLine.slice(this._cursorPos+1)}}this._viInChange&&this._viRecording.push(e);return}if(e.length===1){this._cursorPos<this._inputLine.length?this._inputLine=this._inputLine.slice(0,this._cursorPos)+e+this._inputLine.slice(this._cursorPos+1):this._inputLine+=e,this._cursorPos++,this._viInChange&&this._viRecording.push(e);return}return}if(e==="Backspace")this._cursorPos>0&&(this._inputLine=this._inputLine.slice(0,this._cursorPos-1)+this._inputLine.slice(this._cursorPos),this._cursorPos--);else if(e==="ArrowLeft")this._cursorPos>0&&this._cursorPos--;else if(e==="ArrowRight")this._cursorPos<this._inputLine.length&&this._cursorPos++;else if(e==="ArrowUp")this._historyUp();else if(e==="ArrowDown")this._historyDown();else if(e==="Home")this._cursorPos=0;else if(e==="End")this._cursorPos=this._inputLine.length;else if(e==="Ctrl-C")this._appendOutput(this.prompt+this._inputLine+"^C"),this._inputLine="",this._cursorPos=0,this._historyIdx=-1,this._viNormal=!1,this._viReplaceMode=!1,this._viOperator="",this._viCount="";else if(e==="Ctrl-D")this._inputLine.length===0?(this._appendOutput(this.prompt+"exit"),this._exited=!0,this._onExit&&this._onExit()):this._cursorPos<this._inputLine.length&&(this._inputLine=this._inputLine.slice(0,this._cursorPos)+this._inputLine.slice(this._cursorPos+1));else if(e==="Delete")this._cursorPos<this._inputLine.length&&(this._inputLine=this._inputLine.slice(0,this._cursorPos)+this._inputLine.slice(this._cursorPos+1));else if(e==="Ctrl-L")this._outputLines=[],this.scrollTop=0;else if(e==="Ctrl-A")this._cursorPos=0;else if(e==="Ctrl-E")this._cursorPos=this._inputLine.length;else if(e==="Ctrl-U")this._inputLine=this._inputLine.slice(this._cursorPos),this._cursorPos=0;else if(e==="Ctrl-K")this._inputLine=this._inputLine.slice(0,this._cursorPos);else if(e==="Ctrl-W"){let s=this._inputLine.slice(0,this._cursorPos).replace(/\S+\s*$/,"");this._inputLine=s+this._inputLine.slice(this._cursorPos),this._cursorPos=s.length}else e==="Tab"?this._tabComplete():e==="Escape"?this._viMode&&(this._viNormal=!0,this._viOperator="",this._viPendingChar="",this._viCount="",this._viEndChange(),this._cursorPos>0&&this._cursorPos--):e.length===1&&(this._inputLine=this._inputLine.slice(0,this._cursorPos)+e+this._inputLine.slice(this._cursorPos),this._cursorPos++,this._viInChange&&this._viRecording.push(e))}}_feedKeyViNormal(e){let t=this._inputLine,s=this._cursorPos,i=Math.max(0,t.length-1),r=this._viOperator,o=this._viPendingChar;if(o==="r"){if(e.length===1&&t.length>0){let h=Math.min(this._viGetCount(),t.length-s);this._viSaveUndo(),this._inputLine=t.slice(0,s)+e.repeat(h)+t.slice(s+h),this._cursorPos=s+h-1,this._viEndChange()}this._viPendingChar="",this._viCount="";return}if(o==="f"||o==="F"||o==="t"||o==="T"){if(e.length===1){let h=o==="f"||o==="t",l=o==="t"||o==="T";this._viLastF={ch:e,forward:h,till:l};let a=null;if(h){let f=t.indexOf(e,s+1);f!==-1&&(a=l?f-1:f)}else{let f=t.lastIndexOf(e,s-1);f!==-1&&(a=l?f+1:f)}if(a!==null&&a>=0&&a<t.length)if(r){let f=Math.min(s,a),u=Math.max(s,a)+1;this._viSaveUndo(),this._viYank=t.slice(f,u),(r==="d"||r==="c")&&(this._inputLine=t.slice(0,f)+t.slice(u),this._cursorPos=f),this._viOperator="",r==="c"?(this._viNormal=!1,this._viBeginChange(["c",o,e])):(this._clampViCursor(),this._viEndChange())}else this._cursorPos=a}this._viPendingChar="",this._viCount="";return}if(e==="Escape"){this._viOperator="",this._viPendingChar="",this._viCount="";return}if(/[1-9]/.test(e)||e==="0"&&this._viCount!==""){this._viCount+=e;return}if(!r){if(e==="i"){this._viNormal=!1,this._viCount="",this._viBeginChange(["i"]);return}if(e==="I"){this._viNormal=!1,this._cursorPos=0,this._viCount="",this._viBeginChange(["I"]);return}if(e==="a"){this._viNormal=!1,this._cursorPos=Math.min(s+1,t.length),this._viCount="",this._viBeginChange(["a"]);return}if(e==="A"){this._viNormal=!1,this._cursorPos=t.length,this._viCount="",this._viBeginChange(["A"]);return}if(e==="s"){let h=Math.min(this._viGetCount(),t.length-s);this._viSaveUndo(),t.length>0&&(this._viYank=t.slice(s,s+h),this._inputLine=t.slice(0,s)+t.slice(s+h)),this._viNormal=!1,this._viCount="",this._viBeginChange(["s"]);return}if(e==="S"){this._viSaveUndo(),this._viYank=t,this._inputLine="",this._cursorPos=0,this._viNormal=!1,this._viCount="",this._viBeginChange(["S"]);return}if(e==="C"){this._viSaveUndo(),this._viYank=t.slice(s),this._inputLine=t.slice(0,s),this._viNormal=!1,this._viCount="",this._viBeginChange(["C"]);return}if(e==="D"){this._viSaveUndo(),this._viYank=t.slice(s),this._inputLine=t.slice(0,s),this._clampViCursor(),this._viCount="";return}if(e==="R"){this._viSaveUndo(),this._viNormal=!1,this._viReplaceMode=!0,this._viReplaceStart=s,this._viReplaceOriginal=t.slice(s),this._viCount="",this._viBeginChange(["R"]);return}if(e==="u"){this._viUndo(),this._viCount="";return}if(e==="."){this._viDotRepeat(),this._viCount="";return}if(e==="#"){this._viSaveUndo(),this._inputLine="#"+t,this._cursorPos=0,this._viNormal=!1,this._viCount="",this._viEndChange(),this._execute();return}}if(e==="d"||e==="c"||e==="y"){if(r===e){this._viSaveUndo(),this._viYank=t,(e==="d"||e==="c")&&(this._inputLine="",this._cursorPos=0),this._viOperator="",this._viCount="",e==="c"&&(this._viNormal=!1,this._viBeginChange([e,e]));return}this._viOperator=e;return}if(e==="f"||e==="F"||e==="t"||e==="T"){this._viPendingChar=e;return}if(!r&&e==="r"){this._viPendingChar="r";return}if(!r&&(e==="/"||e==="?")){this._viSearchMode=e,this._viSearchBuffer="",this._viCount="";return}if(!r&&e==="G"){let h=this._viCount;if(this._viCount="",h==="")this._history.length>0&&(this._historyIdx=0,this._inputLine=this._history[0],this._cursorPos=this._inputLine.length,this._clampViCursor());else{let l=parseInt(h,10);l>=1&&l<=this._history.length&&(this._historyIdx=l-1,this._inputLine=this._history[l-1],this._cursorPos=this._inputLine.length,this._clampViCursor())}return}let n=this._viGetCount(),c=this._viResolveMotion(e,s,t);if(c!==null){let h=c.target,l=c.inclusive;if(n>1&&!r){let a=s;for(let f=0;f<n;f++){let u=this._viResolveMotion(e,a,t);if(!u||u.target===a)break;a=u.target,l=u.inclusive}h=a}else if(n>1&&r){let a=s;for(let f=0;f<n;f++){let u=this._viResolveMotion(e,a,this._inputLine);if(!u||u.target===a)break;a=u.target,l=u.inclusive}h=a}if(r){let a=Math.min(s,h),f=Math.max(s,h);if(r==="c"&&(e==="w"||e==="W")){let _=s;for(let d=0;d<n;d++){let b=this._viResolveMotion(e==="w"?"e":"E",_,this._inputLine);if(!b||b.target===_)break;_=b.target}f=_,l=!0}(l||a===f)&&f++,this._viSaveUndo();let u=t.slice(a,f);this._viYank=u,(r==="d"||r==="c")&&(this._inputLine=t.slice(0,a)+t.slice(f),this._cursorPos=a),this._viOperator="",this._viCount="",r==="c"?(this._viNormal=!1,this._viBeginChange([r,...n>1?[String(n)]:[],e])):this._clampViCursor()}else this._cursorPos=Math.min(h,i),this._viCount="";return}if(!r){if(e==="x"){let h=Math.min(this._viGetCount(),t.length-s);t.length>0&&s<t.length&&(this._viSaveUndo(),this._viYank=t.slice(s,s+h),this._inputLine=t.slice(0,s)+t.slice(s+h),this._clampViCursor()),this._viCount="";return}if(e==="X"){let h=Math.min(this._viGetCount(),s);s>0&&(this._viSaveUndo(),this._viYank=t.slice(s-h,s),this._inputLine=t.slice(0,s-h)+t.slice(s),this._cursorPos=s-h),this._viCount="";return}if(e==="p"){if(this._viYank){this._viSaveUndo();let h=this._viGetCount(),l=this._viYank.repeat(h),a=s+1;this._inputLine=t.slice(0,a)+l+t.slice(a),this._cursorPos=a+l.length-1}this._viCount="";return}if(e==="P"){if(this._viYank){this._viSaveUndo();let h=this._viGetCount(),l=this._viYank.repeat(h);this._inputLine=t.slice(0,s)+l+t.slice(s),this._cursorPos=s+l.length-1}this._viCount="";return}if(e==="~"){let h=Math.min(this._viGetCount(),t.length-s);if(t.length>0&&s<t.length){this._viSaveUndo();let l="";for(let a=0;a<h;a++){let f=t[s+a];l+=f===f.toLowerCase()?f.toUpperCase():f.toLowerCase()}this._inputLine=t.slice(0,s)+l+t.slice(s+h),this._cursorPos=Math.min(s+h,this._inputLine.length-1)}this._viCount="";return}if(e==="ArrowUp"||e==="k"){this._historyUp(),this._clampViCursor(),this._viCount="";return}if(e==="ArrowDown"||e==="j"){this._historyDown(),this._clampViCursor(),this._viCount="";return}if(e==="n"){this._viSearchPattern&&this._viHistorySearch(this._viSearchPattern,-1),this._viCount="";return}if(e==="N"){this._viSearchPattern&&this._viHistorySearch(this._viSearchPattern,1),this._viCount="";return}if(e===";"||e===","){if(this._viLastF){let h=e===";"?this._viLastF.forward:!this._viLastF.forward,l=this._viLastF.till,a=this._viLastF.ch,f=null;if(h){let u=t.indexOf(a,s+1);u!==-1&&(f=l?u-1:u)}else{let u=t.lastIndexOf(a,s-1);u!==-1&&(f=l?u+1:u)}f!==null&&f>=0&&f<t.length&&(this._cursorPos=f)}this._viCount="";return}}this._viOperator="",this._viPendingChar="",this._viCount=""}_viResolveMotion(e,t,s){let i=s.length;if(e==="h"||e==="ArrowLeft")return{target:Math.max(0,t-1),inclusive:!1};if(e==="l"||e==="ArrowRight"||e===" ")return{target:Math.min(t+1,Math.max(0,i-1)),inclusive:!1};if(e==="0"||e==="Home")return{target:0,inclusive:!1};if(e==="$"||e==="End")return{target:Math.max(0,i-1),inclusive:!0};if(e==="^"||e==="_"){let r=s.match(/\S/);return{target:r?r.index:0,inclusive:!1}}if(e==="w"){let r=t;if(r<i&&/\w/.test(s[r]))for(;r<i&&/\w/.test(s[r]);)r++;else if(r<i&&/[^\w\s]/.test(s[r]))for(;r<i&&/[^\w\s]/.test(s[r]);)r++;else r++;for(;r<i&&/\s/.test(s[r]);)r++;return{target:r,inclusive:!1}}if(e==="W"){let r=t;for(;r<i&&!/\s/.test(s[r]);)r++;for(;r<i&&/\s/.test(s[r]);)r++;return{target:r,inclusive:!1}}if(e==="b"){let r=t;for(r>0&&r--;r>0&&/\s/.test(s[r]);)r--;if(/\w/.test(s[r]))for(;r>0&&/\w/.test(s[r-1]);)r--;else if(/[^\w\s]/.test(s[r]))for(;r>0&&/[^\w\s]/.test(s[r-1]);)r--;return{target:r,inclusive:!1}}if(e==="B"){let r=t;for(r>0&&r--;r>0&&/\s/.test(s[r]);)r--;for(;r>0&&!/\s/.test(s[r-1]);)r--;return{target:r,inclusive:!1}}if(e==="e"){let r=t;for(r<i-1&&r++;r<i-1&&/\s/.test(s[r]);)r++;if(/\w/.test(s[r]))for(;r<i-1&&/\w/.test(s[r+1]);)r++;else if(/[^\w\s]/.test(s[r]))for(;r<i-1&&/[^\w\s]/.test(s[r+1]);)r++;return{target:r,inclusive:!0}}if(e==="E"){let r=t;for(r<i-1&&r++;r<i-1&&/\s/.test(s[r]);)r++;for(;r<i-1&&!/\s/.test(s[r+1]);)r++;return{target:r,inclusive:!0}}return null}_clampViCursor(){let e=Math.max(0,this._inputLine.length-1);this._cursorPos>e&&(this._cursorPos=e),this._cursorPos<0&&(this._cursorPos=0)}_viGetCount(){let e=this._viCount?parseInt(this._viCount,10):1;return Math.max(1,e)}_viSaveUndo(){this._viUndoStack.push({line:this._inputLine,cursorPos:this._cursorPos}),this._viUndoStack.length>100&&this._viUndoStack.shift()}_viUndo(){if(this._viUndoStack.length>0){let e=this._viUndoStack.pop();this._inputLine=e.line,this._cursorPos=e.cursorPos,this._clampViCursor()}}_viBeginChange(e){this._viInChange=!0,this._viRecording=[...e]}_viEndChange(){this._viInChange&&(this._viLastChange={keys:[...this._viRecording]},this._viInChange=!1,this._viRecording=[])}_viDotRepeat(){if(!this._viLastChange)return;this._viSaveUndo();let e=this._viLastChange.keys;for(let t of e)this.feedKey(t);this._viNormal||this.feedKey("Escape")}_viHistorySearch(e,t){if(this._history.length===0)return;let s;this._historyIdx===-1?(this._savedInput=this._inputLine,s=t<0?this._history.length-1:0):s=this._historyIdx+t;try{let i=new RegExp(e),r=s;for(;r>=0&&r<this._history.length;){if(i.test(this._history[r])){this._historyIdx=r,this._inputLine=this._history[r],this._cursorPos=this._inputLine.length,this._clampViCursor();return}r+=t}}catch{let i=s;for(;i>=0&&i<this._history.length;){if(this._history[i].includes(e)){this._historyIdx=i,this._inputLine=this._history[i],this._cursorPos=this._inputLine.length,this._clampViCursor();return}i+=t}}}getScreen(){let e=[],t=this._outputLines.length,s=t+1;if(s<=this.rows){for(let c=0;c<t;c++)e.push(this._pad(this._outputLines[c]));let i=this.prompt,r=i+this._inputLine;e.push(this._pad(r));let o=t;for(let c=s;c<this.rows;c++)e.push(" ".repeat(this.cols));let n=Math.min(i.length+this._cursorPos,this.cols-1);if(this._viSearchMode){let c=this._viSearchMode+this._viSearchBuffer,h=Math.min(o+1,this.rows-1);return e[h]=this._pad(c),n=c.length,{lines:e,cursor:{row:h,col:n}}}return{lines:e,cursor:{row:o,col:n}}}else{let i=this.rows-1,r=Math.max(0,t-i);this.scrollTop=Math.min(this.scrollTop,r);let o=this.scrollTop;for(let l=0;l<i;l++){let a=o+l;a<t?e.push(this._pad(this._outputLines[a])):e.push(" ".repeat(this.cols))}let n=this.prompt,c=n+this._inputLine;e.push(this._pad(c));let h=Math.min(n.length+this._cursorPos,this.cols-1);return{lines:e,cursor:{row:this.rows-1,col:h}}}}renderFrame(e){let t=e,{lines:s,cursor:i}=this.getScreen(),r=[],o=t.normalBg||"14161b",n=t.normalFg||"e0e2ea",c="00ff00",h="00ffff",l=this._promptArrowLen,a=this._promptDirLen,f=this.prompt;for(let _=0;_<s.length;_++){let d=s[_];if((_===i.row||d.startsWith(f))&&l+a<this.cols){let v=[];v.push({n:l,fg:c,bg:o,b:!0}),v.push({n:a,fg:h,bg:o,b:!0});let N=this.cols-l-a;N>0&&v.push({n:N,fg:n,bg:o}),r.push({text:d,runs:v})}else r.push({text:d,runs:[{n:this.cols,fg:n,bg:o}]})}let u=this._viMode&&(this._viNormal||this._viReplaceMode)?"block":"beam";return{rows:this.rows,cols:this.cols,cursor:{row:i.row,col:i.col,visible:!0,shape:u},defaultFg:t.normalFg||"e0e2ea",defaultBg:t.normalBg||"14161b",lines:r}}_execute(){let e=this.prompt+this._inputLine;this._appendOutput(e);let t=this._inputLine.trim();this._inputLine="",this._cursorPos=0,t&&(this._history.push(t),this._historyIdx=-1,this._runCommand(t))}_runCommand(e){let t=this._tokenize(e);if(t.length===0)return;let s=t[0],i=t.slice(1);switch(s){case"vi":case"vim":case"nvim":this._cmdVim(i);break;case"ls":this._cmdLs(i);break;case"cat":this._cmdCat(i);break;case"rm":this._cmdRm(i);break;case"touch":this._cmdTouch(i);break;case"echo":this._cmdEcho(i,e);break;case"sort":this._cmdSort(i);break;case"wc":this._cmdWc(i);break;case"grep":this._cmdGrep(i);break;case"cp":this._cmdCp(i);break;case"mv":this._cmdMv(i);break;case"history":this._cmdHistory();break;case"exit":this._exited=!0;break;case"tmux":this._cmdTmux(i);break;case"set":this._cmdSet(i);break;case"date":this._appendOutput(x._formatDate(new Date));break;case"clear":this._outputLines=[],this.scrollTop=0;break;case"help":this._cmdHelp();break;default:this._appendOutput(`zsh: command not found: ${s}`);break}}_cmdVim(e){let t=e[0]||null;this.onLaunchVim&&this.onLaunchVim(t)}_cmdTmux(e){if(this._insideTmux){this._appendOutput("sessions should be nested with care, unset $TMUX to force");return}this.onLaunchTmux?this.onLaunchTmux(e):this._appendOutput("zsh: command not found: tmux")}_cmdLs(e){let t=this.fs.ls();t.length!==0&&this._appendOutput(t.join("  "))}_cmdCat(e){if(e.length!==0)for(let t of e){let s=this.fs.read(t);if(s===null)this._appendOutput(`cat: ${t}: No such file or directory`);else{let i=s.split(`
`);for(let r of i)this._appendOutput(r)}}}_cmdRm(e){for(let t of e)this.fs.rm(t)||this._appendOutput(`rm: cannot remove '${t}': No such file or directory`)}_cmdTouch(e){for(let t of e)this.fs.exists(t)||this.fs.write(t,"")}_cmdEcho(e,t){let s=e.indexOf(">>");if(s>=0){let r=e.slice(0,s).join(" "),o=e[s+1];if(o){let n=this.fs.read(o)||"";this.fs.write(o,n+(n?`
`:"")+this._unquote(r))}else this._appendOutput("zsh: parse error near `\\n'");return}let i=e.indexOf(">");if(i>=0){let r=e.slice(0,i).join(" "),o=e[i+1];o?this.fs.write(o,this._unquote(r)):this._appendOutput("zsh: parse error near `\\n'")}else{let r=e.join(" ");this._appendOutput(this._unquote(r))}}_cmdSort(e){let t=!1,s=!1,i=!1,r=[];for(let o of e)if(o==="-r"||o==="--reverse")t=!0;else if(o==="-n"||o==="--numeric-sort")s=!0;else if(o==="-u"||o==="--unique")i=!0;else if(o.startsWith("-")&&o.length>1)for(let n of o.slice(1))if(n==="r")t=!0;else if(n==="n")s=!0;else if(n==="u")i=!0;else{this._appendOutput(`sort: invalid option -- '${n}'`);return}else r.push(o);if(r.length===0){this._appendOutput("sort: missing file operand");return}for(let o of r){let n=this.fs.read(o);if(n===null){this._appendOutput(`sort: cannot read: ${o}: No such file or directory`);continue}let c=n.split(`
`);c.length>0&&c[c.length-1]===""&&c.pop(),s?c.sort((h,l)=>{let a=parseFloat(h)||0,f=parseFloat(l)||0;return a-f}):c.sort(),t&&c.reverse(),i&&(c=[...new Set(c)]);for(let h of c)this._appendOutput(h)}}_cmdWc(e){let t=[],s=[];for(let c of e)if(c.startsWith("-")&&c.length>1)for(let h of c.slice(1))if("lwc".includes(h))t.push(h);else{this._appendOutput(`wc: invalid option -- '${h}'`);return}else s.push(c);if(s.length===0){this._appendOutput("wc: missing file operand");return}let i=t.length===0,r=i||t.includes("l"),o=i||t.includes("w"),n=i||t.includes("c");for(let c of s){let h=this.fs.read(c);if(h===null){this._appendOutput(`wc: ${c}: No such file or directory`);continue}let l=h===""?0:h.split(`
`).length,a=h===""?0:h.split(/\s+/).filter(_=>_).length,f=h.length,u=[];r&&u.push(String(l).padStart(8)),o&&u.push(String(a).padStart(8)),n&&u.push(String(f).padStart(8)),u.push(` ${c}`),this._appendOutput(u.join(""))}}_cmdGrep(e){let t=!1,s=!1,i=!1,r=[];for(let h of e)if(h.startsWith("-")&&h.length>1&&!/^\d/.test(h.slice(1)))for(let l of h.slice(1))if(l==="i")t=!0;else if(l==="n")s=!0;else if(l==="c")i=!0;else{this._appendOutput(`grep: invalid option -- '${l}'`);return}else r.push(h);if(r.length<2){this._appendOutput("Usage: grep [options] pattern file");return}let o=r[0],n=r.slice(1),c;try{c=new RegExp(o,t?"i":"")}catch{this._appendOutput(`grep: invalid regex: ${o}`);return}for(let h of n){let l=this.fs.read(h);if(l===null){this._appendOutput(`grep: ${h}: No such file or directory`);continue}let a=l.split(`
`),f=0,u=n.length>1?`${h}:`:"";for(let _=0;_<a.length;_++)if(c.test(a[_])&&(f++,!i)){let d=s?`${_+1}:`:"";this._appendOutput(`${u}${d}${a[_]}`)}i&&this._appendOutput(`${u}${f}`)}}_cmdCp(e){if(e.length<2){this._appendOutput("cp: missing file operand");return}let t=e[0],s=e[1],i=this.fs.read(t);if(i===null){this._appendOutput(`cp: cannot stat '${t}': No such file or directory`);return}this.fs.write(s,i)}_cmdMv(e){if(e.length<2){this._appendOutput("mv: missing file operand");return}let t=e[0],s=e[1],i=this.fs.read(t);if(i===null){this._appendOutput(`mv: cannot stat '${t}': No such file or directory`);return}this.fs.write(s,i),this.fs.rm(t)}_cmdHistory(){for(let e=0;e<this._history.length;e++){let t=String(e+1).padStart(5);this._appendOutput(`${t}  ${this._history[e]}`)}}_cmdSet(e){e.length===2&&e[0]==="-o"&&e[1]==="vi"?(this._viMode=!0,this._viNormal=!1,this._viReplaceMode=!1,this._viUndoStack=[],this._viLastChange=null,this._viCount="",this._viSearchPattern=""):e.length===2&&e[0]==="-o"&&e[1]==="emacs"?(this._viMode=!1,this._viNormal=!1,this._viReplaceMode=!1):e.length>=2&&e[0]==="-o"?this._appendOutput(`set: no such option: ${e[1]}`):e.length===0?this._appendOutput(`editing-mode ${this._viMode?"vi":"emacs"}`):this._appendOutput("set: usage: set -o [vi|emacs]")}_cmdHelp(){let e=["Available commands:","  nvim [file]   Open file in Neovim (also: vim, vi)","  ls            List files","  cat <file>    Display file contents","  rm <file>     Remove a file","  touch <file>  Create empty file","  cp <s> <d>    Copy a file","  mv <s> <d>    Move/rename a file","  echo <text>   Print text (> and >> redirect)","  wc <file>     Count lines, words, bytes","  grep <p> <f>  Search for pattern in file","  sort <file>   Sort lines of a file (-r -n -u)","  history       Show command history","  tmux          Start terminal multiplexer (attach, ls)","  set -o vi     Enable vi-mode editing (set -o emacs to disable)","  date          Print current date and time","  clear         Clear screen","  exit          Exit shell","  help          Show this help"];for(let t of e)this._appendOutput(t)}_historyUp(){this._history.length!==0&&(this._historyIdx===-1?(this._savedInput=this._inputLine,this._historyIdx=this._history.length-1):this._historyIdx>0&&this._historyIdx--,this._inputLine=this._history[this._historyIdx],this._cursorPos=this._inputLine.length)}_historyDown(){this._historyIdx!==-1&&(this._historyIdx<this._history.length-1?(this._historyIdx++,this._inputLine=this._history[this._historyIdx]):(this._historyIdx=-1,this._inputLine=this._savedInput),this._cursorPos=this._inputLine.length)}_tabComplete(){let e=this._inputLine.slice(0,this._cursorPos),t=e.split(/\s+/),s=t[t.length-1]||"";if(!s)return;let i=t.length===1||t.length===2&&t[0]==="",r;if(i?r=["vim","vi","nvim","ls","cat","rm","touch","cp","mv","echo","wc","grep","sort","history","set","date","clear","exit","help","tmux"].filter(n=>n.startsWith(s)):r=this.fs.ls().filter(o=>o.startsWith(s)),r.length===1){let n=r[0].slice(s.length),c=i?n+" ":n;this._inputLine=e+c+this._inputLine.slice(this._cursorPos),this._cursorPos+=c.length}else r.length>1&&(this._appendOutput(this.prompt+this._inputLine),this._appendOutput(r.join("  ")))}static _formatDate(e){let t=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],s=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],i=t[e.getDay()],r=s[e.getMonth()],o=String(e.getDate()).padStart(2," "),n=e.toTimeString().split(" ")[0],c=e.toString().match(/\(([^)]+)\)/),h="";if(c){let a=c[1];h=a.includes(" ")?a.split(" ").map(f=>f[0]).join(""):a}let l=e.getFullYear();return`${i} ${r} ${o} ${n} ${h} ${l}`}_pad(e){return e.length>=this.cols?e.slice(0,this.cols):e+" ".repeat(this.cols-e.length)}_appendOutput(e){if(e.length<=this.cols)this._outputLines.push(e);else for(let i=0;i<e.length;i+=this.cols)this._outputLines.push(e.slice(i,i+this.cols));let t=this.rows-1,s=Math.max(0,this._outputLines.length-t);this.scrollTop=s}_tokenize(e){let t=[],s="",i=!1,r=!1;for(let o=0;o<e.length;o++){let n=e[o];n==="'"&&!r?i=!i:n==='"'&&!i?r=!r:n===" "&&!i&&!r?s&&(t.push(s),s=""):s+=n}return s&&t.push(s),t}_unquote(e){return e.startsWith("'")&&e.endsWith("'")||e.startsWith('"')&&e.endsWith('"')?e.slice(1,-1):e}};var Ct="vimfu:files",ot=class{constructor({persist:e=!0}={}){this._persist=e,this._files=new Map,this._load()}ls(){return[...this._files.keys()].sort()}exists(e){return this._files.has(e)}read(e){return this._files.get(e)??null}write(e,t){this._files.set(e,t),this._save()}rm(e){let t=this._files.delete(e);return t&&this._save(),t}clear(){this._files.clear(),this._save()}get fileCount(){return this._files.size}_load(){if(this._persist)try{let e=localStorage.getItem(Ct);if(e){let t=JSON.parse(e);for(let[s,i]of Object.entries(t))this._files.set(s,i)}}catch{}}_save(){if(this._persist)try{let e=Object.fromEntries(this._files);localStorage.setItem(Ct,JSON.stringify(e))}catch{}}};var vt=new Map;function St(x){vt.set(x.name,x)}function Lt(x){if(!x)return null;let e=x.lastIndexOf(".");if(e<0)return null;let t=x.slice(e);for(let s of vt.values())if(s.fileTypes&&s.fileTypes.includes(t))return s;return null}var nt=class{constructor(e){this.grammar=e,this.name=e.name}tokenizeLine(e,t={}){let s=[],i=0;if(t.multiLine){let n=new RegExp(t.multiLine.endPattern,"g").exec(e);if(n){let c=n.index+n[0].length;s.push({start:0,end:c,scope:t.multiLine.scope}),i=c,t={}}else return s.push({start:0,end:e.length,scope:t.multiLine.scope}),{tokens:s,state:t}}let r=this.grammar.rules;for(;i<e.length;){let o=e.length,n=-1,c=null,h=!1,l=null,a=1/0;for(let f=0;f<r.length;f++){let u=r[f];if(u.begin!=null){let _=new RegExp(u.begin,"g");_.lastIndex=i;let d=_.exec(e);if(!d)continue;if(d.index<o||d.index===o&&f<a){let b=d.index+d[0].length,C=new RegExp(u.end,"g");C.lastIndex=b;let v=C.exec(e);v?(o=d.index,n=v.index+v[0].length,c=u.scope,h=!1,a=f):(o=d.index,n=e.length,c=u.scope,h=!0,l=u.end,a=f)}}else if(u.match!=null){let _=new RegExp(u.match,"g");_.lastIndex=i;let d=_.exec(e);if(!d||d[0].length===0)continue;(d.index<o||d.index===o&&f<a)&&(o=d.index,n=d.index+d[0].length,c=u.scope,h=!1,l=null,a=f)}}if(c===null)break;if(s.push({start:o,end:n,scope:c}),i=n,h)return{tokens:s,state:{multiLine:{endPattern:l,scope:c}}}}return{tokens:s,state:{}}}tokenizeLines(e){let t=[],s={};for(let i of e){let r=this.tokenizeLine(i,s);t.push(r.tokens),s=r.state}return{tokens:t,finalState:s}}};function xt(x,e){if(!e||!x)return null;if(e[x]!==void 0)return e[x];let t=x;for(;t.includes(".");)if(t=t.slice(0,t.lastIndexOf(".")),e[t]!==void 0)return e[t];return null}var Nt={name:"python",fileTypes:[".py"],rules:[{begin:'(?:[rRbBuU]|[rRbB][bBrR])?"""',end:'"""',scope:"string"},{begin:"(?:[rRbBuU]|[rRbB][bBrR])?'''",end:"'''",scope:"string"},{match:'(?:[rRbBuU]|[rRbB][bBrR])?"(?:[^"\\\\]|\\\\.)*"',scope:"string"},{match:"(?:[rRbBuU]|[rRbB][bBrR])?'(?:[^'\\\\]|\\\\.)*'",scope:"string"},{match:"#.*$",scope:"comment"},{match:"(?<=@)\\w+",scope:"decorator"},{match:"\\b(?:import|from)\\b",scope:"keyword.import"},{match:"\\b(?:def|class|return|yield|raise|pass|break|continue|del|assert|global|nonlocal|lambda|with|as|async|await)\\b",scope:"keyword"},{match:"\\b(?:if|elif|else)\\b",scope:"keyword"},{match:"\\b(?:for|while)\\b",scope:"keyword"},{match:"\\b(?:try|except|finally)\\b",scope:"keyword"},{match:"\\b(?:and|or|not|in|is)\\b",scope:"keyword"},{match:"\\b(?:True|False|None)\\b",scope:"constant"},{match:"\\b0[xX][0-9a-fA-F][0-9a-fA-F_]*\\b",scope:"number"},{match:"\\b0[bB][01][01_]*\\b",scope:"number"},{match:"\\b0[oO][0-7][0-7_]*\\b",scope:"number"},{match:"\\b\\d[\\d_]*\\.?\\d*[jJ]\\b",scope:"number"},{match:"\\b\\d[\\d_]*\\.\\d[\\d_]*(?:[eE][+-]?\\d[\\d_]*)?\\b",scope:"number"},{match:"\\b\\d[\\d_]*[eE][+-]?\\d[\\d_]*\\b",scope:"number"},{match:"\\b\\d[\\d_]*\\b",scope:"number"},{match:"\\b(?:print|len|range|enumerate|zip|map|filter|sorted|reversed|list|dict|set|tuple|int|str|float|bool|bytes|type|isinstance|issubclass|hasattr|getattr|setattr|delattr|super|open|input|abs|min|max|sum|any|all|iter|next|repr|id|hash|callable|format|round|chr|ord|hex|oct|bin|pow|vars|dir|help|eval|exec|compile|globals|locals|__import__|staticmethod|classmethod|property)\\b",scope:"builtin"},{match:"\\b__[a-zA-Z_][a-zA-Z0-9_]*__\\b",scope:"special"},{match:"(?<=\\bdef\\s)[a-zA-Z_]\\w*",scope:"function.def"},{match:"(?<=\\bclass\\s)[a-zA-Z_]\\w*",scope:"class.def"}]};St(Nt);var Rt={nvim_default:{normalFg:"e0e2ea",normalBg:"14161b",tildeFg:"4f5258",tildeBg:"14161b",statusFg:"2c2e33",statusBg:"c4c6cd",cmdFg:"e0e2ea",cmdBg:"14161b",recordingFg:"b3f6c0",modeMsgFg:"b3f6c0",visualBg:"4f5258",searchFg:"eef1f8",searchBg:"6b5300",curSearchFg:"07080d",curSearchBg:"fce094",errorFg:"ffc0b9",promptFg:"8cf8f7",lineNrFg:"4f5258",cursorLineNrFg:"e0e2ea",syntax:{comment:"9b9ea4",string:"b3f6c0",constant:"8cf8f7",decorator:"8cf8f7","function.def":"8cf8f7","class.def":"8cf8f7",builtin:"8cf8f7",special:"8cf8f7"}},monokai:{normalFg:"d4d4d4",normalBg:"000000",tildeFg:"5c5cff",tildeBg:"000000",statusFg:"b1b1b1",statusBg:"2e323c",cmdFg:"d4d4d4",cmdBg:"000000",recordingFg:"00ff00",modeMsgFg:"00ff00",visualBg:"333842",searchFg:"26292c",searchBg:"e6db74",curSearchFg:"26292c",curSearchBg:"fd971f",errorFg:"ff6188",promptFg:"78dce8",lineNrFg:"90908a",cursorLineNrFg:"d4d4d4",syntax:{comment:"88846f",string:"e6db74",number:"ae81ff",constant:"ae81ff",keyword:"f92672","keyword.import":"f92672",decorator:"e6db74","function.def":"a6e22e","class.def":"a6e22e",builtin:"66d9ef",operator:"f92672",special:"fd971f"}}};var ht=class{constructor(e=20,t=40,s="monokai"){this.rows=e,this.cols=t,this.theme=Rt[s]||Rt.monokai}render(e){let t=this.theme,s=e.buffer,i=e.cursor,r=e.mode,o=this.rows-2,n=[],c=e.scrollTop??0,h=-1,l=-1,a=-1,f=-1,u=null;if(r==="visual"||r==="visual_line"){let g=e._visualStart,m=i;if(r==="visual_line")u="line",h=Math.min(g.row,m.row),a=Math.max(g.row,m.row);else if(u="char",g.row<m.row||g.row===m.row&&g.col<=m.col?(h=g.row,l=g.col,a=m.row,f=m.col):(h=m.row,l=m.col,a=g.row,f=g.col),e._visualExclusive){let L=m.row===a&&m.col===f,E=m.row===h&&m.col===l;L&&f>l?f--:E&&l<f&&l++}}else if(r==="command"&&e._visualCmdRange){let g=e._visualCmdRange;if(g.visMode==="visual_line")u="line",h=g.start,a=g.end;else{u="char";let m=g.visStart,L=g.visEnd;m.row<L.row||m.row===L.row&&m.col<=L.col?(h=m.row,l=m.col,a=L.row,f=L.col):(h=L.row,l=L.col,a=m.row,f=m.col)}}let _=null;if(e._searchPattern&&e._hlsearchActive)try{_=new RegExp(e._searchPattern,"g")}catch{}let d=null,b=Lt(e.filename);if(b&&t.syntax){let g=new nt(b),m=s.lines.slice(0,s.lineCount);d=g.tokenizeLines(m).tokens}let C=e._settings?.number??!1,v=e._settings?.relativenumber??!1,N=C||v,M=0;if(N){let g=s.lineCount,m=String(g).length;M=Math.max(4,m+1)}let k=this.cols-M,R=g=>{let m="",L=[];for(let E=0;E<g.length;E++)if(L[E]=m.length,g[E]==="	"){let W=8-m.length%8;m+=" ".repeat(W)}else m+=g[E];return L[g.length]=m.length,{expanded:m,bufToScreen:L}},A=g=>g.length===0?1:Math.ceil(g.length/k),D=c;{i.row<D&&(D=i.row);let g=0;for(let m=D;m<i.row&&m<s.lineCount;m++){let{expanded:L}=R(s.lines[m]);g+=A(L)}if(i.row<s.lineCount){let{expanded:m,bufToScreen:L}=R(s.lines[i.row]),E=L[Math.min(i.col,s.lines[i.row].length)]??0,W=Math.floor(E/k);for(g+=W;g>=o&&D<i.row;){let{expanded:F}=R(s.lines[D]);g-=A(F),D++}}}e.scrollTop=D;let V=0,I=D,Y=-1,mt=-1;for(;V<o&&I<s.lineCount;){let g=s.lines[I],{expanded:m,bufToScreen:L}=R(g),E=A(m);for(let W=0;W<E&&V<o;W++){let F=W*k,Q=Math.min(F+k,m.length),J=m.slice(F,Q),q=J.length>=k?J:J+" ".repeat(k-J.length),K=new Array(k).fill(t.normalFg),T=new Array(k).fill(t.normalBg);if(d&&d[I])for(let S of d[I]){let P=xt(S.scope,t.syntax);if(!P)continue;let O=L[S.start]??S.start,G=(L[S.end]??S.end)-1;for(let j=Math.max(O,F);j<=Math.min(G,Q-1);j++)K[j-F]=P}if(u){let S=-1,P=-1;if(u==="line"?I>=h&&I<=a&&(S=F,P=F+k-1):I>=h&&I<=a&&(h===a?(S=L[l]??0,P=l<=f&&f<g.length?(L[f+1]??m.length)-1:L[f]??m.length-1,f>=g.length&&(P=m.length-1),P=Math.max(S,P)):I===h?(S=L[l]??0,P=Math.max(m.length-1,S)):I===a?(S=0,P=f<g.length?(L[f+1]??m.length)-1:m.length-1,P=Math.max(0,P)):(S=0,P=Math.max(m.length-1,0))),S>=0&&P>=S){let O=Math.max(S,F)-F,G=Math.min(P,F+k-1)-F;for(let j=O;j<=G;j++)T[j]=t.visualBg}}if(_){_.lastIndex=0;let S;for(;(S=_.exec(g))!==null;){if(S[0].length===0){_.lastIndex++;continue}let P=L[S.index]??0,O=(L[S.index+S[0].length]??m.length)-1,G=e._curSearchPos,j=e._showCurSearch&&G&&I===G.row&&S.index===G.col,Et=j?t.curSearchFg:t.searchFg,Ot=j?t.curSearchBg:t.searchBg;for(let et=Math.max(P,F);et<=Math.min(O,Q-1);et++)K[et-F]=Et,T[et-F]=Ot}}let B="",st=[];if(N){if(W===0){let P=I===i.row,O;C&&v?P?(O=String(I+1),B=O+" ".repeat(M-O.length)):(O=String(Math.abs(I-i.row)),B=O.padStart(M-1)+" "):v?(O=P?"0":String(Math.abs(I-i.row)),B=O.padStart(M-1)+" "):(O=String(I+1),B=O.padStart(M-1)+" ")}else B=" ".repeat(M);let S=t.lineNrFg||t.normalFg;st.push({n:M,fg:S,bg:t.normalBg})}let H=[],$=0;for(let S=1;S<=k;S++)(S===k||K[S]!==K[$]||T[S]!==T[$])&&(H.push({n:S-$,fg:K[$],bg:T[$]}),$=S);let kt=B+q,Ft=[...st,...H];if(n.push({text:kt,runs:Ft}),I===i.row){let S=L[Math.min(i.col,g.length)]??0,P=S;i.col<g.length&&g[i.col]==="	"&&(P+=8-S%8-1);let O=Math.floor(P/k);W===O&&(Y=V,mt=P%k+M)}V++}I++}for(;V<o;){let g="~"+" ".repeat(this.cols-1);n.push({text:g,runs:[{n:this.cols,fg:t.tildeFg,bg:t.tildeBg}]}),V++}let It=this._padOrTruncate(e.statusLine??"",this.cols);n.push({text:It,runs:[{n:this.cols,fg:t.statusFg,bg:t.statusBg}]});let tt=this._padOrTruncate(e.commandLine??"",this.cols);if(t.recordingFg&&e._macroRecording&&e.mode==="normal"&&(e.commandLine??"").startsWith("recording @")){let g=("recording @"+e._macroRecording).length;n.push({text:tt,runs:[{n:g,fg:t.recordingFg,bg:t.cmdBg},{n:this.cols-g,fg:t.cmdFg,bg:t.cmdBg}]})}else if(/^E\d{3}:/.test(e.commandLine??"")){let g=Math.min((e.commandLine||"").length,this.cols),m=[];g>0&&m.push({n:g,fg:t.errorFg||t.cmdFg,bg:t.cmdBg}),g<this.cols&&m.push({n:this.cols-g,fg:t.cmdFg,bg:t.cmdBg}),n.push({text:tt,runs:m})}else if(t.modeMsgFg&&/^-- (INSERT|VISUAL|VISUAL LINE|REPLACE) --$/.test((e.commandLine??"").trim())){let g=(e.commandLine??"").replace(/\s+$/,"").length;n.push({text:tt,runs:[{n:g,fg:t.modeMsgFg,bg:t.cmdBg},{n:this.cols-g,fg:t.cmdFg,bg:t.cmdBg}]})}else n.push({text:tt,runs:[{n:this.cols,fg:t.cmdFg,bg:t.cmdBg}]});if(e._messagePrompt){let m=e._messagePrompt.error||"",L="Press ENTER or type command to continue",E=[];for(let T of m.split(`
`))if(T.length<=this.cols)E.push(T);else for(let B=0;B<T.length;B+=this.cols)E.push(T.slice(B,B+this.cols));let W=E.length+2,F=this.rows-W;F>=0&&(n[F]={text:" ".repeat(this.cols),runs:[{n:this.cols,fg:t.statusFg,bg:t.statusBg}]});for(let T=0;T<E.length;T++){let B=F+1+T;if(B>=0&&B<this.rows){let st=this._padOrTruncate(E[T],this.cols),H=Math.min(E[T].length,this.cols),$=[];H>0&&$.push({n:H,fg:t.errorFg||t.cmdFg,bg:t.cmdBg}),H<this.cols&&$.push({n:this.cols-H,fg:t.cmdFg,bg:t.cmdBg}),n[B]={text:st,runs:$}}}let Q=this.rows-1,J=this._padOrTruncate(L,this.cols),q=Math.min(L.length,this.cols),K=[];return q>0&&K.push({n:q,fg:t.promptFg||t.cmdFg,bg:t.cmdBg}),q<this.cols&&K.push({n:this.cols-q,fg:t.cmdFg,bg:t.cmdBg}),n[Q]={text:J,runs:K},{rows:this.rows,cols:this.cols,cursor:{row:this.rows-1,col:this.cols-1,visible:!0},defaultFg:t.normalFg,defaultBg:t.normalBg,lines:n}}return{rows:this.rows,cols:this.cols,cursor:{row:Y>=0?Y:0,col:mt>=0?mt:M,visible:!0},defaultFg:t.normalFg,defaultBg:t.normalBg,lines:n}}renderText(e){return this.render(e).lines.map(s=>s.text)}_padOrTruncate(e,t){return e.length>=t?e.slice(0,t):e+" ".repeat(t-e.length)}};var wt="Ctrl-B",ct={H:"\u2500",V:"\u2502",TL:"\u250C",TR:"\u2510",BL:"\u2514",BR:"\u2518",T:"\u252C",B:"\u2534",L:"\u251C",R:"\u2524",X:"\u253C"},w={NORMAL:"normal",PREFIX:"prefix",COMMAND:"command",CONFIRM:"confirm",RENAME:"rename",COPY:"copy",WINDOW_LIST:"window_list",PANE_NUMBERS:"pane_numbers",CLOCK:"clock",HELP:"help"},y={HSPLIT:"hsplit",VSPLIT:"vsplit"},U=class{constructor(e,t=null){this.type=e,this.pane=t,this.first=null,this.second=null,this.ratio=.5,this.top=0,this.left=0,this.width=0,this.height=0}isLeaf(){return this.type==="leaf"}getPanes(){return this.isLeaf()?[this.pane]:[...this.first.getPanes(),...this.second.getPanes()]}findLeaf(e){return this.isLeaf()?this.pane===e?this:null:this.first.findLeaf(e)||this.second.findLeaf(e)}findParent(e){return this.isLeaf()?null:this.first===e||this.second===e?this:this.first.findParent(e)||this.second.findParent(e)}computeLayout(e,t,s,i){if(this.top=e,this.left=t,this.width=s,this.height=i,this.isLeaf()){this.pane&&(this.pane.top=e,this.pane.left=t,this.pane.width=s,this.pane.height=i,this.pane._resize(s,i));return}if(this.type===y.HSPLIT){let r=Math.max(1,Math.floor(i*this.ratio)),o=i-1-r;this.first.computeLayout(e,t,s,r),this.second.computeLayout(e+r+1,t,s,Math.max(1,o))}else{let r=Math.max(1,Math.floor(s*this.ratio)),o=s-1-r;this.first.computeLayout(e,t,r,i),this.second.computeLayout(e,t+r+1,Math.max(1,o),i)}}},Tt=0,lt=class{constructor(e,t,s){this.id=Tt++,this.width=e,this.height=t,this.top=0,this.left=0,this.session=s,this._copyModeScroll=0,this._copyModeCursor={row:0,col:0}}_resize(e,t){e===this.session.cols&&t===this.session.rows||(this.width=e,this.height=t,this.session.rows=t,this.session.cols=e,this.session.shell.rows=t,this.session.shell.cols=e,this.session.shell._textRows=t-1,this.session.screen.rows=t,this.session.screen.cols=e,this.session.engine&&(this.session.engine.rows=t,this.session.engine.cols=e,this.session.engine._textRows=t-2))}feedKey(e){this.session.feedKey(e)}renderFrame(){return this.session.renderFrame()}getTitle(){return this.session.mode==="vim"?this.session._vimFilename||"[No Name]":this.session.shell._inputLine?this.session.shell._inputLine.split(/\s/)[0]:"zsh"}},yt=0,X=class{constructor(e,t,s,i){this.id=yt++,this.name=e,this.rows=t,this.cols=s,this._createPaneSession=i;let r=new lt(s,t,i(s,t));this.layout=new U("leaf",r),this.activePane=r,this.lastActivePane=null,this._zoomed=!1,this._zoomSavedLayout=null}getPanes(){return this.layout.getPanes()}getActivePaneIndex(){return this.getPanes().indexOf(this.activePane)}splitPane(e){let t=this.activePane,s=this.layout.findLeaf(t);if(!s||e==="h"&&t.height<4||e==="v"&&t.width<4)return null;let i=new lt(1,1,this._createPaneSession(1,1)),r=e==="h"?y.HSPLIT:y.VSPLIT;return s.type=r,s.first=new U("leaf",t),s.second=new U("leaf",i),s.pane=null,s.ratio=.5,this.layout.computeLayout(0,0,this.cols,this.rows),this.activePane=i,i}closePane(e){if(this.getPanes().length<=1)return!1;let s=this.layout.findLeaf(e);if(!s)return!1;let i=this.layout.findParent(s);if(!i)return!1;let r=i.first===s?i.second:i.first;if(i.type=r.type,i.pane=r.pane,i.first=r.first,i.second=r.second,i.ratio=r.ratio,this.activePane===e){let o=this.getPanes();this.activePane=o[0]}return this.layout.computeLayout(0,0,this.cols,this.rows),!0}navigatePane(e){let t=this.getPanes();if(t.length<=1)return;let s=this.activePane,i=s.left+s.width/2,r=s.top+s.height/2,o=null,n=1/0;for(let c of t){if(c===s)continue;let h=c.left+c.width/2,l=c.top+c.height/2,a=!1;switch(e){case"Up":a=l<r;break;case"Down":a=l>r;break;case"Left":a=h<i;break;case"Right":a=h>i;break}if(!a)continue;let f=Math.abs(h-i)+Math.abs(l-r);f<n&&(n=f,o=c)}o&&(this.lastActivePane=this.activePane,this.activePane=o)}nextPane(){let e=this.getPanes(),t=e.indexOf(this.activePane);this.lastActivePane=this.activePane,this.activePane=e[(t+1)%e.length]}prevPane(){let e=this.getPanes(),t=e.indexOf(this.activePane);this.lastActivePane=this.activePane,this.activePane=e[(t-1+e.length)%e.length]}resizePane(e,t=1){let s=this.layout.findLeaf(this.activePane);if(!s)return;let i=(r,o)=>{let n=this.layout.findParent(r);if(n)if(o==="Up"||o==="Down"){if(n.type===y.HSPLIT){let c=Math.floor(n.height*n.ratio),h=o==="Up"?c-t:c+t;n.ratio=Math.max(.1,Math.min(.9,h/n.height)),this.layout.computeLayout(0,0,this.cols,this.rows);return}i(n,o)}else{if(n.type===y.VSPLIT){let c=Math.floor(n.width*n.ratio),h=o==="Left"?c-t:c+t;n.ratio=Math.max(.1,Math.min(.9,h/n.width)),this.layout.computeLayout(0,0,this.cols,this.rows);return}i(n,o)}};i(s,e)}toggleZoom(){this._zoomed?(this._zoomed=!1,this.layout.computeLayout(0,0,this.cols,this.rows)):(this._zoomed=!0,this.activePane._resize(this.cols,this.rows),this.activePane.top=0,this.activePane.left=0)}swapPaneNext(){let e=this.getPanes(),t=e.indexOf(this.activePane);if(e.length<=1)return;let s=(t+1)%e.length;this._swapPaneContents(e[t],e[s])}swapPanePrev(){let e=this.getPanes(),t=e.indexOf(this.activePane);if(e.length<=1)return;let s=(t-1+e.length)%e.length;this._swapPaneContents(e[t],e[s])}_swapPaneContents(e,t){let s=e.session;e.session=t.session,t.session=s,e._resize(e.width,e.height),t._resize(t.width,t.height)}breakPane(){if(this.getPanes().length<=1)return null;let t=this.activePane;return this.closePane(t),t}cycleLayout(){let e=this.getPanes();e.length<=1||(this._layoutCycle||(this._layoutCycle=0),this._layoutCycle=(this._layoutCycle+1)%4,this._applyLayout(e,this._layoutCycle))}_applyLayout(e,t){if(!(e.length<=1)){switch(t){case 0:this.layout=this._buildEvenSplits(e,y.VSPLIT);break;case 1:this.layout=this._buildEvenSplits(e,y.HSPLIT);break;case 2:this.layout=this._buildMainSplit(e,y.HSPLIT);break;case 3:this.layout=this._buildMainSplit(e,y.VSPLIT);break}this.layout.computeLayout(0,0,this.cols,this.rows)}}_buildEvenSplits(e,t){if(e.length===1)return new U("leaf",e[0]);let s=Math.ceil(e.length/2),i=new U(t);return i.first=this._buildEvenSplits(e.slice(0,s),t),i.second=this._buildEvenSplits(e.slice(s),t),i.ratio=s/e.length,i}_buildMainSplit(e,t){if(e.length===1)return new U("leaf",e[0]);let s=new U(t);return s.first=new U("leaf",e[0]),s.second=this._buildEvenSplits(e.slice(1),t===y.HSPLIT?y.VSPLIT:y.HSPLIT),s.ratio=.6,s}},At=0,bt=class{constructor(e,t,s,i){this.id=At++,this.name=e,this.rows=t,this.cols=s,this._createPaneSession=i,this.windows=[new X("zsh",t,s,i)],this.activeWindowIndex=0,this.lastWindowIndex=-1}get activeWindow(){return this.windows[this.activeWindowIndex]}createWindow(e="zsh"){let t=new X(e,this.rows,this.cols,this._createPaneSession);return this.windows.push(t),this.lastWindowIndex=this.activeWindowIndex,this.activeWindowIndex=this.windows.length-1,t}switchWindow(e){e>=0&&e<this.windows.length&&(this.lastWindowIndex=this.activeWindowIndex,this.activeWindowIndex=e)}nextWindow(){this.lastWindowIndex=this.activeWindowIndex,this.activeWindowIndex=(this.activeWindowIndex+1)%this.windows.length}prevWindow(){this.lastWindowIndex=this.activeWindowIndex,this.activeWindowIndex=(this.activeWindowIndex-1+this.windows.length)%this.windows.length}lastWindow(){if(this.lastWindowIndex>=0&&this.lastWindowIndex<this.windows.length){let e=this.activeWindowIndex;this.activeWindowIndex=this.lastWindowIndex,this.lastWindowIndex=e}}closeWindow(e){return this.windows.length<=1?!1:(this.windows.splice(e,1),this.activeWindowIndex>=this.windows.length&&(this.activeWindowIndex=this.windows.length-1),this.lastWindowIndex>=this.windows.length&&(this.lastWindowIndex=-1),!0)}},at=class{constructor({rows:e=20,cols:t=80,createPaneSession:s}={}){this.rows=e,this.cols=t,this._createPaneSession=s,this._paneRows=e-1,this._mode=w.NORMAL,this.sessions=[],this._activeSessionIndex=0,this._commandInput="",this._renameInput="",this._confirmTarget=null,this._message="",this._messageTimer=0,this._copyPane=null,this._copyScroll=0,this._copyCursor={row:0,col:0},this._copySelecting=!1,this._copyAnchor=null,this._paneNumberTimer=0,this._clockPane=null,this._windowListCursor=0,this._helpScroll=0,this.detached=!1,this._createSession("0")}get activeSession(){return this.sessions[this._activeSessionIndex]}get activeWindow(){return this.activeSession?.activeWindow}get activePane(){return this.activeWindow?.activePane}feedKey(e){switch(this._message&&(this._message=""),this._mode){case w.NORMAL:this._handleNormal(e);break;case w.PREFIX:this._handlePrefix(e);break;case w.COMMAND:this._handleCommand(e);break;case w.CONFIRM:this._handleConfirm(e);break;case w.RENAME:this._handleRename(e);break;case w.COPY:this._handleCopy(e);break;case w.WINDOW_LIST:this._handleWindowList(e);break;case w.PANE_NUMBERS:this._handlePaneNumbers(e);break;case w.CLOCK:this._handleClock(e);break;case w.HELP:this._handleHelp(e);break}}renderFrame(){let e=this._getThemeColors(),t=[];for(let c=0;c<this.rows;c++)t.push({text:" ".repeat(this.cols),runs:[{n:this.cols,fg:e.fg,bg:e.bg}]});let s=this.activeWindow;if(!s)return this._buildFrame(t,{row:0,col:0,visible:!1});let i=0,r=0,o=!0,n="block";if(s._zoomed){let h=s.activePane.renderFrame();this._blitFrame(t,h,0,0,this.cols,this._paneRows),i=h.cursor.row,r=h.cursor.col,o=h.cursor.visible,n=h.cursor.shape||"block"}else{let c=s.getPanes();for(let h of c){let l=h.renderFrame();this._blitFrame(t,l,h.top,h.left,h.width,h.height),h===s.activePane&&(i=h.top+l.cursor.row,r=h.left+l.cursor.col,o=l.cursor.visible,n=l.cursor.shape||"block")}this._drawBorders(t,s.layout,e,s.activePane)}if(this._renderStatusBar(t,e),this._mode===w.COPY?(this._renderCopyOverlay(t,e),i=this._copyCursor.row,r=this._copyCursor.col,n="block"):this._mode===w.WINDOW_LIST?this._renderWindowList(t,e):this._mode===w.PANE_NUMBERS?this._renderPaneNumbers(t,e):this._mode===w.CLOCK?this._renderClock(t,e):this._mode===w.HELP&&this._renderHelpOverlay(t,e),this._mode===w.COMMAND){let c=":"+this._commandInput;this._setStatusText(t,c,e.cmdFg,e.cmdBg),i=this.rows-1,r=Math.min(c.length,this.cols-1)}else if(this._mode===w.RENAME){let c="(rename-window) "+this._renameInput;this._setStatusText(t,c,e.cmdFg,e.cmdBg),i=this.rows-1,r=Math.min(c.length,this.cols-1)}else if(this._mode===w.CONFIRM){let c;this._confirmTarget==="window"?c="kill-window "+(this.activeWindow?.name||"")+"? (y/n)":c="kill-pane "+(this._confirmTarget?.id??"")+"? (y/n)",this._setStatusText(t,c,e.cmdFg,e.cmdBg),i=this.rows-1,r=Math.min(c.length,this.cols-1)}else this._message&&this._setStatusText(t,this._message,e.cmdFg,e.cmdBg);return i=Math.max(0,Math.min(i,this.rows-1)),r=Math.max(0,Math.min(r,this.cols-1)),this._buildFrame(t,{row:i,col:r,visible:o,shape:n})}_handleNormal(e){if(e===wt){this._mode=w.PREFIX;return}this.activePane&&(this.activePane.feedKey(e),this._checkPaneExited(this.activePane))}_checkPaneExited(e){if(!e||!e.session)return;let t=e.session.shell;if(!t||!t._exited)return;let s=this.activeWindow;if(!s)return;if(s.getPanes().length>1)s.closePane(e);else{let r=this.activeSession;r.windows.length>1?r.closeWindow(r.activeWindowIndex):this.detached=!0}}_handlePrefix(e){this._mode=w.NORMAL;let t=this.activeWindow,s=this.activeSession;if(!(!t||!s))switch(e){case'"':t._zoomed&&t.toggleZoom(),t.splitPane("h")||(this._message="pane too small");break;case"%":t._zoomed&&t.toggleZoom(),t.splitPane("v")||(this._message="pane too small");break;case"ArrowUp":case"k":t._zoomed&&t.toggleZoom(),t.navigatePane("Up");break;case"ArrowDown":case"j":t._zoomed&&t.toggleZoom(),t.navigatePane("Down");break;case"ArrowLeft":case"h":t._zoomed&&t.toggleZoom(),t.navigatePane("Left");break;case"ArrowRight":case"l":t._zoomed&&t.toggleZoom(),t.navigatePane("Right");break;case"o":t._zoomed&&t.toggleZoom(),t.nextPane();break;case";":if(t.lastActivePane&&t.getPanes().includes(t.lastActivePane)){t._zoomed&&t.toggleZoom();let i=t.activePane;t.activePane=t.lastActivePane,t.lastActivePane=i}break;case"Ctrl-Up":t.resizePane("Up",1);break;case"Ctrl-Down":t.resizePane("Down",1);break;case"Ctrl-Left":t.resizePane("Left",1);break;case"Ctrl-Right":t.resizePane("Right",1);break;case"z":t.toggleZoom();break;case"x":this._confirmTarget=t.activePane,this._mode=w.CONFIRM;break;case"{":t._zoomed&&t.toggleZoom(),t.swapPanePrev();break;case"}":t._zoomed&&t.toggleZoom(),t.swapPaneNext();break;case"!":{t._zoomed&&t.toggleZoom();let i=t.breakPane();if(i){let r=new X("zsh",t.rows,t.cols,this.activeSession._createPaneSession);r.layout=new U("leaf",i),r.activePane=i,r.layout.computeLayout(0,0,r.cols,r.rows),s.windows.push(r),s.lastWindowIndex=s.activeWindowIndex,s.activeWindowIndex=s.windows.length-1}else this._message="can't break with only one pane";break}case"q":this._mode=w.PANE_NUMBERS,this._paneNumberTimer=Date.now();break;case"c":s.createWindow("zsh");break;case"n":s.nextWindow();break;case"p":s.prevWindow();break;case",":this._renameInput=t.name,this._mode=w.RENAME;break;case"&":this._confirmTarget="window",this._mode=w.CONFIRM;break;case"w":this._windowListCursor=s.activeWindowIndex,this._mode=w.WINDOW_LIST;break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":s.switchWindow(parseInt(e,10));break;case"L":s.lastWindow();break;case"d":this.detached=!0;break;case"[":case"PageUp":this._enterCopyMode();break;case":":this._commandInput="",this._mode=w.COMMAND;break;case"t":this._mode=w.CLOCK;break;case" ":t.cycleLayout();break;case"?":this._helpScroll=0,this._mode=w.HELP;break;case wt:this.activePane&&this.activePane.feedKey(wt);break;default:break}}_handleCommand(e){if(e==="Escape"){this._mode=w.NORMAL,this._commandInput="";return}if(e==="Enter"){this._executeCommand(this._commandInput.trim()),this._mode=w.NORMAL,this._commandInput="";return}if(e==="Backspace"){this._commandInput.length>0&&(this._commandInput=this._commandInput.slice(0,-1));return}e.length===1&&(this._commandInput+=e)}_handleConfirm(e){if(e==="y"||e==="Y")if(this._confirmTarget==="window"){let t=this.activeSession;t&&t.windows.length>1?t.closeWindow(t.activeWindowIndex):t&&(this.detached=!0)}else{let t=this.activeWindow;if(t&&this._confirmTarget)if(t.getPanes().length<=1){let i=this.activeSession;i.windows.length>1?i.closeWindow(i.activeWindowIndex):this.detached=!0}else t.closePane(this._confirmTarget)}this._confirmTarget=null,this._mode=w.NORMAL}_handleRename(e){if(e==="Escape"){this._mode=w.NORMAL,this._renameInput="";return}if(e==="Enter"){this.activeWindow&&this._renameInput&&(this.activeWindow.name=this._renameInput),this._mode=w.NORMAL,this._renameInput="";return}if(e==="Backspace"){this._renameInput=this._renameInput.slice(0,-1);return}if(e==="Ctrl-U"){this._renameInput="";return}e.length===1&&(this._renameInput+=e)}_handleCopy(e){switch(e){case"q":case"Escape":this._mode=w.NORMAL;break;case"j":case"ArrowDown":this._copyCursor.row=Math.min(this._copyCursor.row+1,this._paneRows-1);break;case"k":case"ArrowUp":this._copyCursor.row>0?this._copyCursor.row--:this._copyScroll>0&&this._copyScroll--;break;case"h":case"ArrowLeft":this._copyCursor.col=Math.max(0,this._copyCursor.col-1);break;case"l":case"ArrowRight":this._copyCursor.col=Math.min(this._copyCursor.col+1,this.cols-1);break;case"g":this._copyCursor.row=0,this._copyScroll=0;break;case"G":this._copyCursor.row=this._paneRows-1;break;case"0":this._copyCursor.col=0;break;case"$":this._copyCursor.col=this.cols-1;break;case"w":{this._copyCursor.col=Math.min(this._copyCursor.col+5,this.cols-1);break}case"b":{this._copyCursor.col=Math.max(0,this._copyCursor.col-5);break}case"Ctrl-F":this._copyCursor.row=Math.min(this._copyCursor.row+this._paneRows,this._paneRows-1);break;case"Ctrl-B":this._copyCursor.row>0?this._copyCursor.row=Math.max(0,this._copyCursor.row-this._paneRows):this._copyScroll=Math.max(0,this._copyScroll-this._paneRows);break;case"Ctrl-D":this._copyCursor.row=Math.min(this._copyCursor.row+Math.floor(this._paneRows/2),this._paneRows-1);break;case"Ctrl-U":this._copyCursor.row>0?this._copyCursor.row=Math.max(0,this._copyCursor.row-Math.floor(this._paneRows/2)):this._copyScroll=Math.max(0,this._copyScroll-Math.floor(this._paneRows/2));break;case"v":this._copySelecting=!this._copySelecting,this._copySelecting&&(this._copyAnchor={...this._copyCursor});break}}_handleWindowList(e){let t=this.activeSession;if(!t){this._mode=w.NORMAL;return}switch(e){case"j":case"ArrowDown":this._windowListCursor=Math.min(this._windowListCursor+1,t.windows.length-1);break;case"k":case"ArrowUp":this._windowListCursor=Math.max(0,this._windowListCursor-1);break;case"Enter":t.switchWindow(this._windowListCursor),this._mode=w.NORMAL;break;case"Escape":case"q":this._mode=w.NORMAL;break}}_handlePaneNumbers(e){if(e>="0"&&e<="9"){let t=this.activeWindow?.getPanes(),s=parseInt(e,10);t&&s<t.length&&(this.activeWindow.lastActivePane=this.activeWindow.activePane,this.activeWindow.activePane=t[s])}this._mode=w.NORMAL}_handleClock(e){this._mode=w.NORMAL}_handleHelp(e){if(e==="q"||e==="Escape"){this._mode=w.NORMAL;return}e==="j"||e==="ArrowDown"?this._helpScroll++:(e==="k"||e==="ArrowUp")&&(this._helpScroll=Math.max(0,this._helpScroll-1))}_executeCommand(e){if(!e)return;let t=e.split(/\s+/),s=t[0],i=t.slice(1);switch(s){case"split-window":case"splitw":{let o=i.includes("-h")?"v":"h";this.activeWindow?.splitPane(o);break}case"new-window":case"neww":{let r=i.indexOf("-n"),o=r>=0&&i[r+1]?i[r+1]:"zsh";this.activeSession?.createWindow(o);break}case"rename-window":case"renamew":{i[0]&&this.activeWindow&&(this.activeWindow.name=i.join(" "));break}case"select-window":case"selectw":{let r=i.indexOf("-t");r>=0&&i[r+1]&&this.activeSession?.switchWindow(parseInt(i[r+1],10));break}case"select-pane":case"selectp":{let r=i.indexOf("-t");if(r>=0&&i[r+1]){let o=this.activeWindow?.getPanes(),n=parseInt(i[r+1],10);o&&n>=0&&n<o.length&&(this.activeWindow.activePane=o[n])}break}case"resize-pane":case"resizep":{let r="Down",o=1;for(let n=0;n<i.length;n++)i[n]==="-U"?r="Up":i[n]==="-D"?r="Down":i[n]==="-L"?r="Left":i[n]==="-R"?r="Right":/^\d+$/.test(i[n])&&(o=parseInt(i[n],10));this.activeWindow?.resizePane(r,o);break}case"kill-pane":case"killp":{let r=this.activeWindow;if(r)if(r.getPanes().length>1)r.closePane(r.activePane);else{let n=this.activeSession;n.windows.length>1?n.closeWindow(n.activeWindowIndex):this.detached=!0}break}case"kill-window":case"killw":{let r=this.activeSession;r&&r.windows.length>1&&r.closeWindow(r.activeWindowIndex);break}case"swap-pane":case"swapp":{(i.includes("-U")||i.includes("-D"))&&(i.includes("-U")?this.activeWindow?.swapPanePrev():this.activeWindow?.swapPaneNext());break}case"new-session":case"new":{let r=i.indexOf("-s"),o=r>=0&&i[r+1]?i[r+1]:String(this.sessions.length);this._createSession(o);break}case"switch-client":case"switchc":{let r=i.indexOf("-t");if(r>=0&&i[r+1]){let o=i[r+1],n=this.sessions.findIndex(c=>c.name===o);n>=0?this._activeSessionIndex=n:this._message=`session not found: ${o}`}break}case"list-sessions":case"ls":{let r=this.sessions.map((o,n)=>`${o.name}: ${o.windows.length} windows${n===this._activeSessionIndex?" (attached)":""}`);this._message=r.join(" | ");break}case"detach-client":case"detach":this.detached=!0;break;case"next-layout":case"nextl":this.activeWindow?.cycleLayout();break;case"display-panes":case"displayp":this._mode=w.PANE_NUMBERS;break;case"clock-mode":this._mode=w.CLOCK;break;case"list-keys":case"lsk":this._helpScroll=0,this._mode=w.HELP;break;default:this._message=`unknown command: ${s}`;break}}_createSession(e){let t=new bt(e,this._paneRows,this.cols,this._createPaneSession);return this.sessions.push(t),this._activeSessionIndex=this.sessions.length-1,t}_enterCopyMode(){this._mode=w.COPY,this._copyCursor={row:0,col:0},this._copyScroll=0,this._copySelecting=!1,this._copyAnchor=null,this._copyPane=this.activePane}_getThemeColors(){return{fg:"f8f8f2",bg:"000000",borderFg:"49483e",borderActiveFg:"a6e22e",statusBg:"272822",statusFg:"f8f8f2",statusSepFg:"75715e",statusActiveFg:"a6e22e",statusActiveBg:"49483e",statusInactiveFg:"75715e",statusClockFg:"66d9ef",cmdBg:"49483e",cmdFg:"f8f8f2",paneNumFg:"a6e22e",paneNumBg:"000000"}}_blitFrame(e,t,s,i,r,o){for(let n=0;n<o&&n<t.lines.length;n++){let c=s+n;if(c>=this._paneRows)break;let h=t.lines[n],l=e[c],a=h.text||"",f=l.text.split("");for(let u=0;u<r&&u<a.length;u++){let _=i+u;_<this.cols&&(f[_]=a[u])}l.text=f.join(""),l.runs=this._spliceRuns(l.runs,h.runs,i,r,this.cols)}}_spliceRuns(e,t,s,i,r){let o=[];for(let c of e)for(let h=0;h<c.n;h++)o.push({fg:c.fg,bg:c.bg,b:c.b});for(;o.length<r;)o.push({fg:"e0e2ea",bg:"14161b"});let n=0;for(let c of t)for(let h=0;h<c.n;h++){let l=s+n;l<r&&n<i&&(o[l]={fg:c.fg,bg:c.bg,b:c.b}),n++}return this._compactRuns(o)}_compactRuns(e){if(e.length===0)return[{n:0,fg:"f8f8f2",bg:"000000"}];let t=[],s={n:1,fg:e[0].fg,bg:e[0].bg};e[0].b&&(s.b=!0);for(let i=1;i<e.length;i++){let r=e[i];r.fg===s.fg&&r.bg===s.bg&&(r.b||!1)===(s.b||!1)?s.n++:(t.push(s),s={n:1,fg:r.fg,bg:r.bg},r.b&&(s.b=!0))}return t.push(s),t}_drawBorders(e,t,s,i){if(t.isLeaf())return;let o=t.first.getPanes().includes(i)?s.borderActiveFg:s.borderFg;if(t.type===y.HSPLIT){let n=t.first.top+t.first.height;if(n<this._paneRows){let c=e[n],h=c.text.split("");for(let l=t.left;l<t.left+t.width&&l<this.cols;l++)h[l]=ct.H;c.text=h.join(""),this._setBorderRuns(c,t.left,t.width,o,s.bg)}}else{let n=t.first.left+t.first.width;if(n<this.cols)for(let c=t.top;c<t.top+t.height&&c<this._paneRows;c++){let h=e[c],l=h.text.split("");l[n]=ct.V,h.text=l.join(""),this._setBorderRuns(h,n,1,o,s.bg)}}this._drawIntersections(e,t,s),this._drawBorders(e,t.first,s,i),this._drawBorders(e,t.second,s,i)}_drawIntersections(e,t,s){if(t.type===y.HSPLIT){let i=t.first.top+t.first.height;if(i>=this._paneRows)return;this._addVIntersections(e,t.first,i,s),this._addVIntersections(e,t.second,i,s)}else{let i=t.first.left+t.first.width;this._addHIntersections(e,t.first,i,s),this._addHIntersections(e,t.second,i,s)}}_addVIntersections(e,t,s,i){if(!t.isLeaf()){if(t.type===y.VSPLIT){let r=t.first.left+t.first.width;if(r<this.cols&&s<this._paneRows){let o=e[s].text.split("");o[r]=ct.X,e[s].text=o.join("")}}this._addVIntersections(e,t.first,s,i),this._addVIntersections(e,t.second,s,i)}}_addHIntersections(e,t,s,i){if(!t.isLeaf()){if(t.type===y.HSPLIT){let r=t.first.top+t.first.height;if(r<this._paneRows&&s<this.cols){let o=e[r].text.split("");o[s]=ct.X,e[r].text=o.join("")}}this._addHIntersections(e,t.first,s,i),this._addHIntersections(e,t.second,s,i)}}_setBorderRuns(e,t,s,i,r){let o=[];for(let n of e.runs)for(let c=0;c<n.n;c++)o.push({fg:n.fg,bg:n.bg,b:n.b});for(;o.length<this.cols;)o.push({fg:"e0e2ea",bg:"14161b"});for(let n=t;n<t+s&&n<this.cols;n++)o[n]={fg:i,bg:r};e.runs=this._compactRuns(o)}_renderStatusBar(e,t){let s=this.activeSession;if(!s)return;let i=this.rows-1,r=this.cols,o=s.name+" ",n="| ",c=[];for(let R=0;R<s.windows.length;R++){let A=s.windows[R],D=R===s.activeWindowIndex?"*":"-",V=R===s.activeWindowIndex&&A._zoomed?"Z":"";c.push({text:`${R}:${A.name}${D}${V}`,active:R===s.activeWindowIndex})}let h=c.map(R=>R.text).join(" "),l=new Date,a=l.toTimeString().slice(0,5)+" ",f=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],u=`| ${l.getDate()}-${f[l.getMonth()]}-${String(l.getFullYear()).slice(-2)}`,_=o+n+h,d=n+a+u,b=r-_.length-d.length,C;b>0?C=_+" ".repeat(b)+d:C=(_+d).slice(0,r),C=this._padStr(C,r),e[i].text=C;let v=[],N=0,M=(R,A,D,V)=>{for(let I=0;I<R&&N<r;I++,N++){let Y={fg:A,bg:D};V&&(Y.b=!0),v.push(Y)}};M(o.length,t.statusActiveFg,t.statusBg,!0),M(n.length,t.statusSepFg,t.statusBg,!0);for(let R=0;R<c.length;R++){let A=c[R];A.active?M(A.text.length,t.statusActiveFg,t.statusActiveBg,!0):M(A.text.length,t.statusInactiveFg,t.statusBg,!1),R<c.length-1&&M(1,t.statusFg,t.statusBg,!1)}let k=_.length+Math.max(0,b);for(;N<k&&N<r;)v.push({fg:t.statusFg,bg:t.statusBg}),N++;for(M(n.length,t.statusSepFg,t.statusBg,!1),M(a.length,t.statusClockFg,t.statusBg,!1),M(u.length,t.statusSepFg,t.statusBg,!1);N<r;)v.push({fg:t.statusFg,bg:t.statusBg}),N++;e[i].runs=this._compactRuns(v)}_setStatusText(e,t,s,i){let r=this.rows-1;e[r].text=this._padStr(t,this.cols),e[r].runs=[{n:this.cols,fg:s,bg:i}]}_renderCopyOverlay(e,t){let s=this.activeWindow;if(!s)return;let i=s.name;s.name="[tmux]",this._renderStatusBar(e,t),s.name=i}_renderWindowList(e,t){let s=this.activeSession;if(!s)return;let i=s.windows.map((h,l)=>`${l===this._windowListCursor?">":" "} ${l}: ${h.name} [${h.getPanes().length} panes]${l===s.activeWindowIndex?" (active)":""}`),r="\u2500\u2500 Choose Window \u2500\u2500",o=Math.min(this.cols-4,Math.max(r.length,...i.map(h=>h.length))+4),n=Math.floor((this.cols-o)/2),c=Math.max(0,Math.floor((this._paneRows-i.length-2)/2));if(c<this._paneRows){let h=(" "+r+" ").padEnd(o);this._overlayText(e,c,n,h,t.statusFg,t.statusBg,o)}for(let h=0;h<i.length;h++){let l=c+1+h;if(l>=this._paneRows)break;let a=i[h].padEnd(o),f=h===this._windowListCursor;this._overlayText(e,l,n,a,f?t.statusActiveFg:t.statusFg,f?t.statusActiveBg:t.statusBg,o)}}_renderPaneNumbers(e,t){let s=this.activeWindow;if(!s)return;let i=s.getPanes();for(let r=0;r<i.length;r++){let o=i[r],n=String(r),c=o.top+Math.floor(o.height/2),h=o.left+Math.floor(o.width/2)-Math.floor(n.length/2);if(c<this._paneRows){let l=o===s.activePane;this._overlayText(e,c,h,n,l?"00ff00":"ff0000",t.bg,n.length)}}}_renderClock(e,t){let i=new Date().toTimeString().slice(0,8),r={0:["\u250C\u2500\u2510","\u2502 \u2502","\u2502 \u2502","\u2502 \u2502","\u2514\u2500\u2518"],1:["  \u2502","  \u2502","  \u2502","  \u2502","  \u2502"],2:["\u250C\u2500\u2510","  \u2502","\u250C\u2500\u2518","\u2502  ","\u2514\u2500\u2518"],3:["\u250C\u2500\u2510","  \u2502","\u251C\u2500\u2524","  \u2502","\u2514\u2500\u2518"],4:["\u2502 \u2502","\u2502 \u2502","\u2514\u2500\u2524","  \u2502","  \u2502"],5:["\u250C\u2500\u2510","\u2502  ","\u2514\u2500\u2510","  \u2502","\u2514\u2500\u2518"],6:["\u250C\u2500\u2510","\u2502  ","\u251C\u2500\u2510","\u2502 \u2502","\u2514\u2500\u2518"],7:["\u250C\u2500\u2510","  \u2502","  \u2502","  \u2502","  \u2502"],8:["\u250C\u2500\u2510","\u2502 \u2502","\u251C\u2500\u2524","\u2502 \u2502","\u2514\u2500\u2518"],9:["\u250C\u2500\u2510","\u2502 \u2502","\u2514\u2500\u2524","  \u2502","\u2514\u2500\u2518"],":":[" "," ","\xB7"," ","\xB7"]},o=["","","","",""];for(let l of i){let a=r[l]||r[0];for(let f=0;f<5;f++)o[f]+=a[f]+" "}let n=o[0].length,c=Math.floor((this._paneRows-5)/2),h=Math.floor((this.cols-n)/2);for(let l=0;l<5;l++){let a=c+l;a>=0&&a<this._paneRows&&this._overlayText(e,a,h,o[l],t.clockFg,t.bg,n)}}_renderHelpOverlay(e,t){let s=["tmux key bindings (prefix: Ctrl-b)","\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500","  %     Split pane vertically",'  "     Split pane horizontally',"  h/j/k/l Navigate panes (\u2190\u2193\u2191\u2192)","  \u2190\u2191\u2193\u2192  Navigate panes","  o     Next pane","  ;     Last pane","  z     Zoom/unzoom pane","  x     Close pane (confirm)","  {     Swap pane up","  }     Swap pane down","  !     Break pane to new window","  q     Display pane numbers","  c     Create new window","  n     Next window","  p     Previous window","  0-9   Switch to window N","  ,     Rename window","  &     Close window","  w     Window list (chooser)","  Space Cycle layout","  d     Detach","  [     Copy mode","  t     Clock","  :     Command prompt","  ?     This help","","  Press q to exit help"],i=Math.min(this.cols-2,40),r=Math.floor((this.cols-i)/2),o=Math.min(this._paneRows,s.length-this._helpScroll);for(let n=0;n<o;n++){let c=n,h=this._helpScroll+n;if(h>=s.length||c>=this._paneRows)break;let l=s[h].padEnd(i).slice(0,i);this._overlayText(e,c,r,l,t.fg,"1e1e2e",i)}}_overlayText(e,t,s,i,r,o,n){if(t<0||t>=e.length)return;let c=e[t],h=c.text.split("");for(let l=0;l<n&&l<i.length;l++){let a=s+l;a>=0&&a<this.cols&&(h[a]=i[l])}c.text=h.join(""),this._setBorderRuns(c,s,n,r,o)}_padStr(e,t){return e.length>=t?e.slice(0,t):e+" ".repeat(t-e.length)}_buildFrame(e,t){return{rows:this.rows,cols:this.cols,cursor:t,defaultFg:"e0e2ea",defaultBg:"14161b",lines:e}}};var ut=class x{constructor({rows:e=20,cols:t=40,themeName:s="nvim_default",persist:i=!0,onUpdate:r=null}={}){this.rows=e,this.cols=t,this.mode="shell",this.fs=new ot({persist:i}),this.shell=new rt({fs:this.fs,rows:e,cols:t,onLaunchVim:o=>this._launchVim(o),onLaunchTmux:o=>this._launchTmux(o)}),this.engine=null,this.screen=new ht(e,t,s),this._themeName=s,this._tmux=null,this._vimFilename=null,this._savedChangeCount=0,this._shellMsgLines=[],this.onUpdate=r,this._engineCommandHook=null}getMode(){return this.mode}feedKey(e){this.mode==="shell"?this.shell.feedKey(e):this.mode==="vim"?e==="Tab"&&this._vimCmdTabComplete()||((e==="Escape"||e==="Enter")&&(this._tabCycleState=null),this.engine.feedKey(e),this._checkVimCommand()):this.mode==="shell_msg"?e==="Enter"||e==="Escape"?this.mode="vim":e===":"&&(this.mode="vim",this.engine.feedKey(":")):this.mode==="tmux"&&(this._tmux.feedKey(e),this._tmux.detached&&(this.mode="shell",this.shell._appendOutput("[detached (from session "+this._tmux.activeSession?.name+")]"))),this.onUpdate&&this.onUpdate(this.renderFrame())}renderFrame(){if(this.mode==="shell")return this.shell.renderFrame(this.screen.theme);if(this.mode==="vim")return this.screen.render(this.engine);if(this.mode==="shell_msg")return this._renderShellMsg();if(this.mode==="tmux")return this._tmux.renderFrame()}getModeLabel(){if(this.mode==="shell"||this.mode==="shell_msg")return"SHELL";if(this.mode==="tmux")return"TMUX";if(this.mode==="vim"&&this.engine){let e=this.engine.mode;return{normal:"NORMAL",insert:"INSERT",visual:"VISUAL",visual_line:"VISUAL LINE",replace:"REPLACE",command:"COMMAND"}[e]||e.toUpperCase()}return"SHELL"}_launchTmux(e){if(this._tmux&&e.length>0&&(e[0]==="attach"||e[0]==="a")){this._tmux.detached=!1,this.mode="tmux";return}if(e.length>0&&(e[0]==="ls"||e[0]==="list-sessions")){if(this._tmux){let t=this._tmux.sessions.map((s,i)=>`${s.name}: ${s.windows.length} windows${i===this._tmux._activeSessionIndex?" (attached)":""}`);for(let s of t)this.shell._appendOutput(s)}else this.shell._appendOutput("no server running on /tmp/tmux-1000/default");return}if(this._tmux)this._tmux.detached=!1;else{let t=this.fs,s=this._themeName;this._tmux=new at({rows:this.rows,cols:this.cols,createPaneSession:(i,r)=>{let o=new x({rows:r,cols:i,themeName:s,persist:!1});return o.fs=t,o.shell.fs=t,o.shell._insideTmux=!0,o}})}this.mode="tmux"}_launchVim(e){if(this._vimFilename=e,this.engine=new it({rows:this.rows,cols:this.cols}),this.engine.filename=e,e&&this.fs.exists(e)){let t=this.fs.read(e);this.engine.loadFile(t)}else this.engine.loadFile("");this._savedChangeCount=this.engine._changeCount,this._updateVimStatus(),this.mode="vim"}_vimCmdTabComplete(){if(this.engine.mode!=="command"||this.engine.commandLine[0]!==":")return!1;let t=this.engine._searchInput.match(/^(e(?:d(?:it?)?)?|r(?:e(?:ad?)?)?|w(?:r(?:i(?:te?)?)?)?|sav(?:e(?:as?)?)?)(\s+(.*))?$/);if(!t)return!1;let s=t[1],i=t[3]||"",r=this._tabCycleState;if(r&&r.exCmd===s&&r.matches.includes(i)){r.index=(r.index+1)%r.matches.length;let h=r.matches[r.index];return this.engine._searchInput=s+" "+h,this.engine.commandLine=":"+s+" "+h,!0}let o=this.fs.ls().sort(),n=i?o.filter(h=>h.startsWith(i)):o;if(n.length===0)return this._tabCycleState=null,!0;this._tabCycleState={exCmd:s,matches:n,index:0};let c=n[0];return this.engine._searchInput=s+" "+c,this.engine.commandLine=":"+s+" "+c,!0}_checkVimCommand(){if(!this.engine)return;let e=this.engine._lastExCommand;e&&(this.engine._lastExCommand=null,this._handleExCommand(e))}_handleExCommand(e){let t=e.trim();if(/^w(r(i(te?)?)?)?(\s|$)/.test(t)){let i=t.split(/\s+/)[1]||this._vimFilename;if(i){this._saveFile(i),this._vimFilename||(this._vimFilename=i),this._updateVimStatus();let r=this.engine.buffer.lineCount,o=this.engine.buffer.lines.join(`
`).length+1,n=`"${i}" ${r}L, ${o}B written`;n.length>this.cols&&(n="<"+n.slice(n.length-this.cols+1)),this.engine.commandLine=n}else this.engine.commandLine="E32: No file name";return}if(/^(wq|x(it?)?)(\s|$)/.test(t)){let s=t.split(/\s+/),i=t.startsWith("x"),r=s[1]||this._vimFilename;if(!r){this.engine.commandLine="E32: No file name",this.engine._stickyCommandLine=!0;return}(!i||this._isDirty())&&this._saveFile(r),this._exitVim();return}if(/^q(u(it?)?)?$/.test(t)){if(this._isDirty()){let i=`E37: No write since last change
E162: No write since last change for buffer "${this._vimFilename||"[No Name]"}"`;this.engine._messagePrompt={error:i},this.engine.commandLine=""}else this._exitVim();return}if(/^q(u(it?)?)?!$/.test(t)){this._exitVim();return}if(/^e(d(it?)?)?!(\s|$)/.test(t)){let i=t.split(/\s+/)[1]||this._vimFilename;i&&(this._vimFilename=i,this.engine.filename=i,this.fs.exists(i)?this.engine.loadFile(this.fs.read(i)):this.engine.loadFile(""),this._savedChangeCount=this.engine._changeCount,this._updateVimStatus());return}if(/^e(d(it?)?)?(\s|$)/.test(t)){let s=t.split(/\s+/),i=s[1]||this._vimFilename;i?(s[1]&&!this._vimFilename?this._vimFilename=i:s[1]&&(this._vimFilename=i),this.engine.filename=i,this.fs.exists(i)?this.engine.loadFile(this.fs.read(i)):this.engine.loadFile(""),this._savedChangeCount=this.engine._changeCount,this._updateVimStatus()):(this.engine.commandLine="E32: No file name",this.engine._stickyCommandLine=!0);return}if(/^r(e(ad?)?)?!/.test(t)){let s=t.replace(/^r(e(ad?)?)?!\s*/,"").trim(),i=this._execShellForOutput(s);if(i.length>0){this.engine._saveSnapshot(),this.engine._redoStack=[];let r=this.engine.cursor.row;this.engine.buffer.lines.splice(r+1,0,...i),this.engine.cursor.row=r+1,this.engine.cursor.col=0,this.engine._updateDesiredCol();let o=i.length;this.engine.commandLine=`${o} line${o!==1?"s":""} added`,this.engine._stickyCommandLine=!0}return}if(/^r(e(ad?)?)?(\s|$)/.test(t)){let i=t.split(/\s+/)[1];if(i){let r=this.fs.read(i);if(r===null)this.engine.commandLine=`E484: Can't open file ${i}`,this.engine._stickyCommandLine=!0;else{this.engine._saveSnapshot(),this.engine._redoStack=[];let o=r.split(`
`);o.length>1&&o[o.length-1]===""&&o.pop();let n=this.engine.cursor.row;this.engine.buffer.lines.splice(n+1,0,...o),this.engine.cursor.row=n+1,this.engine.cursor.col=0,this.engine._updateDesiredCol();let c=o.length;this.engine.commandLine=`${c} line${c!==1?"s":""} added`,this.engine._stickyCommandLine=!0,this.engine.filename||(this._vimFilename=i,this.engine.filename=i)}}else this.engine.commandLine="E32: No file name",this.engine._stickyCommandLine=!0;return}if(t.startsWith("!")){let s=t.slice(1).trim();this._runShellCommand(s);return}if(/^sav(e(as?)?)?(\ |$)/.test(t)){let i=t.split(/\s+/)[1];if(i){this._saveFile(i),this._vimFilename=i,this.engine.filename=i,this._updateVimStatus();let r=this.engine.buffer.lineCount,o=this.engine.buffer.lines.join(`
`).length+1,n=`"${i}" ${r}L, ${o}B written`;n.length>this.cols&&(n="<"+n.slice(n.length-this.cols+1)),this.engine.commandLine=n}else this.engine.commandLine="E32: No file name",this.engine._stickyCommandLine=!0;return}if(/^\d+$/.test(t)){let s=parseInt(t,10),i=this.engine.buffer.lineCount-1;this.engine.cursor.row=Math.max(0,Math.min(s-1,i)),this.engine.cursor.col=0,this.engine._updateDesiredCol(),this.engine._ensureCursorVisible();return}}_saveFile(e){let t=this.engine.buffer.lines.join(`
`);this.fs.write(e,t),this._savedChangeCount=this.engine._changeCount}_isDirty(){return this.engine?this.engine._changeCount!==this._savedChangeCount:!1}_exitVim(){this.mode="shell",this.engine=null,this._vimFilename=null,this._savedChangeCount=0}_updateVimStatus(){}_execShellForOutput(e){let t=[],s=this._tokenize(e);if(s.length===0)return t;let i=s[0],r=s.slice(1);switch(i){case"ls":{let o=this.fs.ls();o.length>0&&t.push(o.join("  "));break}case"cat":{for(let o of r){let n=this.fs.read(o);n===null?t.push(`cat: ${o}: No such file or directory`):t.push(...n.split(`
`))}break}case"echo":t.push(r.join(" "));break;case"date":{let o=new Date,n=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],c=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],h=o.toString().match(/\(([^)]+)\)/),l="";h&&(l=h[1].includes(" ")?h[1].split(" ").map(a=>a[0]).join(""):h[1]),t.push(`${n[o.getDay()]} ${c[o.getMonth()]} ${String(o.getDate()).padStart(2," ")} ${o.toTimeString().split(" ")[0]} ${l} ${o.getFullYear()}`);break}case"rm":{for(let o of r)this.fs.rm(o)||t.push(`rm: cannot remove '${o}': No such file or directory`);break}case"touch":{for(let o of r)this.fs.exists(o)||this.fs.write(o,"");break}case"cp":{if(r.length<2)t.push("cp: missing file operand");else{let o=this.fs.read(r[0]);o===null?t.push(`cp: cannot stat '${r[0]}': No such file or directory`):this.fs.write(r[1],o)}break}case"mv":{if(r.length<2)t.push("mv: missing file operand");else{let o=this.fs.read(r[0]);o===null?t.push(`mv: cannot stat '${r[0]}': No such file or directory`):(this.fs.write(r[1],o),this.fs.rm(r[0]))}break}case"wc":{let o=[],n=[];for(let c of r)if(c.startsWith("-")&&c.length>1)for(let h of c.slice(1))o.push(h);else n.push(c);if(n.length===0)t.push("wc: missing file operand");else{let c=o.length===0,h=c||o.includes("l"),l=c||o.includes("w"),a=c||o.includes("c");for(let f of n){let u=this.fs.read(f);if(u===null)t.push(`wc: ${f}: No such file or directory`);else{let _=u===""?0:u.split(`
`).length,d=u===""?0:u.split(/\s+/).filter(v=>v).length,b=u.length,C=[];h&&C.push(String(_).padStart(8)),l&&C.push(String(d).padStart(8)),a&&C.push(String(b).padStart(8)),C.push(` ${f}`),t.push(C.join(""))}}}break}case"grep":{let o=!1,n=!1,c=!1,h=[];for(let l of r)if(l.startsWith("-")&&l.length>1)for(let a of l.slice(1))a==="i"?o=!0:a==="n"?n=!0:a==="c"&&(c=!0);else h.push(l);if(h.length<2)t.push("Usage: grep [options] pattern file");else{let l;try{l=new RegExp(h[0],o?"i":"")}catch{t.push(`grep: invalid regex: ${h[0]}`);break}let a=h.slice(1);for(let f of a){let u=this.fs.read(f);if(u===null)t.push(`grep: ${f}: No such file or directory`);else{let _=u.split(`
`),d=0,b=a.length>1?`${f}:`:"";for(let C=0;C<_.length;C++)if(l.test(_[C])&&(d++,!c)){let v=n?`${C+1}:`:"";t.push(`${b}${v}${_[C]}`)}c&&t.push(`${b}${d}`)}}}break}case"history":{let o=this.shell._history;for(let n=0;n<o.length;n++)t.push(`${String(n+1).padStart(5)}  ${o[n]}`);break}case"sort":{if(r.length===0)t.push("sort: missing file operand");else{let o=!1,n=!1,c=!1,h=[];for(let l of r)if(l.startsWith("-"))for(let a of l.slice(1))a==="r"?o=!0:a==="n"?n=!0:a==="u"&&(c=!0);else h.push(l);for(let l of h){let a=this.fs.read(l);if(a===null)t.push(`sort: cannot read: ${l}: No such file or directory`);else{let f=a.split(`
`);f.length>0&&f[f.length-1]===""&&f.pop(),n?f.sort((u,_)=>(parseFloat(u)||0)-(parseFloat(_)||0)):f.sort(),o&&f.reverse(),c&&(f=[...new Set(f)]),t.push(...f)}}}break}default:t.push(`zsh: command not found: ${i}`);break}return t}_runShellCommand(e){let t=this._execShellForOutput(e);this._shellMsgLines=t,this.mode="shell_msg"}_renderShellMsg(){let e=this.screen.theme,t=[],s=this.rows,i=[...this._shellMsgLines];i.push(""),i.push("Press ENTER or type command to continue");for(let r=0;r<s;r++)if(r<i.length){let o=this._pad(i[r]),n=i[r].startsWith("Press ENTER");t.push({text:o,runs:[{n:this.cols,fg:n?e.promptFg||"8cf8f7":e.normalFg||"e0e2ea",bg:e.normalBg||"14161b"}]})}else t.push({text:" ".repeat(this.cols),runs:[{n:this.cols,fg:e.normalFg||"e0e2ea",bg:e.normalBg||"14161b"}]});return{rows:this.rows,cols:this.cols,cursor:{row:Math.min(i.length-1,this.rows-1),col:this.cols-1,visible:!0},defaultFg:e.normalFg||"e0e2ea",defaultBg:e.normalBg||"14161b",lines:t}}_pad(e){return e.length>=this.cols?e.slice(0,this.cols):e+" ".repeat(this.cols-e.length)}_tokenize(e){let t=[],s="",i=!1,r=!1;for(let o=0;o<e.length;o++){let n=e[o];n==="'"&&!r?i=!i:n==='"'&&!i?r=!r:n===" "&&!i&&!r?s&&(t.push(s),s=""):s+=n}return s&&t.push(s),t}};var ft=class{constructor(e,t=()=>{}){this.session=e,this.onUpdate=t,this._boundKeyDown=this._onKeyDown.bind(this)}attach(e){e.addEventListener("keydown",this._boundKeyDown)}detach(e){e.removeEventListener("keydown",this._boundKeyDown)}handleKey(e){this.session.feedKey(e),this.onUpdate(this.session.renderFrame())}feedKeys(e){for(let t of e){let s=t;t==="\x1B"?s="Escape":t==="\r"||t===`
`?s="Enter":(t==="\b"||t==="\x7F")&&(s="Backspace"),this.session.feedKey(s)}this.onUpdate(this.session.renderFrame())}_onKeyDown(e){let t=this._translateKey(e);t&&((["Escape","Backspace","Enter","Tab","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)||e.key.length===1&&!e.altKey&&!e.metaKey||e.ctrlKey&&/^[a-z]$/i.test(e.key))&&e.preventDefault(),this.session.feedKey(t),this.onUpdate(this.session.renderFrame()))}_translateKey(e){if(["Shift","Control","Alt","Meta"].includes(e.key))return null;if(e.ctrlKey&&!e.altKey&&!e.metaKey&&/^[a-z]$/i.test(e.key))return"Ctrl-"+e.key.toUpperCase();if(e.ctrlKey&&!e.altKey&&!e.metaKey&&e.key.startsWith("Arrow"))return"Ctrl-"+e.key.slice(5);let t={Escape:"Escape",Enter:"Enter",Backspace:"Backspace",ArrowUp:"ArrowUp",ArrowDown:"ArrowDown",ArrowLeft:"ArrowLeft",ArrowRight:"ArrowRight",Tab:"Tab"};return t[e.key]?t[e.key]:e.key.length===1&&!e.ctrlKey&&!e.altKey&&!e.metaKey?e.key:null}};var _t="'Cascadia Mono', Consolas, 'Courier New', monospace",dt=class{constructor(e,{fontSize:t=18}={}){this.canvas=e,this.ctx=e.getContext("2d"),this.fontSize=t,this.ctx.font=`${t}px ${_t}`;let s=this.ctx.measureText("M");this.charW=Math.ceil(s.width),this.charH=Math.ceil(t*1.4),this.padding=6}draw(e){let{rows:t,cols:s,lines:i,cursor:r}=e,o=this.charW,n=this.charH,c=this.padding,h=c*2+s*o,l=c*2+t*n;(this.canvas.width!==h||this.canvas.height!==l)&&(this.canvas.width=h,this.canvas.height=l);let a=this.ctx;a.font=`${this.fontSize}px ${_t}`,a.textBaseline="top",a.fillStyle="#"+(e.defaultBg||"000000"),a.fillRect(0,0,h,l);for(let f=0;f<i.length;f++){let u=i[f],_=u.text,d=u.runs||[],b=c+f*n,C=0;for(let v of d){let N=c+C*o,M=v.n*o,k="#"+(v.bg||"000000");k!=="#000000"&&(a.fillStyle=k,a.fillRect(N,b,M,n)),a.fillStyle="#"+(v.fg||"d4d4d4"),v.b&&(a.font=`bold ${this.fontSize}px ${_t}`);for(let R=0;R<v.n&&C+R<_.length;R++){let A=_[C+R];A!==" "&&a.fillText(A,N+R*o,b+2)}v.b&&(a.font=`${this.fontSize}px ${_t}`),C+=v.n}}if(r&&r.visible){let f=c+r.col*o,u=c+r.row*n;if(r.shape==="beam")a.fillStyle="#cccccc",a.fillRect(f,u,2,n);else if(a.fillStyle="#800000",a.fillRect(f,u,o,n),r.row<i.length){let _=i[r.row].text[r.col]||" ";a.fillStyle="#ffffff",a.fillText(_,f,u+2)}}}};var pt={filename:"demo.py",content:`#!/usr/bin/env python3
"""VimFu demo: Python syntax showcase."""

import os
import sys
from pathlib import Path
from typing import List, Optional

# Constants
MAX_SIZE = 100
PI = 3.14159
HEX = 0xFF
BIN = 0b1010
OCTAL = 0o777
GREETING = "Hello, VimFu!"
RAW = r"no\\escapes\\here"
FSTR = f"pi is {PI:.2f}"
MULTI = """triple
quoted string"""
EMPTY = None
IS_OK = True
NOPE = False

@property
def greet(name: str) -> str:
    """Return a greeting."""
    return f"Hello, {name}!"

class Animal:
    """Base class for animals."""
    count: int = 0

    def __init__(self, name: str):
        self.name = name
        self._age = 0
        Animal.count += 1

    @staticmethod
    def kingdom() -> str:
        return "Animalia"

    @classmethod
    def from_dict(cls, d: dict):
        return cls(d["name"])

class Dog(Animal):
    """A dog is a good boy."""

    def __init__(self, name: str):
        super().__init__(name)
        self.tricks: List[str] = []

    def learn(self, trick: str):
        if trick not in self.tricks:
            self.tricks.append(trick)

def fibonacci(n: int):
    """Yield Fibonacci numbers."""
    a, b = 0, 1
    while a < n:
        yield a
        a, b = b, a + b

# Lambda and map
square = lambda x: x ** 2
nums = list(range(10))
evens = [x for x in nums
         if x % 2 == 0]

# Exception handling
def divide(a, b):
    try:
        return a / b
    except ZeroDivisionError as e:
        print(f"Error: {e}")
        return None
    except (TypeError, ValueError):
        raise
    finally:
        pass

# Async syntax
async def fetch(url: str):
    async with session.get(url) as r:
        return await r.text()

# Walrus + match
def check(data):
    if (n := len(data)) > 10:
        print(f"Large: {n}")
    match data:
        case []:
            pass
        case [x, *rest]:
            print(x, rest)
        case _:
            pass

# Global / nonlocal
counter = 0
def increment():
    global counter
    counter += 1

# Type hints
Vector = List[float]
def dot(a: Vector, b: Vector):
    assert len(a) == len(b)
    return sum(x*y for x, y in
               zip(a, b))

# Ternary + chained comparison
x = 42
label = "big" if x > 100 else "sm"
in_range = 0 < x < 100

# Unpacking
first, *mid, last = range(5)
a, b = b, a  # swap

# Delete
temp = [1, 2, 3]
del temp[0]

# Entry point
if __name__ == "__main__":
    dog = Dog("Rex")
    dog.learn("sit")
    dog.learn("shake")
    print(dog)
    for n in fibonacci(50):
        if n > 20:
            break
        print(n, end=" ")
    print()
    result = divide(10, 3)
    print(f"Result: {result}")
    # TODO: Add more features
    sys.exit(0)
`};var Bt=20,Dt=80,Wt=18,z=new ut({rows:Bt,cols:Dt,themeName:"monokai",persist:!0});z.fs.fileCount===0&&(z.fs.write("hello.txt",["Welcome to VimFu!","","Type :q to return to the shell.","Type :w to save this file.","","Try editing this text."].join(`
`)),z.fs.write("notes.txt",["Shopping list:","  - milk","  - eggs","  - bread"].join(`
`)));z.fs.exists(pt.filename)||z.fs.write(pt.filename,pt.content);var gt=document.getElementById("terminal"),Ut=new dt(gt,{fontSize:Wt}),Pt=document.getElementById("mode-badge"),Vt={SHELL:"shell",NORMAL:"normal",INSERT:"insert",VISUAL:"visual","VISUAL LINE":"visual_line",REPLACE:"replace",COMMAND:"command"};function Mt(x){Ut.draw(x);let e=z.getModeLabel();Pt.textContent=e,Pt.className="mode-badge "+(Vt[e]||"shell")}var $t=new ft(z,Mt);$t.attach(gt);Mt(z.renderFrame());gt.classList.add("ready");document.getElementById("loading").classList.add("hidden");gt.focus();
</script>

</body>
</html>
